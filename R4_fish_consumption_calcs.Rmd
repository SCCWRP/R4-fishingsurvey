---
title: "R4 Fish Consumption Calculations"
author: "Tori McGruer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## Install libraries
```{r message=TRUE}
library(tidyverse)
library(readxl)
library(ggplot2)
library(patchwork)
library(ggpubr)
library(ggbreak)
library(viridis)
library(hrbrthemes)
```
## Import data
```{r ,include=FALSE}

##Save Fisher_Survey_Database_2024.xlsm in working directory, then import
wd <- getwd()
path <- file.path(wd, "Fisher_Survey_Database_2024.xlsm") 

excel_sheets(path)

fisherdb_import <-read_excel(path, sheet = "Interviews")

colnames<-colnames(fisherdb_import)
colnames

#Replace spaces with underscores in column names
names(fisherdb_import) <- gsub(" ", "_", names(fisherdb_import))
names(fisherdb_import)

#Convert to numeric / factor

fisherdb <- fisherdb_import

# List of columns to convert
columns_to_convert <- c(
  "Past_catches:_Rainbow_Trout,_times_eaten_numeric",
  "Past_catches:_Catfish,_times_eaten_numeric", 
  "Past_catches:_Bluegill,_times_eaten_numeric",
  "Past_catches:_Common_Carp,_times_eaten_numeric",
  "Past_catches:_Bass,_times_eaten_numeric",
  "Past_catches:_Crappie,_times_eaten_numeric",
  "Past_catches:_Tilapia,_times_eaten_numeric",
  "Past_catches:_other,_times_eaten_numeric",
  
  "Past_catches:_Rainbow_Trout,_servings_eaten_numeric",
  "Past_catches:_Catfish,_servings_eaten_numeric",
  "Past_catches:_Blue_gill,_servings_eaten_numeric",
  "Past_catches:_Common_Carp,_servings_eaten_numeric",
  "Past_catches:_Bass,_servings_eaten_numeric",
  "Past_catches:_Crappie,_servings_eaten_numeric",
  "Past_catches:_Tilapia,_servings_eaten_numeric",
  "Past_catches:_other,_servings_eaten_numeric",
  
  "Servings_eaten_(Person_1)_numeric",
  "Servings_eaten_(Person_2)_numeric",
  "Servings_eaten_(Person_3)_numeric",
  "Servings_eaten_(Person_4)_numeric",
  
  "Times_eaten_last_4_weeks__(Person_1)_numeric",
  "Times_eaten_last_4_weeks__(Person_2)_numeric",
  "Times_eaten_last_4_weeks__(Person_3)_numeric",
  "Times_eaten_last_4_weeks__(Person_4)_numeric"
)

# Convert columns to numeric, checks for data loss, and summarize
for (col in columns_to_convert) {
  # Create new numeric column
  numeric_col <- paste0(col)
  fisherdb[[numeric_col]] <- as.numeric(fisherdb_import[[col]])
  
  # Summary of original column as factor
  cat("Summary of", col, "as factor:\n")
  print(summary(as.factor(fisherdb_import[[col]])))
  
  # Summary of converted column
  cat("Summary of", numeric_col, ":\n")
  print(summary(fisherdb[[numeric_col]]))
  
}
###"unknowns" converted to "NA" in numerical conversion
###"not surveyed" converted to "NA" in numerical conversion
###"no answer" converted to "NA" in numerical conversion
##Convert age to numeric. Handle ranges by taking the average of the range.

# List of columns to convert
age_columns <- c("Age_(Person_1)", "Age_(Person_2)", "Age_(Person_3)", "Age_(Person_4)", "Age")

# Function to convert a value to numeric, calculating midpoint if it's a range
convert_to_midpoint <- function(x) {
  if (grepl("-", x)) {
    # Split the range, calculate the midpoint, and convert to numeric
    range_vals <- as.numeric(strsplit(x, "-")[[1]])
    return(mean(range_vals, na.rm = TRUE))
  } else {
    # Convert to numeric directly if it's a single value
    return(as.numeric(x))
  }
}

# Apply the conversion to each specified column
fisherdb <- fisherdb %>%
  mutate(across(
    all_of(age_columns),
    ~ sapply(.x, convert_to_midpoint),
    .names = "{.col}_numeric"))

##Checks function performance

age_check <- fisherdb %>% select (`Age_(Person_1)`, `Age_(Person_1)_numeric`,
                                  `Age_(Person_2)`, `Age_(Person_2)_numeric`,
                                  `Age_(Person_3)`, `Age_(Person_3)_numeric`,
                                  `Age_(Person_4)`, `Age_(Person_4)_numeric`,
                                  Age, Age_numeric)
 
### Convert gender to factor
fisherdb <- fisherdb %>%
   mutate(across(c( 
     Observed_Gender,
     `Gender_(Person_1)`,
     `Gender_(Person_2)`,
     `Gender_(Person_3)`,
     `Gender_(Person_4)`
 ),as.factor))

###Checks gender conversion
summary(fisherdb$Observed_Gender)
summary(fisherdb$`Gender_(Person_1)`)
summary(fisherdb$`Gender_(Person_2)`)
summary(fisherdb$`Gender_(Person_3)`)
summary(fisherdb$`Gender_(Person_4)`)

rm(age_check)


```


#Identify unique lake names used in database
```{r ,include=FALSE}
#using unlist and strsplit1
lake_names <- unlist(strsplit(c(fisherdb$Likely_Fishing_Location_1, 
                fisherdb$Likely_Fishing_Location_2, 
                fisherdb$Likely_Fishing_Location_3,
                fisherdb$`Past_catches:_Rainbow_Trout,_Where`,
                fisherdb$`Past_catches:_Catfish,_where`,
                fisherdb$`Past_catches:_Bluegill,_where`,
                fisherdb$`Past_catches:_Common_Carp,_where`,
                fisherdb$`Past_catches:__Bass,_where`,
                fisherdb$`Past_catches:_Crappie,_where`,
                fisherdb$`Past_catches:_Tilapia,_where`,
                fisherdb$`Past_catches:_other,_where`),","))

lake_names <-trimws(lake_names)
unique_lake_names <- unique(trimws(lake_names))
write.csv(unique_lake_names,"unique_lake_names.csv", row.names = FALSE)

##Names and counties were added to "unique_lake_names.csv" -- now import this dataset

unique_lake_names_key <- read.csv("unique_lake_names_key.csv",strip.white = TRUE)

##Join lakes & key to identify if any missed

df_unique_lake_names <- as.data.frame(unique_lake_names)
unique_lake_names_key <- unique_lake_names_key %>%
  mutate(
    original_name = iconv(original_name, from = "latin1", to = "UTF-8", sub = "")  # Re-encode to UTF-8
  ) %>%
  mutate(
    original_name = trimws(original_name)  # Apply trimws after re-encoding
  )
anti_join_lakes <- anti_join(df_unique_lake_names, unique_lake_names_key, by=c("unique_lake_names" = "original_name"))
#write.csv(anti_join_lakes, "anti_join_lakes.csv", row.names = FALSE)
```


#Fisher characteristics
```{r, include= FALSE}
##Subsets columns related to fisher demographics. Looks at gender and race/ethnic distribution of all fishers, not solely consumers.

fisher_charac <- fisherdb %>% 
  select(Location,Date,Observed_Gender,`Fishing_here:_Years`,`Fishing_here:_Months`, `Fishing_here:_Days`, Times_here_past_4_weeks,Age, Ethnicity,Employment,Annual_Household_Income, `Optional:_US_Native`)

#Gender counts
fisher_gender <- fisher_charac %>%
  group_by(Location, Observed_Gender) %>%
  summarise(count = n())%>%
  ungroup()%>%
  pivot_wider(names_from = Observed_Gender, values_from = count, values_fill = 0)


total_gender <- fisher_charac %>%
  group_by(Observed_Gender)%>%
  summarise(count = n())%>%
  ungroup()%>%
  pivot_wider(names_from = Observed_Gender, values_from = count, values_fill = 0)%>%
  mutate(Location = "All")

fisher_gender <- bind_rows(fisher_gender, total_gender)
rm(total_gender)

fisher_gender <- fisher_gender %>% 
  mutate(total_fishers = Female + Male + `Not recorded`,
         per_male = round(Male/total_fishers*100,0))

##Fisher ethncicity

lake_ethnicity <- fisher_charac %>%
  group_by(Location, Ethnicity) %>%
  summarise(count = n())%>%
  ungroup()%>%
  pivot_wider(names_from = Ethnicity, values_from = count, values_fill = 0)

total_ethnicity <- fisher_charac %>%
  group_by(Ethnicity)%>%
  summarise(count = n())%>%
  ungroup()%>%
  pivot_wider(names_from = Ethnicity, values_from = count, values_fill = 0)%>%
  mutate(Location = "All")

fisher_ethnicity <- bind_rows(lake_ethnicity, total_ethnicity)
rm(total_ethnicity)

fisher_ethnicity <- fisher_ethnicity %>% 
  mutate(Multiracial = `Multi: Asian or Pacific Islander, Hispanic or Latino` + `Multi: Asian or Pacific Islander, White`+`Multi: Hispanic or Latino, White`)%>%
  select(-`Multi: Asian or Pacific Islander, Hispanic or Latino`,-`Multi: Asian or Pacific Islander, White`, -`Multi: Hispanic or Latino, White`)

fisher_ethnicity <- fisher_ethnicity %>%
 mutate(total = rowSums(select(., -Location), na.rm = TRUE))%>%
  mutate(total_reported = total - Unknown - `Prefer not to say`)%>%
  mutate(across(
    -c(Location),  # Exclude the "Location" and "total" columns
    ~ round(. / total * 100, 0),    # Calculate the percentage
    .names = "percent_{.col}"  # Name the new columns with "percent_" prefix
  ))
  
# Write to CSV
write.csv(fisher_ethnicity, "fisher_ethnicity.csv", row.names = FALSE)

```
#Catch rates
```{r, include = FALSE}
#This code chunk calculates the frequency different species are caught at each lake
#Step 1: Convert to long format
caught_fish_long <- fisherdb %>%
  mutate(rowID = 1:nrow(.)) %>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = matches("Past_catches:.*,_where$") & !matches("_times_eaten,_where$"),
    names_to = "Catches_Info",
    values_to = "Lakes"
  ) %>%
  #Step 2: Separate the lake names into individual rows #Alondra 223, leg 520, MJ 61, peck 162, NA 2824
  #removing NA should be 4660-2824 = 1836
  separate_rows(Lakes, sep = ",") %>%
  mutate(Catches_Info = gsub("(Past_catches:_)|(,.*)", "", Catches_Info)) %>%
  mutate(Catches_Info = gsub("_", " ", Catches_Info)) %>%
  mutate(Lakes = trimws(Lakes))%>%
  filter(!is.na(Lakes)) %>%
  filter(Lakes != "NA") %>%
  mutate(Catches_Info = str_trim(Catches_Info)) %>%  # Remove leading/trailing whitespace
   # Step 3: Assign "reason" based on conditions
 mutate(
    reason = case_when(
      Catches_Info == "Rainbow Trout" ~ `Past_catches:_Rainbow_Trout,_if_not_eating_why`,
      Catches_Info == "Bluegill" ~ `Past_catches:_Bluegill,_if_not_eating_why`,
      Catches_Info == "Bass" ~ `Past_catches:_Bass,if_not_eating_why`,
      Catches_Info == "Catfish" ~ `Caught_Catfish,_if_not_eating_why`,
      Catches_Info == "Common Carp" ~ `Past_catches:_Common_Carp,_if_not_eating_why`,
      Catches_Info == "Crappie" ~ `Past_catches:_Crappie,_if_not_eating_why`,
      Catches_Info == "other" ~ `Past_catches:_other,_if_not_eating_why`,
      Catches_Info == "Tilapia" ~ `Past_catches:_Tilapia,_if_not_eating_why`,
      TRUE ~ NA_character_  # Default to NA for other rows
    ),
    # Convert "NA" string to actual NA in the reason column
    reason = na_if(reason, "NA")
  )%>%
mutate(
   reason = case_when(
      is.na(reason) & Catches_Info == "Rainbow Trout" ~ `Caught_Rainbow_Trout,_if_not_eating_why`,
      is.na(reason) & Catches_Info == "Bluegill" ~ `Caught_Bluegill,_if_not_eating_why`,
      is.na(reason) & Catches_Info == "Bass" ~ `Caught_Bass,_if_not_eating_why`,
      is.na(reason) & Catches_Info == "Catfish" ~ `Caught_Catfish,_if_not_eating_why`,
      is.na(reason) & Catches_Info == "Common Carp" ~ `Caught_Common_Carp,_if_not_eating_why`,
      is.na(reason) & Catches_Info == "Crappie" ~ `Caught_Crappie,_if_not_eating_why`,
      is.na(reason) & Catches_Info == "Tilapia" ~ `Caught_Tilapia,_if_not_eating_why`,
      is.na(reason) & Catches_Info == "other" ~ `Caught_Other,_if_not_eating_why`,
      TRUE ~ reason  # Keep existing reason value
    ),
   reason = na_if(reason, "NA")
)%>%
  mutate(Catches_Info = case_when(
    Catches_Info == "other" & !is.na(`Past_catches:_Other,_list_species`) & 
      `Past_catches:_Other,_list_species` != "NA" ~ `Past_catches:_Other,_list_species`,
    TRUE ~ Catches_Info
  ))%>%
  mutate(Catches_Info = case_when(
    Catches_Info == "Small mouth bass" ~ "Black bass",
    Catches_Info == "Bass" ~ "Black bass",
    TRUE ~ Catches_Info
  ))%>%
  select(rowID, Lakes, Catches_Info, reason)

summary(as.factor(caught_fish_long$Catches_Info))

Surveyed_lakes_caught_fish <-caught_fish_long %>%
  filter(Lakes == "Alondra park"| #223
         Lakes == "Magic Johnson Lakes"| #61
         Lakes == "Legg lake"| #520
         Lakes == "Peck Road") #162
length(unique(Surveyed_lakes_caught_fish$rowID)) # 352 unique fishers
summary(as.factor(Surveyed_lakes_caught_fish$Catches_Info))
length_surveyed_lakes <- nrow(Surveyed_lakes_caught_fish)

Alondra_caught_fish <- caught_fish_long %>%
  filter(Lakes == "Alondra park") #should have 223 values
length(unique(Alondra_caught_fish$rowID)) # 90 unique fishers
summary(as.factor(Alondra_caught_fish$Catches_Info))
length_Alondra <- nrow(Alondra_caught_fish)

MJ_caught_fish <- caught_fish_long %>%
  filter(Lakes == "Magic Johnson Lakes") #should have 61 values
length(unique(MJ_caught_fish$rowID)) # 29 unique fishers
summary(as.factor(MJ_caught_fish$Catches_Info))
length_MJ <- nrow(MJ_caught_fish)

Legg_caught_fish <- caught_fish_long %>%
  filter(Lakes == "Legg lake") #should have 520 values
length(unique(Legg_caught_fish$rowID)) # 219 unique fishers
summary(as.factor(Legg_caught_fish$Catches_Info))
length_Legg <- nrow(Legg_caught_fish)

Peck_caught_fish <- caught_fish_long %>%
  filter(Lakes == "Peck Road") #should have 162 values
length(unique(Peck_caught_fish$rowID)) # 83 unique fishers
summary(as.factor(Peck_caught_fish$Catches_Info))
length_Peck <- nrow(Peck_caught_fish)
 

lakes <- list(
  "All" = c("Alondra park", "Legg lake", "Peck Road", "Magic Johnson Lakes"),
  "Alondra park" = "Alondra park",
  "Legg lake" = "Legg lake",
  "Magic Johnson Lakes" = "Magic Johnson Lakes",
  "Peck Road" = "Peck Road"
)

#Loop to summarize what fishers are catching at each lake
# Initialize an empty list to store summary tables
summary_tables <- list()

# Loop through each lake in the lakes list
for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]  # Get the lake(s) for the current iteration
  
  # Filter and summarize data for the selected lake(s)
  lake_summary <- caught_fish_long %>%
    filter(Lakes %in% selected_lake) %>%  # Filter rows for the current lake(s)
    group_by(Catches_Info) %>%    # Group by Catches_Info and Lakes
    summarise(count = n(), .groups = "drop")  # Count occurrences
  
  # Add a column for the lake name
  lake_summary <- lake_summary %>%
    mutate(lake_name = lake_name)
  
  # Append the result to the list
  summary_tables[[lake_name]] <- lake_summary
}

# Combine all summary tables into a single dataframe
summary_caught_fish <- bind_rows(summary_tables)

##Calculate percent fish
summary_caught_fish <- summary_caught_fish %>%
  mutate(sum = case_when(
    lake_name == "All" ~ length_surveyed_lakes,
    lake_name == "Alondra park" ~ length_Alondra,
    lake_name == "Legg lake" ~ length_Legg,
    lake_name == "Magic Johnson Lakes" ~ length_MJ,
    lake_name == "Peck Road" ~ length_Peck
  ))%>%
  mutate(percent = round(count/sum*100,0)
  )

```

#Calculate consumption rate (Fishers)
```{r ,include=FALSE}
##Code to calculate the fish consumepiton rate of fishers
##Subset to only fish consumers (<4 weeks)
consumers <- fisherdb %>% filter(
                  `Past_catches:_Rainbow_Trout,_times_eaten_numeric` >0 |
                  `Past_catches:_Catfish,_times_eaten_numeric`>0 |
                  `Past_catches:_Bluegill,_times_eaten_numeric`>0|
                  `Past_catches:_Common_Carp,_times_eaten_numeric`>0 |
                  `Past_catches:_Bass,_times_eaten_numeric`>0 |
                  `Past_catches:_Crappie,_times_eaten_numeric`>0 |
                  `Past_catches:_Tilapia,_times_eaten_numeric`>0|
                  `Past_catches:_other,_times_eaten_numeric`>0
)

##verify consumer subset
RT_consumers <- fisherdb %>% filter(`Past_catches:_Rainbow_Trout,_times_eaten_numeric` >0)
nrow(RT_consumers)
cat_consumers <- fisherdb %>% filter(`Past_catches:_Catfish,_times_eaten_numeric`>0)
nrow(cat_consumers)
BG_consumers <- fisherdb %>% filter(`Past_catches:_Bluegill,_times_eaten_numeric`>0)
nrow(BG_consumers)
CC_consumers <- fisherdb %>% filter(`Past_catches:_Common_Carp,_times_eaten_numeric`>0)
nrow(CC_consumers)
Bass_consumers <- fisherdb %>% filter(`Past_catches:_Bass,_times_eaten_numeric`>0)
nrow(Bass_consumers)
Crappie_consumers <- fisherdb %>% filter(`Past_catches:_Crappie,_times_eaten_numeric`>0)
nrow(Crappie_consumers)
Tilapia_consumers <- fisherdb %>% filter(`Past_catches:_Tilapia,_times_eaten_numeric`>0)
nrow(Tilapia_consumers)
Other_consumers <- fisherdb %>% filter(`Past_catches:_other,_times_eaten_numeric`>0)
nrow(Other_consumers)

###Calculate consumption

consumers <- consumers %>%
  mutate(
    rainbow_trout_g_day = na_if(
      ((`Past_catches:_Rainbow_Trout,_times_eaten_numeric`*`Past_catches:_Rainbow_Trout,_servings_eaten_numeric` * 227) / 28), 0),
    catfish_g_day = na_if(
      ((`Past_catches:_Catfish,_times_eaten_numeric`*`Past_catches:_Catfish,_servings_eaten_numeric` * 227) / 28), 0),
    bluegill_g_day = na_if(
      ((`Past_catches:_Bluegill,_times_eaten_numeric`*`Past_catches:_Blue_gill,_servings_eaten_numeric` * 227) / 28), 0),
    carp_g_day = na_if(
      ((`Past_catches:_Common_Carp,_times_eaten_numeric`*`Past_catches:_Common_Carp,_servings_eaten_numeric` * 227) / 28), 0),
    bass_g_day = na_if(
      ((`Past_catches:_Bass,_times_eaten_numeric`*`Past_catches:_Bass,_servings_eaten_numeric` * 227) / 28), 0),
    crappie_g_day = na_if(
      ((`Past_catches:_Crappie,_times_eaten_numeric`*`Past_catches:_Crappie,_servings_eaten_numeric` * 227) / 28), 0),
    tilapia_g_day = na_if(
      ((`Past_catches:_Tilapia,_times_eaten_numeric`*`Past_catches:_Tilapia,_servings_eaten_numeric` * 227) / 28), 0),
    other_g_day = na_if(
      ((`Past_catches:_other,_times_eaten_numeric`*`Past_catches:_other,_servings_eaten_numeric` * 227) / 28), 0)
  )

###Remove extra data from environment
rm(RT_consumers)
rm(cat_consumers)
rm(BG_consumers)
rm(CC_consumers)
rm(Bass_consumers)
rm(Crappie_consumers)
rm(Tilapia_consumers)
rm(Other_consumers)


```

#Compare consumption rate to OEHHA advisories
```{r ,include=FALSE}
##import thresholds
##Save OEHHA_consumption_advisories.xlsx in working directory, then import
wd <- getwd()
path <- file.path(wd, "OEHHA_consumption_advisories.xlsx") 
excel_sheets(path)
advisories <-read_excel(path, sheet = "Lake advisories")
advisories <- advisories %>% mutate(across(
  c(lake,county, OEHHA_fish_names, join_fish_names), as.factor)
)

##Separate lakes in times_eaten_where into separate columns
#unique_fish <- unique(consumers_long$Catches_Info)

advisories_long <- advisories %>%
   #mutate(rowID = 1:nrow(.))%>%
  select(-(srv_per_wk_child:child_serv_g), - Source, - Notes) %>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = threshold_g_day_child:threshold_g_day_men18,
    names_to = "column",
    values_to = "threshold_g_day"
  )%>%
  mutate(Gender = case_when(
      grepl("child", column) ~ "Child",
      grepl("women", column) ~ "Female",
      grepl("men", column) ~ "Male",
      .default = NA
  )) %>%
  mutate(Age = case_when(
      grepl("_men18", column) ~ ">= 18",
      grepl("18_49", column) ~ "18 - 49",
      grepl("50", column) ~ ">= 50",
      grepl("child", column) ~ "< 18",
      .default = NA
  ))

##In advisories_long change gender "child" to two duplicate rows where Gender is "Male" or "Female"

# Identify rows with Gender == "Child"
child_rows <- advisories_long %>%
  filter(Gender == "Child")

# Duplicate these rows with Gender as "Male" and "Female"
expanded_rows <- child_rows %>%
  mutate(Gender = "Male") %>%
  bind_rows(child_rows %>% mutate(Gender = "Female"))

# Append the new rows to the original dataframe, excluding the original "Child" rows
advisories_long_updated <- advisories_long %>%
  bind_rows(expanded_rows)

##Rename and remove extra data from enviornment

advisories_long <- advisories_long_updated
rm(advisories_long_updated)
rm(child_rows)
rm(expanded_rows)

consumers_long <- consumers %>%
  mutate(rowID = 1:nrow(.)) %>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = starts_with("Past_catches:") & ends_with("times_eaten,_where"),
    names_to = "Catches_Info",
    values_to = "Lakes"
  ) %>%
  #Step 2: Separate the lake names into individual rows
  separate_rows(Lakes, sep = ",") %>%
  mutate(Catches_Info = gsub("(Past_catches:_)|(,.*)", "", Catches_Info)) %>%
  mutate(Catches_Info = gsub("_", " ", Catches_Info)) %>%
  mutate(Lakes = trimws(Lakes))%>%
  # Step 3: Select the columns to keep
  select(rowID, Age_numeric, Observed_Gender, Catches_Info, Lakes, starts_with("Past_catches:") & ends_with(",_times_eaten_numeric"), starts_with("Past_catches:") & ends_with(",_servings_eaten_numeric"),
        starts_with("Past_catches:") & ends_with("parts_eaten"), starts_with("Past_catches:") & ends_with("_cooking_method"),`Past_catches:_Other,_list_species`, Annual_Household_Income, Number_in_household, Ethnicity)  %>%
  rename(`Past_catches:_Bluegill,_servings_eaten_numeric`= `Past_catches:_Blue_gill,_servings_eaten_numeric`)%>% 
  ### If person specified a specific number of times fish eaten from each lake, separate these manually
  separate(Lakes, into = c("Lakes", "times_from_lake"), sep = "\\(", fill = "right") %>%
  mutate(times_from_lake = str_extract(times_from_lake, "\\d+"),
         times_from_lake = as.numeric(times_from_lake)) %>%
  
  # Update Past_catches columns based on times_from_lake and Catches_Info
  mutate(
    `Past_catches:_Rainbow_Trout,_times_eaten_numeric` = if_else(
      Catches_Info == "Rainbow Trout" & !is.na(times_from_lake),
      times_from_lake,
      `Past_catches:_Rainbow_Trout,_times_eaten_numeric`
    ),
    `Past_catches:_Catfish,_times_eaten_numeric` = if_else(
      Catches_Info == "Catfish" & !is.na(times_from_lake),
      times_from_lake,
      `Past_catches:_Catfish,_times_eaten_numeric`
    ),
    `Past_catches:_Bluegill,_times_eaten_numeric` = if_else(
      Catches_Info == "Bluegill" & !is.na(times_from_lake),
      times_from_lake,
      `Past_catches:_Bluegill,_times_eaten_numeric`
    ),
    `Past_catches:_Bass,_times_eaten_numeric` = if_else(
      Catches_Info == "Bass" & !is.na(times_from_lake),
      times_from_lake,
      `Past_catches:_Bass,_times_eaten_numeric`
    ),
    `Past_catches:_Common_Carp,_times_eaten_numeric` = if_else(
      Catches_Info == "Common Carp" & !is.na(times_from_lake),
      times_from_lake,
      `Past_catches:_Common_Carp,_times_eaten_numeric`
    ),
    `Past_catches:_Crappie,_servings_eaten_numeric` = if_else(
      Catches_Info == "Crappie" & !is.na(times_from_lake),
      times_from_lake,
      `Past_catches:_Crappie,_servings_eaten_numeric`
    ),
    `Past_catches:_Tilapia,_times_eaten_numeric` = if_else(
      Catches_Info == "Tilapia" & !is.na(times_from_lake),
      times_from_lake,
      `Past_catches:_Tilapia,_times_eaten_numeric`
    ),
    `Past_catches:_other,_times_eaten_numeric` = if_else(
      Catches_Info == "Other" & !is.na(times_from_lake),
      times_from_lake,
      `Past_catches:_other,_times_eaten_numeric`
    )
  )
  
###Calculate consumption rate of each fish at each lake per person
consumers_long <- consumers_long %>% 
  mutate(daily_intake = case_when(
    Catches_Info == "Rainbow Trout" ~ `Past_catches:_Rainbow_Trout,_times_eaten_numeric` * `Past_catches:_Rainbow_Trout,_servings_eaten_numeric`,
    Catches_Info == "Catfish" ~ `Past_catches:_Catfish,_times_eaten_numeric` * `Past_catches:_Catfish,_servings_eaten_numeric`,
    Catches_Info == "Common Carp" ~ `Past_catches:_Common_Carp,_times_eaten_numeric` * `Past_catches:_Common_Carp,_servings_eaten_numeric`,
    Catches_Info == "Crappie" ~ `Past_catches:_Crappie,_times_eaten_numeric` * `Past_catches:_Crappie,_servings_eaten_numeric`,
    Catches_Info == "Other" ~ `Past_catches:_other,_times_eaten_numeric` * `Past_catches:_other,_servings_eaten_numeric`,
    Catches_Info == "Tilapia" ~ `Past_catches:_Tilapia,_times_eaten_numeric` * `Past_catches:_Tilapia,_servings_eaten_numeric`,
    Catches_Info == "Bluegill" ~ `Past_catches:_Bluegill,_times_eaten_numeric` * `Past_catches:_Bluegill,_servings_eaten_numeric`,
    Catches_Info == "Bass" ~ `Past_catches:_Bass,_times_eaten_numeric` * `Past_catches:_Bass,_servings_eaten_numeric`,
    .default = NA
  )) %>%
  mutate(daily_intake = (daily_intake * 227)/28) %>%
  group_by(Catches_Info, rowID) %>%
  mutate(number_lakes = n()) %>%
  ungroup() %>%
  mutate(
    number_lakes = if_else(
      !is.na(times_from_lake),
      1,
      number_lakes)) %>%
  
  mutate(daily_intake_per_lake = daily_intake/number_lakes) %>% 
  mutate(Lakes = trimws(Lakes))%>%
  mutate(Catches_Info = case_when(
    Catches_Info == "Other" & !is.na(`Past_catches:_Other,_list_species`) & 
      `Past_catches:_Other,_list_species` != "NA" ~ `Past_catches:_Other,_list_species`,
    TRUE ~ Catches_Info
  ))

updated_rows <- consumers_long %>%
  filter(Catches_Info != "Other" & !is.na(`Past_catches:_Other,_list_species`) & `Past_catches:_Other,_list_species` != "NA" )

##Update lake names with join
consumers_long <- consumers_long %>%
  left_join(unique_lake_names_key %>%
              select(original_name, lake , county), by = c("Lakes" = "original_name")) %>%
  rename(updated_lake_name = lake) %>%
   mutate(
    # Track if the lake name was updated
    lake_name_changed = case_when(
      is.na(updated_lake_name) ~ "Missing Match",       # No match in the key
      Lakes != updated_lake_name ~ "Updated",          # Lake name was changed
      TRUE ~ "Unchanged"                               # Lake name stayed the same
    )
  ) %>%
  mutate(Observed_Gender = as.character(Observed_Gender)) %>%
  mutate(Age_Category =  case_when(
    Age_numeric < 18 ~ "< 18",
    Age_numeric >= 18 & Observed_Gender == "Male" ~ ">= 18",
    Age_numeric >= 18 & Age_numeric < 50 & Observed_Gender == "Female" ~ "18 - 49",
    Age_numeric > 50 & Observed_Gender == "Female" ~ ">= 50",
    .default = NA
   )
  )

Lake_name_check <- consumers_long %>% select(Lakes,updated_lake_name, lake_name_changed)
age_check <- consumers_long %>% select(Age_numeric, Observed_Gender, Age_Category)
rm(Lake_name_check)
rm(age_check)

##update fish names to match OEHHA categories
consumers_long <- consumers_long %>%
  mutate(
    original_Catches_Info = Catches_Info,  # Save the original value for comparison
    Catches_Info = case_when(
      Catches_Info == "Rainbow Trout" ~ "Rainbow trout",
      Catches_Info == "Catfish" ~ "Catfish",
      Catches_Info == "Bluegill" ~ "Sunfish species",
      Catches_Info == "Common Carp" ~ "Common carp",
      Catches_Info == "Bass" ~ "Black bass species",
      Catches_Info == "Crappie" ~ "Crappie",
      Catches_Info == "Tilapia" ~ "Tilapia",
      Catches_Info == "Other" ~ "Other",
      Catches_Info == "Striped Bass" ~ "Striped bass",
      Catches_Info == "Redear sunfish" ~ "Sunfish species",
      TRUE ~ Catches_Info  # Retain the original value if no match
    ),
    Catches_Info_changed = case_when(
      original_Catches_Info == Catches_Info ~ "Unchanged",
      TRUE ~ "Updated"
    ))

fish_name_check <- consumers_long %>% select(original_Catches_Info, Catches_Info, Catches_Info_changed)
rm(fish_name_check)
consumers_long <- consumers_long %>% select (-Catches_Info_changed, -original_Catches_Info)

# Trim whitespace from both columns before the join
advisories_long <- advisories_long %>%
  mutate(lake = str_trim(lake))

consumers_long <- consumers_long %>%
  mutate(updated_lake_name = str_trim(updated_lake_name))


##Create separate dataset for statewide advisories
statewide_adv <- advisories_long %>% filter(
  lake == "Statewide") %>%
  rename(threshold_used = county,
         statewide_column = column,
         statewide_threshold_g_day = threshold_g_day)


##Join consumers with advisories
  consumers_long_adv <- consumers_long  %>%
  left_join(advisories_long, by = c("updated_lake_name" = "lake", 
                                    "Age_Category" = "Age", 
                                    "Observed_Gender" = "Gender",
                                    "Catches_Info" = "join_fish_names"
                                    )) %>%
   rename(county = county.x)%>%
   select(-county.y)
  
  # Check for unmatched rows
unmatched_rows <- anti_join(consumers_long, advisories_long, by = c(
  "updated_lake_name" = "lake", 
  "Age_Category" = "Age", 
  "Observed_Gender" = "Gender",
  "Catches_Info" = "join_fish_names"
))

matched_rows <- consumers_long_adv %>% select(Catches_Info, Lakes, updated_lake_name, OEHHA_fish_names, column, threshold_g_day)%>%
  filter(!is.na(Lakes) & Lakes != "NA")%>%
  filter(!is.na(OEHHA_fish_names) & OEHHA_fish_names != "NA")
unmatched_rows <- unmatched_rows %>% filter(!is.na(Lakes) & Lakes != "NA")

#swap name back
consumers_long <- consumers_long_adv
rm(consumers_long_adv)

write.csv(consumers_long, "consumers_long.csv", row.names = FALSE)

###Now consumers_long has lake specific matches
##Fill in statewide advisories for lakes/fish where there are no lake specific consumption data

summary(as.factor(consumers_long$column))
##636 obs, 564 NAs

#step 1: filter data
filtered_data <- consumers_long %>% 
  filter(is.na(column))

#step 2: Perform the left join 
joined_data <- filtered_data %>%
  left_join(statewide_adv, by = c("Age_Category" = "Age", 
                                  "Observed_Gender" = "Gender",
                                  "Catches_Info" = "join_fish_names")) %>%
  select(-lake)

summary(as.factor(joined_data$statewide_column))
##565 obs, 137 NAs 

##Checks columns which are still NA
join_check <- joined_data %>% filter (is.na(statewide_column))
##Verified all Tilapia, or other w/ no daily intake
# Keep the rows that do not meet the condition as they are
##Should have 71 observations (636 obs from consumers long - 565 NA)
non_joined_data <- consumers_long %>%
  filter(!(is.na(column)))
  
# Combine the two data frames back together
##Should have 636 obs again 
consumers_long <- bind_rows(joined_data, non_joined_data) 

consumers_long <- consumers_long %>% 
  mutate(column = coalesce(column, statewide_column,),
         threshold_g_day = coalesce(threshold_g_day, statewide_threshold_g_day),
         OEHHA_fish_names = coalesce(OEHHA_fish_names, OEHHA_fish_names.y),
         threshold_used = if_else(is.na(threshold_used) & !is.na(column), "lake specific", threshold_used)
         )%>%
  select(-statewide_column, - statewide_threshold_g_day, -OEHHA_fish_names.x, - OEHHA_fish_names.y)%>%
  group_by(Catches_Info, rowID) %>%
  mutate(avg_threshold = mean(threshold_g_day))%>%
  ungroup() %>%
##Does consumption by each individual from one lake exceed threshold for that specific lake
  mutate(exceed_threshold_indiv_lake = daily_intake_per_lake > threshold_g_day)%>%
##Does total consumption by each individual from all lakes exceed average threshold for one lake or all lakes 
  mutate(exceed_threshold_avg_lake = exceed_threshold_indiv_lake | (daily_intake > avg_threshold))
  
##datacheck 
datacheck <- consumers_long %>% select(rowID, Catches_Info, updated_lake_name, threshold_g_day, avg_threshold)

##Subset to only rows with daily intake greater than zero
summary(as.factor(consumers_long$daily_intake))
#451 NAs # 30 obs = 0 # final obs after filter should be 636-451-30 = 155

consumers_long <- consumers_long %>% 
  filter(daily_intake>0)

write.csv(consumers_long, "consumers_long.csv", , row.names = FALSE)


```

##LOOP surveyed lakes consumption 
```{r ,include=FALSE}
####This loop provides a .csv output with the number of people consuming fish from each of the surveyed lakes and a summary of their consumption of different fish species from each individual lake alone (Not including fish they may be consuming at other lakes). percent_exceed_lake provides the percent of consumers whose fish consumption at the specified lake ALONE exceeds the OEHHA lake specific or statewide consumption threshold. percent_exceed_avg provides the percent of consumers whose fish consumption both from the specified lake and other lakes exceeds the average threshold for the lakes they consume from. Therefore, if percent_exceed_lake and percent_exceed_avg are the same then threshold exceedance is driven by the specified lake. If percent_exceed_avg is greater than percent_exceed_lake then there are other lakes contributing to threshold exceedance

# List of fish species to analyze
fish_species <- list(
  "All" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "All" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

lakes <- list(
  "All" = c("Alondra park","Legg lake", "Peck Road","Magic Johnson Lakes" ),
  "Alondra park" = "Alondra park",
  "Legg lake" = "Legg lake",
  "Magic Johnson Lakes" = "Magic Johnson Lakes",
  "Peck Road" = "Peck Road"
  )

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
### Percent of consumers exceeding thresholds by lake (Exceed lake specific threshold by consuming fish ONLY at that lake)
  per_exceed_thresh <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded_lake = any(exceed_threshold_indiv_lake)) %>% #Groups by row ID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold at any individual lake and false if they have not. 
    ungroup() %>%
    filter(!is.na(any_exceeded_lake)) %>% #filters out NAs so that only TRUE / FALSE values are being assesseed 
    summarise(percent_exceed_lake = round((sum(any_exceeded_lake) / n()) * 100)) %>%  #Summarizes entire column to      calculate percent true exceeding individual lake thresholds
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())
  
   ### Percent of consumers exceeding thresholds avg threshold
  per_exceed_avg_thresh <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
   summarise(any_exceeded_avg = any(exceed_threshold_avg_lake)) %>%# #Does total consumption by each individual from    all lakes exceed average threshold for all lakes
    ungroup() %>%
    filter(!is.na(any_exceeded_avg)) %>%
   summarise(percent_exceed_avg = round((sum(any_exceeded_avg) / n()) * 100)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### Consumers total consumption rate 
  all_consumption_rate <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake_per_lake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)
  summary_table <- left_join(summary_table, per_exceed_avg_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
all_lakes_summary_table <- bind_rows(summary_tables)

# Write to CSV
write.csv(all_lakes_summary_table, "consumption_summary_surveyed_lakes.csv", row.names = FALSE)


alondra_check <- consumers_long %>%
  filter(updated_lake_name == "Alondra park")#%>%

legg_check <- consumers_long %>%
  filter(updated_lake_name == "Legg lake")#%>%

mj_check <- consumers_long %>%
  filter(updated_lake_name == "mj lake")#%>%

write.csv(alondra_check, "alondra_check.csv", row.names = FALSE)
write.csv(legg_check, "legg_check.csv", row.names = FALSE)
write.csv(mj_check, "mj_check.csv", row.names = FALSE)

```

##LOOP consumption - All lakes not surveyed directly
```{r ,include=FALSE}

consumers_lakes_not_surv <- consumers_long %>%
  mutate(updated_lake_name = case_when(
    updated_lake_name == "No match" ~ "Unknown",  # Replace "No match" with "Unknown"
    is.na(updated_lake_name) ~ "Unknown",        # Replace NA with "Unknown"
    TRUE ~ updated_lake_name                     # Keep other values unchanged
  ))

datacheck <- consumers_lakes_not_surv %>% select(rowID, Catches_Info , number_lakes,daily_intake, daily_intake_per_lake, threshold_g_day, threshold_used, avg_threshold)

# List of fish species to analyze

fish_species <- list(
  "All" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie", "Striped bass"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie",
  "Striped bass" = "Striped bass"
)

age <- list(
  "All" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

# Extract unique lake names from the dataframe
unique_lakes <- unique(consumers_lakes_not_surv$updated_lake_name)

# Create a named list dynamically
lakes <- setNames(as.list(unique_lakes), unique_lakes)

lakes <- list(
  "El Dorado Park Lake" = "El Dorado Park Lake",
  "Unknown" = "Unknown",
  "Santa Ana River Lakes" = "Santa Ana River Lakes",
  "Lake Perris" = "Lake Perris",
  "Laguna Niguel Lake" = "Laguna Niguel Lake",
  "Lake Skinner" = "Lake Skinner",
  "Irvine Lake" = "Irvine Lake",
  "Tri-City Regional Park" = "Tri-City Regional Park",
  "Kenneth Hahn/Gwen Moore Lake" = "Kenneth Hahn/Gwen Moore Lake",
  "Downey Wilderness Park Lake" = "Downey Wilderness Park Lake",
  "Cachuma lake" = "Cachuma lake",
  "Hollenbeck Park Lake" = "Hollenbeck Park Lake",
  "Lake Gregory Regional Park" = "Lake Gregory Regional Park",
  "Echo Park Lake" = "Echo Park Lake",
  "Santa Fe Dam lake" = "Santa Fe Dam lake",
  "Lake Piru" = "Lake Piru",
  "Belvedere Park" = "Belvedere Park",
  "Lincoln Park Lake" = "Lincoln Park Lake",
  "MacArthur Park" = "MacArthur Park",
  "Carbon Canyon Regional Park" = "Carbon Canyon Regional Park",
  "Puddingstone reservoir" = "Puddingstone reservoir",
  "Crystal Lake" = "Crystal Lake",
  "Prado Dam" = "Prado Dam",
  "Castaic Lake" = "Castaic Lake",
  "Pyramid lake" = "Pyramid lake",
  "Big Bear lake" = "Big Bear lake")
  


# Initialize an empty list to store summary tables
summary_tables_all_Lakes <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
      ### Percent of consumers exceeding thresholds by lake 
  per_exceed_thresh <- consumers_lakes_not_surv %>%
    group_by(rowID) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded = any(exceed_threshold_indiv_lake, na.rm=TRUE)) %>%#Groups by row ID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold at any individual lake and false if they have not. 
    ungroup() %>%
    filter(!is.na(any_exceeded)) %>% #filters out NAs so that only TRUE / FALSE values are being assessed 
    summarise(percent_exceed = round((sum(any_exceeded) / n()) * 100,0)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

       ### Consumers total consumption rate at lake
  all_consumption_rate <- consumers_lakes_not_surv %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake_per_lake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)

    # Store the summary table in the list with a unique key
summary_tables_all_Lakes[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
all_lakes_summary_table <- bind_rows(summary_tables_all_Lakes)
#Remove NA values
all_lakes_summary_table <- all_lakes_summary_table %>%
  filter(n > 0)

# Rearrange rows for export
all_lakes_summary_table <- all_lakes_summary_table %>%
  mutate(
    sort_order = ifelse(lakes == "Unknown", 1, 0)  # Assign 1 to "Unknown" and 0 to all others
  ) %>%
  arrange(sort_order, lakes) %>%  # Sort by the helper column and then alphabetically by "lakes"
  select(-sort_order)# Remove the helper column

#create dataframe with county information
county_key <- consumers_lakes_not_surv %>%
  select(updated_lake_name, county) %>%
  mutate(lakes = updated_lake_name) %>%
  select(-updated_lake_name) %>%
  distinct(lakes, .keep_all = TRUE)  # Keep only unique rows based on "lakes"

all_lakes_export <-left_join(all_lakes_summary_table,county_key, by = "lakes")
all_lakes_export <- all_lakes_export %>%
  select(lakes, county, everything())


# Write to CSV
write.csv(all_lakes_export, "All_lakes_summary.csv", row.names = FALSE)



```


##Calculate consumption rate (household members)
```{r ,include=FALSE}
##Subset to only household consumers (<4 weeks)

columns_to_check <- c(
  "Servings_eaten_(Person_1)_numeric", "Times_eaten_last_4_weeks__(Person_1)_numeric",
  "Servings_eaten_(Person_2)_numeric", "Times_eaten_last_4_weeks__(Person_2)_numeric",
  "Servings_eaten_(Person_3)_numeric", "Times_eaten_last_4_weeks__(Person_3)_numeric",
  "Servings_eaten_(Person_4)_numeric", "Times_eaten_last_4_weeks__(Person_4)_numeric"
)

sapply(fisherdb[columns_to_check],class)
summary(fisherdb[columns_to_check])



household_consumers <- fisherdb %>% filter(
                  `Servings_eaten_(Person_1)_numeric` >0  & `Times_eaten_last_4_weeks__(Person_1)_numeric`>0|
                  `Servings_eaten_(Person_2)_numeric` >0  & `Times_eaten_last_4_weeks__(Person_2)_numeric`>0|
                  `Servings_eaten_(Person_3)_numeric` >0  & `Times_eaten_last_4_weeks__(Person_3)_numeric`>0|
                  `Servings_eaten_(Person_4)_numeric` >0  & `Times_eaten_last_4_weeks__(Person_4)_numeric`>0
)

summary(household_consumers[columns_to_check])

##Define midpoint calc function

household_consumers_long <- household_consumers %>%
  mutate(fisherID = 1:nrow(.)) %>%
  select(-(`Start`:`Caught_Other,_if_not_eating_why`))%>% 
  pivot_longer(
    cols = starts_with("Relation_to_fisher"),
    names_to = "household_member",
    values_to = "Relation_to_fisher"
  )%>%
  mutate(Relation_to_fisher=(as.factor(Relation_to_fisher)))%>%
  filter(Relation_to_fisher != "NA" & Relation_to_fisher != "Na")%>%
  mutate(household_member = gsub("^Relation_to_fisher_","",household_member)) %>%
  mutate(household_member = gsub("^\\(|\\)$", "", household_member))%>%
  ##Associate correct data with each record
  ###Calculate daily intake
  mutate(daily_intake = case_when(
     household_member == "Person_1" ~ `Times_eaten_last_4_weeks__(Person_1)_numeric` *  `Servings_eaten_(Person_1)_numeric`,
     household_member == "Person_2" ~ `Times_eaten_last_4_weeks__(Person_2)_numeric` * `Servings_eaten_(Person_2)_numeric`,
     household_member == "Person_3" ~ `Times_eaten_last_4_weeks__(Person_3)_numeric` * `Servings_eaten_(Person_3)_numeric`,
     household_member == "Person_4" ~ `Times_eaten_last_4_weeks__(Person_4)_numeric` * `Servings_eaten_(Person_4)_numeric`,
    .default = NA
  )) %>%
mutate(daily_intake = (daily_intake * 227)/28) %>%
  ###Associate Age
mutate(hh_age = case_when(
    household_member == "Person_1" ~ `Age_(Person_1)_numeric`,
    household_member == "Person_2" ~ `Age_(Person_2)_numeric`,
    household_member == "Person_3" ~ `Age_(Person_3)_numeric`,
    household_member == "Person_4" ~ `Age_(Person_4)_numeric`,
  ))%>%
  
  ###Associate gender
mutate(hh_gender = case_when(
    household_member == "Person_1" ~ `Gender_(Person_1)`,
    household_member == "Person_2" ~ `Gender_(Person_2)`,
    household_member == "Person_3" ~ `Gender_(Person_3)`,
    household_member == "Person_4" ~ `Gender_(Person_4)`,
  )) %>%
  ###Associate species consumed
mutate(hh_species_consumed = case_when(
    household_member == "Person_1" ~ `Species_consumed_(Person_1)`,
    household_member == "Person_2" ~ `Species_consumed_(Person_2)`,
    household_member == "Person_3" ~ `Species_consumed_(Person_3)`,
    household_member == "Person_4" ~ `Species_consumed_(Person_4)`,
  )) %>%
  ###Associate parts_eaten
mutate(hh_parts_eaten = case_when(
    household_member == "Person_1" ~ `Parts_eaten_(Person_1)`,
    household_member == "Person_2" ~ `Parts_eaten_(Person_2)`,
    household_member == "Person_3" ~ `Parts_eaten_(Person_3)`,
    household_member == "Person_4" ~ `Parts_eaten_(Person_4)`,
  )) %>%
  ###Associate cooking_details
mutate(hh_cooking_details = case_when(
    household_member == "Person_1" ~ `Cooking_method_(Person_1)`,
    household_member == "Person_2" ~ `Cooking_method_(Person_2)`,
    household_member == "Person_3" ~ `Cooking_method_(Person_3)`,
    household_member == "Person_4" ~ `Cooking_method_(Person_4)`,
  ))%>%
  ###Associate times eaten 
mutate(hh_times_eaten = case_when(
  household_member == "Person_1" ~ `Times_eaten_last_4_weeks__(Person_1)_numeric`,
    household_member == "Person_2" ~ `Times_eaten_last_4_weeks__(Person_2)_numeric`,
    household_member == "Person_3" ~ `Times_eaten_last_4_weeks__(Person_3)_numeric`,
    household_member == "Person_4" ~ `Times_eaten_last_4_weeks__(Person_4)_numeric`,
))%>%
  ###Associate Servings eaten 
mutate(hh_servings_eaten = case_when(
  household_member == "Person_1" ~ `Servings_eaten_(Person_1)_numeric`,
    household_member == "Person_2" ~ `Servings_eaten_(Person_2)_numeric`,
    household_member == "Person_3" ~ `Servings_eaten_(Person_3)_numeric`,
    household_member == "Person_4" ~ `Servings_eaten_(Person_4)_numeric`,
))%>%

  ###Remove extra rows
#select(-(`Age_(Person_1)`:`Cooking_details_(Person_4)`)) %>%
  ##Separate hh_species_consumed into separate columns
separate(hh_species_consumed, into = c("hh_species1", "hh_species2", "hh_species3", "hh_species4"), sep = ",")%>%
  filter(daily_intake != "NA" & daily_intake != "Na")

length(unique(household_consumers_long$fisherID))
##Dataset represents 68 household members from 38 households

##Convert to long format by species for each household consumer
hh_consumers_species_long <- household_consumers_long %>%
  mutate(hh_consumerID = 1:nrow(.)) %>%
  pivot_longer(
    cols = starts_with("hh_species"),
    names_to = "delete",
    values_to = "hh_species_consumed"
  )%>%
  filter(complete.cases(hh_species_consumed))%>%
  mutate(hh_species_consumed = trimws(hh_species_consumed))%>%
  mutate(
    add_sp_info = str_extract(hh_species_consumed, "\\(.*?\\)"),  # Extract text within parentheses
    hh_species_consumed = str_remove(hh_species_consumed, "\\(.*?\\)")  # Remove text within parentheses 
    ) %>%
  mutate(add_sp_info = str_remove_all(add_sp_info, "[()]")  # Remove parentheses from the new column
  ) %>%
  mutate(
    hh_sp_consumed_where = case_when(
      add_sp_info == "puddingstone" ~ "puddingstone",
      TRUE ~ NA_character_  # Default case for other values
    ))%>%
  mutate(hh_sp_consumed_times = case_when(add_sp_info == "puddingstone" ~ NA_character_,
      TRUE ~ add_sp_info  # Default case for other values
    ))%>%
  select(-add_sp_info) %>%
  mutate(hh_sp_consumed_times = as.character(hh_sp_consumed_times))%>%
  mutate(hh_sp_consumed_times = case_when(
    hh_sp_consumed_times == "x  2 to 3" ~ "2.5",
    hh_sp_consumed_times == "x 8 to 10" ~ "9",
    hh_sp_consumed_times == "x1" ~ "1",
    hh_sp_consumed_times == "x10" ~ "10",
    hh_sp_consumed_times == "x2" ~ "2",
    hh_sp_consumed_times == "x3" ~ "3",
    TRUE ~ hh_sp_consumed_times
  ))%>%
  mutate(hh_sp_consumed_times = as.numeric(hh_sp_consumed_times))%>%
  mutate(hh_species_consumed= trimws(hh_species_consumed))%>%
  mutate (hh_species_consumed = case_when(
    hh_species_consumed == "Rainbow Trout" ~ "Rainbow trout",
    hh_species_consumed == "Rainbow trout" ~ "Rainbow trout",
    hh_species_consumed == "Trout" ~ "Rainbow trout",
    hh_species_consumed == "Catfish" ~ "Catfish",
    hh_species_consumed == "catfish" ~ "Catfish",
    hh_species_consumed == "Bluegill" ~ "Sunfish species",
    hh_species_consumed == "bluegill" ~ "Sunfish species",
    hh_species_consumed == "Common Carp" ~ "Common carp",
    hh_species_consumed == "Carp" ~ "Common carp",
    hh_species_consumed == "Bass" ~ "Black bass species",
    hh_species_consumed == "Crappie" ~ "Crappie",
    hh_species_consumed == "Tilapia"   ~ "Tilapia"  ,
    hh_species_consumed == "Other" ~ "Other",
    TRUE ~ hh_species_consumed #For species not listed above
  ))%>%
  
  group_by(hh_consumerID) %>%
  mutate(number_fish_sp = n()) %>%
  ungroup()%>%
  mutate(hh_total_daily_intake = daily_intake)%>%
  select(-c(delete , daily_intake))%>%
  
  ##If number of times each species was consumed was not specified, then the total number of servings was divided by the   number of fish
  
  mutate(
    replacement_value = ifelse(
      is.na(hh_sp_consumed_times),
      hh_times_eaten / number_fish_sp,  # Replace with calculated value
      hh_sp_consumed_times             # Keep original value
    ),
    changed = is.na(hh_sp_consumed_times),  # Track changes
    hh_sp_consumed_times = replacement_value  # Update column with replacement
  ) %>%
  select(-replacement_value)  # Remove temporary column

# Filter rows where changes were made
changed_rows <- hh_consumers_species_long %>%
  filter(changed) %>%
  select(hh_consumerID, hh_species_consumed,hh_times_eaten, number_fish_sp, hh_sp_consumed_times, changed)

#write.csv(hh_consumers_species_long, "hh_consumers_species_long.csv", row.names = FALSE)


###Calculate daily intake by fish species
hh_consumers_species_long <- hh_consumers_species_long %>%
mutate(hh_daily_intake_per_fish = (hh_servings_eaten*hh_sp_consumed_times*227)/28)%>%
  ###Next steps associate lakes + fish from person interviewed with household members...
  mutate (hh_lake = case_when(
    hh_species_consumed == "Rainbow trout"  ~ `Past_catches:_Rainbow_Trout,_times_eaten,_where`,
    hh_species_consumed == "Sunfish species" ~ `Past_catches:_Bluegill,_times_eaten,_where`,
    hh_species_consumed == "Catfish"   ~ `Past_catches:_Catfish,_times_eaten,_where`,
    hh_species_consumed == "Common carp"   ~ `Past_catches:_Common_Carp,_times_eaten,_where`,
    hh_species_consumed == "Crappie"  ~ `Past_catches:_Crappie,_times_eaten,_where` ,
    hh_species_consumed == "Largemouth bass" ~ `Past_catches:_Bass,_times_eaten,_where`,
  ))%>%
  mutate(hh_lake = if_else(!is.na(hh_sp_consumed_where), hh_sp_consumed_where, hh_lake))%>%
  
   ##Separate lake data into separate columns
separate(hh_lake, into = c("hh_lake1", "hh_lake2", "hh_lake3", "hh_lake4"), sep = ",")%>%
##68 unique consumers ##113 rows * 4 = 452
# length(unique(hh_consumers_species_long$hh_consumerID))

###pivot long by lake and divide consumption by lake
  pivot_longer(
    cols = starts_with("hh_lake"),
    names_to = "delete",
    values_to = "hh_lakes"
  )%>% #277 NAs -> 175
  filter(complete.cases(hh_lakes))%>%
  mutate(hh_lakes= trimws(hh_lakes))%>%
  ##
  separate(hh_lakes, into = c("hh_lakes", "times_from_lake"), sep = "\\(", fill = "right") %>%
   mutate(
    hh_lakes = trimws(hh_lakes),  # Clean up whitespace in hh_lakes
    times_from_lake = str_extract(times_from_lake, "\\d+")  # Extract only the numeric value
  )%>%
  ##
  group_by(hh_consumerID, hh_species_consumed) %>%
  mutate(number_lakes = n()) %>%
  ungroup() %>%
  mutate(
    hh_daily_intake_per_fish_per_lake = case_when(
      # If "times_from_lake" is NA
      is.na(times_from_lake) ~ hh_daily_intake_per_fish / number_lakes,
      # If "times_from_lake" is numerical
      !is.na(times_from_lake) ~ (as.numeric(times_from_lake) / hh_sp_consumed_times) * hh_daily_intake_per_fish,
      # Default case (optional, you can remove this if all cases are covered)
      TRUE ~ NA_real_))%>%
  select(-delete)
 
  length(unique(hh_consumers_species_long$hh_consumerID))
 
```
##Compare household consumption to OEHHA advisories

```{r ,include=FALSE}

###extract lake names to update key
hh_lake_names <- hh_consumers_species_long$hh_lakes
hh_lake_names <-trimws(hh_lake_names)
hh_lake_names <- unique(hh_lake_names)

#write.csv(hh_lake_names,"hh_lake_names.csv", row.names = FALSE)

##Names and counties were added to "unique_lake_names.csv" -- now import this dataset

unique_lake_names_key <- read.csv("unique_lake_names_key.csv")

##Join lakes & key to identify if any missed

df_hh_lake_names <- as.data.frame(hh_lake_names)
anti_join_lakes <- anti_join(df_hh_lake_names, unique_lake_names_key, by=c("hh_lake_names" = "original_name"))


##Update lake names with join
hh_consumers_species_long_match <- hh_consumers_species_long %>%
  left_join(unique_lake_names_key %>%
              select(original_name, lake , county), by = c("hh_lakes" = "original_name")) %>%
  rename(updated_lake_name = lake) %>%
  mutate(Age_Category =  case_when(
    hh_age < 18 ~ "< 18",
    hh_age >= 18 & hh_gender == "Male" ~ ">= 18",
    hh_age >= 18 & hh_age < 50 & hh_gender == "Female" ~ "18 - 49",
    hh_age >= 50 & hh_gender == "Female" ~ ">= 50",
    .default = NA
  ))%>%
mutate(hh_gender_original = case_when(
  hh_gender =="Female" ~"Female",
  hh_gender == "Male"~"Male",
  TRUE ~ "Not reported"  # Default case for other values
))%>%
mutate(hh_gender = case_when(
  hh_age <18 ~ "Child",
  hh_gender =="Female" ~"Female",
  hh_gender == "Male"~"Male"
))%>%
mutate(hh_species_consumed = case_when(
  hh_species_consumed == "Largemouth bass" ~ "Black bass species",
  TRUE ~ hh_species_consumed
))

##Join consumers with advisories
  hh_consumers_species_long_adv <- hh_consumers_species_long_match   %>%
  left_join(advisories_long, by = c("updated_lake_name" = "lake", 
                                    "Age_Category" = "Age", 
                                    "hh_gender" = "Gender",
                                    "hh_species_consumed" = "join_fish_names"
                                    )) %>%
   rename(county = county.x)%>%
   select(-county.y)

#write.csv(hh_consumers_species_long_adv, "hh_consumers_species_long_adv.csv", row.names = FALSE)
  
##Fill in statewide advisories for lakes/fish where there are no lake specific consumption data
# Perform the left join only on the rows that meet the condition
summary(as.factor(hh_consumers_species_long_adv$column)) ##124 NAs
  
hh_joined_data <- hh_consumers_species_long_adv %>% ##Should be 124 obs
  filter(is.na(column)) %>%
  left_join(statewide_adv, by = c("Age_Category" = "Age", 
                                  "hh_gender" = "Gender",
                                  "hh_species_consumed" = "join_fish_names"))%>%
  select(-lake)
summary(as.factor(hh_joined_data$statewide_column)) ##Remaining 15 NAs unmatched due to missing Age and Gender information
write.csv(hh_joined_data, "hh_joined_data.csv",row.names=FALSE)

# Keep the rows that do not meet the condition as they are
hh_non_joined_data <- hh_consumers_species_long_adv %>% #should be 51 obs
  filter(!(is.na(column)))
summary(as.factor(hh_non_joined_data$column))
  
# Combine the two data frames back together
hh_consumers_species_long_adv <- bind_rows(hh_joined_data, hh_non_joined_data) 
#write.csv(hh_consumers_species_long_adv, "hh_consumers_species_long_adv.csv", row.names = FALSE)

hh_consumers_species_long_adv <-hh_consumers_species_long_adv %>% 
  mutate(column = coalesce(column, statewide_column,),
         threshold_g_day = coalesce(threshold_g_day, statewide_threshold_g_day),
         OEHHA_fish_names = coalesce(OEHHA_fish_names, OEHHA_fish_names.y),
         threshold_used = if_else(is.na(threshold_used) & !is.na(column), "lake specific", threshold_used)
         )%>%
  select(-statewide_column, - statewide_threshold_g_day, -OEHHA_fish_names.x, - OEHHA_fish_names.y)%>%
  group_by(hh_species_consumed, hh_consumerID) %>%
  mutate(avg_threshold = mean(threshold_g_day))%>%
  ungroup()%>%
 ##Does consumption by each individual from one lake exceed threshold for that specific lake
   mutate(exceed_threshold_indiv_lake = hh_daily_intake_per_fish_per_lake > threshold_g_day) %>%
##Does total consumption by each individual from all lakes exceed average threshold for one lake or all lakes 
  mutate(exceed_threshold_avg_lake = exceed_threshold_indiv_lake | (hh_daily_intake_per_fish > avg_threshold))
  
write.csv(hh_consumers_species_long_adv, "hh_consumers_long.csv", , row.names = FALSE)

```


##hh LOOP ALL surveyed lakes
```{r ,include=FALSE}

##Household consumption across all lakes (may be able to delete)

# List of fish species to analyze
fish_species <- list(
  "All" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "All" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

lakes <- list(
  "All_Surveyed" = c("Alondra park","Legg lake", "Peck Road","Magic Johnson Lakes" )
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
    
  ### Percent of consumers exceeding thresholds by lake (Exceed lake specific threshold by consuming fish ONLY at that lake) OF if all LA county then calculating contribution of LA county lakes specifically 
      per_exceed_thresh_all_hh <- hh_consumers_species_long_adv %>%
        group_by(hh_consumerID)%>%
        filter(hh_total_daily_intake > 0) %>%
        filter(hh_species_consumed %in% selected_fish) %>%
        filter(column %in% selected_age)%>%
        filter(updated_lake_name %in% selected_lake) %>%
        summarise(any_hh_exceeded_all = any(exceed_threshold_indiv_lake)) %>% #Groups by hh_consumerID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold by eating fish at lakes in LA and false if they have not. 
        ungroup() %>%
        filter(!is.na(any_hh_exceeded_all)) %>% #filters out NAs so that only TRUE / FALSE values are being assessed 
        summarise(percent_exceed = round((sum(any_hh_exceeded_all) / n()) * 100)) %>%
        mutate(lakes = lake_name) %>%  # Add a column for the label
        mutate(fish = fish_name) %>%
        mutate(age = age_group) %>%
        select(lakes, age, fish, everything())
      
  
    ### Percent of consumers exceeding avg thresholds
    
    per_exceed_avg_thresh_all_hh <- hh_consumers_species_long_adv %>%
    group_by(hh_consumerID) %>%
    filter(hh_total_daily_intake > 0) %>%
    filter(hh_species_consumed %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(exceed_threshold = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(exceed_threshold)) %>%
    summarise(percent_exceed_lake = round((sum(exceed_threshold) / n()) * 100)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish =fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### All consumers consumption rate
  all_consumption_rate <- hh_consumers_species_long_adv%>%
    group_by(hh_consumerID) %>%
    filter(hh_total_daily_intake > 0) %>%
    filter(hh_species_consumed %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(hh_daily_intake_per_fish_per_lake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh_all_hh)
  summary_table <- left_join(summary_table, per_exceed_avg_thresh_all_hh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}

# Combine all summary tables into a single data frame
hh_all_lakes_summary_table <- bind_rows(summary_tables)
hh_all_lakes_summary_table <- hh_all_lakes_summary_table %>%
  filter(complete.cases(median))
    
    
    # Write to CSV
write.csv(hh_all_lakes_summary_table, "hh_consumption_summary_all.csv", row.names = FALSE)
    
    

```

##hh LOOP all individual lakes
```{r ,include=FALSE}
hh_consumers_species_long_adv<- hh_consumers_species_long_adv %>%
  mutate(updated_lake_name = case_when(
    updated_lake_name == "No match" ~ "Unknown",  # Replace "No match" with "Unknown"
    is.na(updated_lake_name) ~ "Unknown",        # Replace NA with "Unknown"
    TRUE ~ updated_lake_name                     # Keep other values unchanged
  ))

check <- hh_consumers_species_long_adv %>% select(fisherID, hh_consumerID)

summary(as.factor(hh_consumers_species_long_adv$hh_species_consumed))
summary(as.factor(hh_consumers_species_long_adv$updated_lake_name))
list(unique(hh_consumers_species_long_adv$updated_lake_name))
length(unique(hh_consumers_species_long_adv$updated_lake_name))
# List of fish species to analyze
fish_species <- list(
  "All" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie"),
 "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "All" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

unique_lakes <- hh_consumers_species_long_adv %>%
  distinct(updated_lake_name) %>%
  pull(updated_lake_name)

# Create the named list
lakes <- setNames(as.list(unique_lakes), unique_lakes)

#Check number of hh consumers
length(unique(hh_consumers_species_long_adv$hh_consumerID)) #68

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
    
    
  ### Percent of consumers exceeding thresholds by lake (Exceed lake specific threshold by consuming fish ONLY at that lake)
 
      per_exceed_thresh_hh <- hh_consumers_species_long_adv %>%
        group_by(hh_consumerID)%>%
        filter(hh_species_consumed %in% selected_fish) %>%
        filter(column %in% selected_age)%>%
        filter(updated_lake_name %in% selected_lake) %>%
        summarise(any_hh_exceeded_adv = any(exceed_threshold_indiv_lake)) %>% #Groups by hh_consumerID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold by eating fish at lakes and false if they have not. 
        ungroup() %>%
        filter(!is.na(any_hh_exceeded_adv)) %>% #filters out NAs so that only TRUE / FALSE values are being assessed
        summarise(percent_exceed = round((sum(any_hh_exceeded_adv) / n()) * 100)) %>%
        mutate(lakes = lake_name) %>%  # Add a column for the label
        mutate(fish = fish_name) %>%
        mutate(age = age_group) %>%
        select(lakes, age, fish, everything())
      
  ### All consumers consumption rate
  all_hh_consumption_rate <- hh_consumers_species_long_adv%>%
    group_by(hh_consumerID, fisherID) %>%
    filter(hh_total_daily_intake > 0) %>%
    filter(hh_species_consumed %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(hh_daily_intake_per_fish_per_lake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_hh_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE)),
      num_households = n_distinct(fisherID)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh_hh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
hh_lakes_summary_table <- bind_rows(summary_tables)
hh_lakes_summary_table <- hh_lakes_summary_table %>%
  filter(complete.cases(median))

##Check output
hh_lakes_summary_table_check <- hh_lakes_summary_table %>%
  mutate(updated_lake_name = lakes)
length(unique(hh_lakes_summary_table$lakes))
Check<- anti_join(hh_consumers_species_long_adv, hh_lakes_summary_table_check, by = "updated_lake_name")

# Rearrange rows for export
hh_lakes_summary_table <- hh_lakes_summary_table %>%
  mutate(
    sort_order = ifelse(lakes == "Unknown", 1, 0)  # Assign 1 to "Unknown" and 0 to all others
  ) %>%
  arrange(sort_order, lakes) %>%  # Sort by the helper column and then alphabetically by "lakes"
  select(-sort_order)# Remove the helper column

# Add county information 

#create dataframe with county information
hh_county_key <- hh_consumers_species_long_adv %>%
  select(updated_lake_name, county) %>%
  mutate(lakes = updated_lake_name) %>%
  select(-updated_lake_name) %>%
  distinct(lakes, .keep_all = TRUE)  # Keep only unique rows based on "lakes"

hh_lakes_summary_table_export <-left_join(hh_lakes_summary_table,hh_county_key, by = "lakes")
hh_lakes_summary_table_export <- hh_lakes_summary_table_export %>%
  select(county,lakes,num_households, everything())


# Write to CSV
write.csv(hh_lakes_summary_table_export, "hh_consumption_summary.csv", row.names = FALSE)



```

##Age histogram

```{r ,include=FALSE}

##This code chunk creates histograms of fishers & individual consumers

summary(fisherdb$Age_numeric)
summary(as.factor(fisherdb$Observed_Gender))
age_check <- fisherdb %>% select(Age, Age_numeric)
rm(age_check)
#Histogram of all fishers regardless of whether they consume fish
fisher_hist <-ggplot(fisherdb, aes(x = Age_numeric, fill = Observed_Gender)) +
  geom_histogram(binwidth = 10, color = "#000000") +
  labs(
    title = "",
    x = "Age",
    y = "Number of consumers",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#ff8900","#15607a","gray"))+
  scale_x_continuous(limits=c(0,100),breaks = seq(0,100, by = 10))+
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "top",)

fisher_hist

Legg <- fisherdb %>% filter(Location == "Legg")
Alondra <- fisherdb %>% filter(Location == "Alondra")
Peck <- fisherdb %>% filter(Location == "Peck Road")
Magic_Johnson <- fisherdb %>% filter(Location == "Magic Johnson")

summary(fisherdb$Age_numeric)
summary(Legg$Age_numeric)
summary(Alondra$Age_numeric)
summary(Peck$Age_numeric)
summary(Magic_Johnson$Age_numeric)


# Checks that each rowID has only ONE unique Age_numeric and ONE unique Observed_Gender value
check_consistency <- consumers_long %>%
  group_by(rowID) %>%
  summarise(
    Age_numeric_unique = n_distinct(Age_numeric),  # Count distinct Age_numeric values
    Observed_Gender_unique = n_distinct(Observed_Gender),  # Count distinct Observed_Gender values
    .groups = "drop"
  ) %>%
  filter(Age_numeric_unique > 1 | Observed_Gender_unique > 1)  # Identify inconsistencies

# View rows with inconsistencies
print(check_consistency)
all(check_consistency$n == 0) #returns true if all groups are consistent

 ##histogram of age/gender of fishers who consume fish ##39 unique individuals
fish_consumers <- consumers_long %>%
  filter(updated_lake_name %in% c("Alondra park", "Legg lake", "Peck Road")) %>%
  group_by(rowID) %>%
  summarise(Age_numeric = first(Age_numeric), Observed_Gender = first(Observed_Gender)) %>%
  ungroup()
##Histogram of all fishers who consume fish
fisher_consumer_hist <- ggplot(fish_consumers, aes(x = Age_numeric, fill = Observed_Gender)) +
  geom_histogram(binwidth = 10, boundary = 0, color = "black") +
  labs(
    title = "",
    x = "Age",
    y = "Number of consumers",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#ff8900","#15607a"))+
  scale_y_continuous(limits=c(0,10), breaks = seq(0,10, by =2))+
  scale_x_continuous(limits=c(0,100),breaks = seq(0,100, by = 10))+
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "bottom",)

fisher_consumer_hist

##histogram age/gender household (hh) members ##68 unique individuals
length(unique(hh_consumers_species_long_adv$hh_consumerID))

hh_age <- hh_consumers_species_long_adv %>%
  mutate(across(c(hh_gender_original),as.factor))%>%
  filter(updated_lake_name %in% c("Alondra park", "Legg lake", "Peck Road")) %>%
  group_by(fisherID, household_member,hh_age,hh_gender_original)%>%
  summarize(sum(hh_daily_intake_per_fish_per_lake))%>%
  ungroup()

# Checks for duplicate rows based on fisherID and household_member
duplicate_check <- hh_age %>%
  group_by(fisherID, household_member) %>%
  filter(n() > 1) %>%  # Filter groups with more than 1 row
  ungroup()
rm(duplicate_check)

levels(hh_age$hh_gender_original)

hh_hist <-ggplot(hh_age, aes(x = hh_age, fill = hh_gender_original)) +
  geom_histogram(binwidth = 10, boundary = 0, color = "black") +
  labs(
    title = "",
    x = "Age",
    y = "Number of consumers",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#ff8900","#15607a","gray"))+
  scale_y_continuous(limits=c(0,10), breaks = seq(0,10, by =2))+
  scale_x_continuous(limits=c(0,100),breaks = seq(0,100, by = 10) ) +
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "bottom")

hh_hist

####Export

stacked_hist <- fisher_consumer_hist + 
  ggtitle("Fishers") + 
  hh_hist + 
  ggtitle("Household") + 
  plot_layout(ncol = 1)  # Stack vertically

# Print the combined plot
stacked_hist

plot_height <- 1800
plot_width <- 1700

ggsave(
  filename = "age_histogram.svg",
  plot = stacked_hist, width = plot_width, height = plot_height, units = "px", dpi = 300
)

```
#Why not eating fish
```{r ,include=FALSE}
##This is an analysis of the reasons fishers gave for not wanting to eat fish at the lakes surveyed
# Subset all columns that end with "_why"
# The total is lower here because (338 instead of 480) because: 
# 62 did not provide any details about fish - many were new to fishing and had not caught anything
# 23 surveys were conducted in January before the question was added
# 45 said they planned to eat the fish and therefore providing a reason was unneccessary
# 12 missed the question / did not provide a reason

reasons_not_eating <- fisherdb %>%
  select(Location, ends_with("_why"))%>%
  mutate(
    fisherID = row_number(),
    Combined_Responses = apply(.[, 1:16], 1, function(row) {
      # Combine responses, remove NAs and "NA"
      combined = paste(row[!is.na(row) & row != "NA"], collapse = ", ")
      # Remove duplicates by splitting, deduplicating
      unique_responses = unique(str_trim(str_split(combined, ",\\s*")[[1]]))
      paste(unique_responses, collapse = ", ")
    })
  ) %>%
  filter(Combined_Responses != "") %>%
  select(fisherID, Combined_Responses) %>%
  separate_rows(Combined_Responses, sep = ",\\s*") %>%
  group_by(fisherID)%>%
  mutate(Response_Column = paste0("Response_", row_number()))  %>%
  pivot_wider(names_from = Response_Column, values_from = Combined_Responses)%>%
  ungroup() %>%
  mutate(across(everything(), as.character)) %>% # Ensure compatibility with case_when
  mutate(
    across(everything(), ~ case_when(
      . == "hobby" ~ "Hobby",
      . == "Water Quality" ~ "Water quality",
      . == "water quality" ~ "Water quality",
      . == "population" ~ "Population",
      . == "size" ~ "Size",
      . == "preference" ~ "Preference",
      . == "Water quality (Peck Road)" ~ "Water quality",
      . == "No Answer" ~ NA,
      . == "Unknown" ~ NA,
      . == "Not surveyed" ~ NA,
      . == "No answer" ~ NA,
      TRUE ~ .  # Keep other values unchanged
    ))
  )%>%
  mutate(
    Location = Response_1
  )%>%
  select(-Response_1)%>%
  rename(
    Response_1 = Response_2,
    Response_2 = Response_3,
    Response_3 = Response_4,
    Response_4 = Response_5,
    Response_5 = Response_6,
    Response_6 = Response_7,
  )

##Inspect respondents who did not provide an answer
no_reason <- fisherdb %>%
  mutate(
    across(ends_with("_why"), ~ case_when(
      . == "hobby" ~ "Hobby",
      . == "Water Quality" ~ "Water quality",
      . == "water quality" ~ "Water quality",
      . == "population" ~ "Population",
      . == "size" ~ "Size",
      . == "preference" ~ "Preference",
      . == "Water quality (Peck Road)" ~ "Water quality",
      . == "No Answer" ~ NA,
      . == "Unknown" ~ NA,
      . == "Not surveyed" ~ NA,
      . == "No answer" ~ NA,
      TRUE ~ .  # Keep other values unchanged
    )
    ))

#Convert to long format
reasons_not_eating_long <- reasons_not_eating %>%
  pivot_longer(
    cols = Response_1:Response_6,
    names_to = "num",
    values_to = "response"
  )
summary(as.factor(reasons_not_eating_long$response))
#2399 NAs
#Dataframe length should be 481 after NAs are removed

#Remove NAs
reasons_not_eating_long <- reasons_not_eating_long %>%
   filter(!is.na(response))

summary(as.factor(reasons_not_eating_long$response))

##Compress answers so that not duplicate answers for each fisher
##Then calculate % response based on the number of unique fishers across all lakes
reasons_not_eating_long <- reasons_not_eating_long %>%
  group_by(fisherID,Location)%>%
  summarize(
    unique_responses = paste(unique(response), collapse = ", ")
  )%>%
  ungroup()%>%
  separate_rows(unique_responses, sep = ",\\s*")

summary(as.factor(reasons_not_eating_long$unique_responses))
num_fishers <- n_distinct(reasons_not_eating_long$fisherID)

##Calculate n & percent of each response across all lakes

reasons_count <- reasons_not_eating_long %>%
  count(unique_responses, name = "reasons_count")%>%
  arrange(desc(reasons_count))%>%
  mutate(
    "reasons_percent" = round((reasons_count/num_fishers)*100,1)
  )

##Analyze each lake individually
summary(as.factor(reasons_not_eating_long$Location))

###Alondra Park Lake = 78 records

Alondra_reasons_not_eating_long <- reasons_not_eating_long %>%
  filter(Location == "Alondra")

summary(as.factor(Alondra_reasons_not_eating_long$unique_responses))
Alondra_num_fishers <- n_distinct(Alondra_reasons_not_eating_long$fisherID)

Alondra_reasons_count <- Alondra_reasons_not_eating_long %>%
  count(unique_responses, name = "reasons_count")%>%
  arrange(desc(reasons_count))%>%
  mutate(
    "reasons_percent" = round((reasons_count/Alondra_num_fishers)*100,1)
  )

###Legg Lake = 244 records
Legg_reasons_not_eating_long <- reasons_not_eating_long %>%
  filter(Location == "Legg")

summary(as.factor(Legg_reasons_not_eating_long$unique_responses))
Legg_num_fishers <- n_distinct(Legg_reasons_not_eating_long$fisherID)

Legg_reasons_count <- Legg_reasons_not_eating_long %>%
  count(unique_responses, name = "reasons_count")%>%
  arrange(desc(reasons_count))%>%
  mutate(
    "reasons_percent" = round((reasons_count/Legg_num_fishers)*100,1)
  )

###Peck Road Park Lake  = 100 records
Peck_Road_reasons_not_eating_long <- reasons_not_eating_long %>%
  filter(Location == "Peck Road")

summary(as.factor(Peck_Road_reasons_not_eating_long$unique_responses))
Peck_Road_num_fishers <- n_distinct(Peck_Road_reasons_not_eating_long$fisherID)

Peck_Road_reasons_count <- Peck_Road_reasons_not_eating_long %>%
  count(unique_responses, name = "reasons_count")%>%
  arrange(desc(reasons_count))%>%
  mutate(
    "reasons_percent" = round((reasons_count/Peck_Road_num_fishers)*100,1)
  )

### Magic Johnson = 31 records
MJ_reasons_not_eating_long <- reasons_not_eating_long %>%
  filter(Location == "Magic Johnson")

summary(as.factor(MJ_reasons_not_eating_long$unique_responses))
MJ_num_fishers <- n_distinct(MJ_reasons_not_eating_long$fisherID)

MJ_reasons_count <- MJ_reasons_not_eating_long %>%
  count(unique_responses, name = "reasons_count")%>%
  arrange(desc(reasons_count))%>%
  mutate(
    "reasons_percent" = round((reasons_count/MJ_num_fishers)*100,1)
  )


##Export analysis
write.csv(Legg_reasons_count, "Legg_reasons.csv", row.names = FALSE)
write.csv(Alondra_reasons_count, "Alondra_reasons.csv", row.names = FALSE)
write.csv(Peck_Road_reasons_count, "Peck_reasons.csv", row.names = FALSE)
write.csv(MJ_reasons_count, "MJ_reasons.csv", row.names = FALSE)


```


#WQ question
```{r ,include=FALSE}
##This analysis is of fishers who said they did not eat fish at the lakes surveyed due to water quality concerns. 

colnames(fisherdb)
summary(as.factor(fisherdb$`If_State_addressed_concerns,_would_you_eat_fish?`))

wq_q <- fisherdb %>%
  mutate(`If_State_addressed_concerns,_would_you_eat_fish?`= case_when(
    `If_State_addressed_concerns,_would_you_eat_fish?`== "Na" ~ NA_character_,
    `If_State_addressed_concerns,_would_you_eat_fish?`== "NA" ~ NA_character_,
    TRUE ~ `If_State_addressed_concerns,_would_you_eat_fish?`
  ))

summary(as.factor(wq_q$`If_State_addressed_concerns,_would_you_eat_fish?`))

## 77 fishers surveyed across 4 lakes
##subset to fishers who answered question 
##Expect 77 obs after filtering
wq_q <- wq_q %>%
  filter(
    `If_State_addressed_concerns,_would_you_eat_fish?`== "Yes"|
      `If_State_addressed_concerns,_would_you_eat_fish?`== "No"|
      `If_State_addressed_concerns,_would_you_eat_fish?`== "Maybe"
  )
summary(as.factor((wq_q$Location)))

# Filter data and calculate percentages for each location
percent_table <- wq_q %>%
  filter(
    `If_State_addressed_concerns,_would_you_eat_fish?` %in% c("Yes", "No", "Maybe"),
    Location %in% c("Alondra", "Legg", "Magic Johnson", "Peck Road")
  ) %>%
  group_by(Location, `If_State_addressed_concerns,_would_you_eat_fish?`) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(Location) %>%
  mutate(percent = round((count / sum(count)) * 100, 2)) %>%
  ungroup()

# Reshape the table to wide format for readability
percent_table_wide <- percent_table %>%
  pivot_wider(
    names_from = `If_State_addressed_concerns,_would_you_eat_fish?`,
    values_from = percent,
    values_fill = 0
  )

location_summary <- wq_q %>%
  filter(
    `If_State_addressed_concerns,_would_you_eat_fish?` %in% c("Yes", "No", "Maybe"),
    Location %in% c("Alondra", "Legg", "Magic Johnson", "Peck Road")
  ) %>%
  group_by(Location, `If_State_addressed_concerns,_would_you_eat_fish?`) %>%
  summarise(count = n(), .groups = "drop") %>%
  pivot_wider(
    names_from = `If_State_addressed_concerns,_would_you_eat_fish?`,
    values_from = count,
    values_fill = 0
  ) %>%
  mutate(
    total_count = Yes + No + Maybe  # Calculate total count for each location
  )%>%
  mutate(
    percent_No = round((No/total_count*100),0),
    percent_Yes = round((Yes/total_count*100),0),
    percent_Maybe = round((Maybe/total_count*100),0),
    check = percent_No+percent_Yes+percent_Maybe
  )

```

##Parts of fish consumed
```{r ,include=FALSE}

##Use consumers dataframe to look at what parts of fish they are consuming
##Dataframe "parts_consumed" is created from "consumers_long" 
parts_consumed <- consumers_long
# Perform the transformation
parts_consumed <- parts_consumed %>%
  mutate(
    times_eaten = case_when(
      Catches_Info == "Rainbow trout" ~ as.numeric(`Past_catches:_Rainbow_Trout,_times_eaten_numeric`),
      Catches_Info == "Catfish" ~ as.numeric(`Past_catches:_Catfish,_times_eaten_numeric`),
      Catches_Info == "Sunfish species" ~ as.numeric(`Past_catches:_Bluegill,_times_eaten_numeric`),
      Catches_Info == "Common carp" ~ as.numeric(`Past_catches:_Common_Carp,_times_eaten_numeric`),
      Catches_Info == "Black bass species" ~ as.numeric(`Past_catches:_Bass,_times_eaten_numeric`),
      Catches_Info == "Crappie" ~ as.numeric(`Past_catches:_Crappie,_times_eaten_numeric`),
      Catches_Info == "Tilapia" ~ as.numeric(`Past_catches:_Tilapia,_times_eaten_numeric`),
      Catches_Info == "Striped bass" ~ as.numeric(`Past_catches:_other,_times_eaten_numeric`),
      TRUE ~ NA_real_  # Use NA_real_ for numeric NA
    ),
    parts_eaten = case_when(
      Catches_Info == "Rainbow trout" ~ as.character(`Past_catches:_Rainbow_Trout,_parts_eaten`),
      Catches_Info == "Catfish" ~ as.character(`Past_catches:_Catfish,_parts_eaten`),
      Catches_Info == "Sunfish species" ~ as.character(`Past_catches:_Bluegill,_parts_eaten`),
      Catches_Info == "Common carp" ~ as.character(`Past_catches:_Common_Carp,_parts_eaten`),
      Catches_Info == "Black bass species" ~ as.character(`Past_catches:_Bass,_parts_eaten`),
      Catches_Info == "Crappie" ~ as.character(`Past_catches:_Crappie,_parts_eaten`),
      Catches_Info == "Tilapia" ~ as.character(`Past_catches:_Tilapia,_parts_eaten`),
      Catches_Info == "Striped bass" ~ as.character(`Past_catches:_other,_parts_eaten`),
      TRUE ~ NA_character_  # Use NA_character_ for character NA
    )
  )
# Checks for mismatched rows where times_eaten or parts_eaten is NA
missing_matches <- parts_consumed %>%
  filter(Catches_Info %in% c("Rainbow trout", "Catfish", "Bluegill", "Common Carp", "Bass", "Crappie", "Tilapia", "Other") &
           (is.na(times_eaten) | is.na(parts_eaten)))

# Print mismatched rows
print(paste("Number of rows with missing times_eaten or parts_eaten:", nrow(missing_matches)))

rt_check <- parts_consumed %>% 
  filter (Catches_Info == "Rainbow trout") %>%
  select("rowID", "Catches_Info", "Past_catches:_Rainbow_Trout,_times_eaten_numeric","times_eaten",
        "Past_catches:_Rainbow_Trout,_parts_eaten", "parts_eaten")
bass_check <- parts_consumed %>% 
  filter (Catches_Info == "Black bass species") %>%
  select("rowID", "Catches_Info", "Past_catches:_Bass,_times_eaten_numeric","times_eaten",
        "Past_catches:_Bass,_parts_eaten", "parts_eaten")
catfish_check <- parts_consumed %>% 
  filter (Catches_Info == "Catfish") %>%
  select("rowID", "Catches_Info", "Past_catches:_Catfish,_times_eaten_numeric","times_eaten",
        "Past_catches:_Catfish,_parts_eaten", "parts_eaten")
carp_check <- parts_consumed %>% 
  filter (Catches_Info == "Common carp") %>%
  select("rowID", "Catches_Info", "Past_catches:_Common_Carp,_times_eaten_numeric","times_eaten",
        "Past_catches:_Common_Carp,_parts_eaten", "parts_eaten")
crappie_check <- parts_consumed %>% 
  filter (Catches_Info == "Crappie") %>%
  select("rowID", "Catches_Info", "Past_catches:_Crappie,_times_eaten_numeric","times_eaten",
        "Past_catches:_Crappie,_parts_eaten", "parts_eaten")
striped_bass_check <- parts_consumed %>% 
  filter (Catches_Info == "Striped bass") %>%
  select("rowID", "Catches_Info", "Past_catches:_other,_times_eaten_numeric","times_eaten",
        "Past_catches:_other,_parts_eaten", "parts_eaten")
sunfish_check <- parts_consumed %>% 
  filter (Catches_Info == "Sunfish species") %>%
  select("rowID", "Catches_Info", "Past_catches:_Bluegill,_times_eaten_numeric","times_eaten",
        "Past_catches:_Bluegill,_parts_eaten", "parts_eaten")

write.csv(parts_consumed, "parts_consumed.csv", row.names = FALSE)
###

parts_consumed_sub <- parts_consumed %>%
  select("rowID","Age_numeric", "Observed_Gender", "Catches_Info", 
         "updated_lake_name", "county","times_eaten", "parts_eaten",
         "Annual_Household_Income","Number_in_household", "Ethnicity", "daily_intake", "number_lakes", 
         "daily_intake_per_lake","Age_Category","column", "threshold_g_day","threshold_used",  
         "OEHHA_fish_names" ,"avg_threshold", "exceed_threshold_indiv_lake", "exceed_threshold_avg_lake"
 )%>%
   mutate(
    parts_eaten = case_when(
      parts_eaten == "Fillet w/ skin consumed" ~ "Fillet w/ skin consumed",
      parts_eaten == "Fillet w/o skin consumed" ~ "Fillet w/o skin consumed",
      parts_eaten == "Fillet w/skin consumed" ~ "Fillet w/ skin consumed",
      parts_eaten == "Unknown" ~ NA,
      TRUE ~ parts_eaten
  ))

summary(as.factor(parts_consumed_sub$parts_eaten))

###Summary stats by lake
# Define lake names
lakes <- list(
  "All_Surveyed" = c("Alondra park", "Legg lake", "Peck Road", "Magic Johnson Lakes"),
  "Alondra park" = "Alondra park",
  "Legg lake" = "Legg lake",
  "Peck Road" = "Peck Road",
  "Magic Johnson Lakes" = "Magic Johnson Lakes"
)

###TEST
# Define the list of lakes
lakes <- list(
  "All_Surveyed" = c("Alondra park", "Legg lake", "Peck Road", "Magic Johnson Lakes"),
  "Alondra park" = "Alondra park",
  "Legg lake" = "Legg lake",
  "Peck Road" = "Peck Road",
  "Magic Johnson Lakes" = "Magic Johnson Lakes"
)

# Initialize an empty list to store results
results <- list()

# Loop through each lake
for (lake_name in names(lakes)) {
  selected_lakes <- lakes[[lake_name]]  # Get the lake(s) for the current iteration
  
  # Filter data for the selected lake(s)
  lake_parts_consumed <- parts_consumed_sub %>%
    filter(updated_lake_name %in% selected_lakes)
  
  # Count unique rowIDs
  unique_rowID_count <- length(unique(lake_parts_consumed$rowID))
  
  # Pivot data to wide format and calculate all_fillet_wo_skin
  lake_parts_wide <- lake_parts_consumed %>%
    pivot_wider(
      id_cols = rowID, 
      names_from = Catches_Info, 
      values_from = c(parts_eaten)#,
       #values_fn = first  # Take the first value for duplicates
    ) %>%
    rowwise() %>%
    mutate(
      all_fillet_wo_skin = all(
        c_across(-rowID) %in% c("Fillet w/o skin consumed", NA)
      )
    ) %>%
    ungroup()
  
  # Calculate summary statistics
  summary_stats <- lake_parts_wide %>%
    summarize(
      total_false = sum(!all_fillet_wo_skin),                     # Count of FALSE values
      percent_false = mean(!all_fillet_wo_skin, na.rm = TRUE) * 100  # Percentage of FALSE values
    )
  
  # Combine results into a single row for this lake
  result <- data.frame(
    lake_name = lake_name,
    unique_rowID_count = unique_rowID_count,
    total_false = summary_stats$total_false,
    percent_false = round(summary_stats$percent_false, 0)
  )
  
  # Append result to the list
  results[[lake_name]] <- result
}

# Combine all results into a single dataframe
lake_results_df <- do.call(rbind, results)

# View the results
print(lake_results_df)

#lakes <- c("Alondra park", "Legg lake", "Peck Road")

# Create a function to perform the analysis for a given lake
analyze_lake <- function(lake_name, data) {
  # Filter data for the lake
  lake_parts_consumed <- data %>%
    filter(updated_lake_name %in% lake_name)
  
  # Count unique rowIDs
  unique_rowID_count <- length(unique(lake_parts_consumed$rowID))
  
  # Pivot data to wide format and calculate all_fillet_wo_skin
  lake_parts_wide <- lake_parts_consumed %>%
    pivot_wider(
      id_cols = rowID, 
      names_from = Catches_Info, 
      values_from = c(parts_eaten)
    ) %>%
    rowwise() %>%
    mutate(
      all_fillet_wo_skin = all(
        c_across(-rowID) %in% c("Fillet w/o skin consumed", NA)
      )
    ) %>%
    ungroup()
  
  # Calculate summary statistics
  summary_stats <- lake_parts_wide %>%
    summarize(
      total_false = sum(!all_fillet_wo_skin),                     # Count of FALSE values
      percent_false = mean(!all_fillet_wo_skin) * 100            # Percentage of FALSE values
    )
  
  # Combine results into a single row for this lake
  result <- data.frame(
    lake_name = lake_name,
    unique_rowID_count = unique_rowID_count,
    total_false = summary_stats$total_false,
    percent_false = round(summary_stats$percent_false, 0)
  )
  
  return(result)
}

lake_results_df <- do.call(
  rbind, 
  lapply(lakes, function(lake) analyze_lake(lake, data = parts_consumed_sub))
)


# Apply the analysis to all lakes and combine the results into a single dataframe
lake_results_df <- do.call(rbind, lapply(lakes, analyze_lake, data = parts_consumed_sub))

# Print the final results dataframe
print(lake_results_df)

```
##Cooking methods used
```{r ,include=FALSE}

##Uses consumers dataframe to look at how fishers are preparing fish
cooking_methods <- consumers_long
# Perform the transformation
cooking_methods <- cooking_methods %>%
  mutate(
    times_eaten = case_when(
      Catches_Info == "Rainbow trout" ~ as.numeric(`Past_catches:_Rainbow_Trout,_times_eaten_numeric`),
      Catches_Info == "Catfish" ~ as.numeric(`Past_catches:_Catfish,_times_eaten_numeric`),
      Catches_Info == "Sunfish species" ~ as.numeric(`Past_catches:_Bluegill,_times_eaten_numeric`),
      Catches_Info == "Common carp" ~ as.numeric(`Past_catches:_Common_Carp,_times_eaten_numeric`),
      Catches_Info == "Black bass species" ~ as.numeric(`Past_catches:_Bass,_times_eaten_numeric`),
      Catches_Info == "Crappie" ~ as.numeric(`Past_catches:_Crappie,_times_eaten_numeric`),
      Catches_Info == "Tilapia" ~ as.numeric(`Past_catches:_Tilapia,_times_eaten_numeric`),
      Catches_Info == "Striped bass" ~ as.numeric(`Past_catches:_other,_times_eaten_numeric`),
      TRUE ~ NA_real_  # Use NA_real_ for numeric NA
    ),
    cooking_method = case_when(
      Catches_Info == "Rainbow trout" ~ as.character(`Past_catches:_Rainbow_Trout,_cooking_method`),
      Catches_Info == "Catfish" ~ as.character(`Past_catches:_Catfish,_cooking_method`),
      Catches_Info == "Sunfish species" ~ as.character(`Past_catches:_Bluegill,_cooking_method`),
      Catches_Info == "Common carp" ~ as.character(`Past_catches:_Common_Carp,_cooking_method`),
      Catches_Info == "Black bass species" ~ as.character(`Past_catches:_Bass,_cooking_method`),
      Catches_Info == "Crappie" ~ as.character(`Past_catches:_Crappie,_cooking_method`),
      Catches_Info == "Tilapia" ~ as.character(`Past_catches:_Tilapia,_cooking_method`),
      Catches_Info == "Striped bass" ~ as.character(`Past_catches:_other,_cooking_method`),
      TRUE ~ NA_character_  # Use NA_character_ for character NA
    )
  )
# Check for mismatched rows where times_eaten or parts_eaten is NA
missing_matches <- cooking_methods %>%
  filter(Catches_Info %in% c("Rainbow trout", "Catfish", "Bluegill", "Common Carp", "Bass", "Crappie", "Tilapia", "Other") &
           (is.na(times_eaten) | is.na(cooking_method)))
# Print mismatched rows
print(paste("Number of rows with missing times_eaten or parts_eaten:", nrow(missing_matches)))
rm(missing_matches)

summary(as.factor(cooking_methods$Catches_Info))

rt_check <- cooking_methods %>% 
  filter (Catches_Info == "Rainbow trout") %>%
  select("rowID", "Catches_Info", "Past_catches:_Rainbow_Trout,_times_eaten_numeric","times_eaten",
        "Past_catches:_Rainbow_Trout,_cooking_method", "cooking_method")
bass_check <- cooking_methods %>% 
  filter (Catches_Info == "Black bass species") %>%
  select("rowID", "Catches_Info", "Past_catches:_Bass,_times_eaten_numeric","times_eaten",
        "Past_catches:_Bass,_cooking_method", "cooking_method")
catfish_check <- cooking_methods %>% 
  filter (Catches_Info == "Catfish") %>%
  select("rowID", "Catches_Info", "Past_catches:_Catfish,_times_eaten_numeric","times_eaten",
        "Past_catches:_Catfish,_cooking_method", "cooking_method")
carp_check <- cooking_methods %>% 
  filter (Catches_Info == "Common carp") %>%
  select("rowID", "Catches_Info", "Past_catches:_Common_Carp,_times_eaten_numeric","times_eaten",
        "Past_catches:_Common_Carp,_cooking_method", "cooking_method")
crappie_check <- cooking_methods %>% 
  filter (Catches_Info == "Crappie") %>%
  select("rowID", "Catches_Info", "Past_catches:_Crappie,_times_eaten_numeric","times_eaten",
        "Past_catches:_Crappie,_cooking_method", "cooking_method")
striped_bass_check <- cooking_methods %>% 
  filter (Catches_Info == "Striped bass") %>%
  select("rowID", "Catches_Info", "Past_catches:_other,_times_eaten_numeric","times_eaten",
        "Past_catches:_other,_cooking_method", "cooking_method")
sunfish_check <- cooking_methods %>% 
  filter (Catches_Info == "Sunfish species") %>%
  select("rowID", "Catches_Info", "Past_catches:_Bluegill,_times_eaten_numeric","times_eaten",
        "Past_catches:_Bluegill,_cooking_method", "cooking_method")
rm(rt_check, bass_check,catfish_check,carp_check,crappie_check,striped_bass_check,sunfish_check)

cooking_methods_sub <- cooking_methods %>%
  select("rowID","Age_numeric", "Observed_Gender", "Catches_Info", 
         "updated_lake_name", "county","times_eaten", "cooking_method",
         "Annual_Household_Income","Number_in_household", "Ethnicity", "daily_intake", "number_lakes", 
         "daily_intake_per_lake","Age_Category","column", "threshold_g_day","threshold_used",  
         "OEHHA_fish_names" ,"avg_threshold", "exceed_threshold_indiv_lake", "exceed_threshold_avg_lake"
 )

#Separated out comma separated cooking methods and converting into a long format
# Convert comma-separated values in the "cooking_method" column to long format
cooking_methods_long <- cooking_methods_sub %>%
  separate_rows(cooking_method, sep = ",") %>%
  mutate(cooking_method = trimws(cooking_method))%>%
  mutate(cooking_method = case_when(
    cooking_method == "Grill" ~ "Grilled",
    cooking_method == "pan fried" ~ "Pan fried",
    cooking_method == "Pan Fried" ~ "Pan fried",
    TRUE ~ cooking_method
  ))
summary(as.factor(cooking_methods_long$cooking_method))

write.csv(cooking_methods_long, "cooking_methods_long.csv", row.names = FALSE)

lakes <- c("Alondra park", "Legg lake", "Peck Road")
# Initialize an empty list to store results
cooking_method_counts_list <- list()
total_people_list <- list()  # To store total people for each lake

# For loop to process each lake individually
for (lake_name in lakes) {
  
   cooking_method_counts <- cooking_methods_long %>% 
    filter(updated_lake_name == lake_name)%>%# Filter for the current lake
    distinct(rowID, cooking_method)%>%
    group_by(cooking_method) %>%  # Group by cooking method
    summarise(count = n(), .groups = "drop")  # Count occurrences
  
  # # Filter, separate rows, and count cooking methods for the current lake
  # cooking_method_counts <- cooking_methods_long %>%
  #   filter(updated_lake_name == lake_name) %>%  # Filter for the current lake
  #   group_by(cooking_method) %>%  # Group by cooking method
  #   summarise(count = n(), .groups = "drop")  # Count occurrences
  
  #calculate total number of people at the lake
    total_people_df <- cooking_methods_long %>% filter(updated_lake_name == lake_name)
    total_people <- length(unique(total_people_df$rowID))
     total_people_list[[lake_name]] <- total_people  # Store total people for the lake
    
  # Add lake information to the result
 # Add lake information and calculate percentage
  cooking_method_counts <- cooking_method_counts %>%
    mutate(
      lake = lake_name,
      percent = round((count / total_people) * 100, 0)  # Calculate percentage
    )
  
  # Append to the list
  cooking_method_counts_list[[lake_name]] <- cooking_method_counts
}

# Combine results from all lakes into a single dataframe
cooking_method_counts_combined <- bind_rows(cooking_method_counts_list)

write.csv(cooking_method_counts_combined, "cooking_methods.csv", row.names = FALSE)

##Total number of people in total_people_list should be 25 @Legg, 15@Alondra, 3@Peck
cooking_methods_long_x_lake <- cooking_methods_long %>%
    filter(updated_lake_name == "Alondra park") %>%  # Filter for the current lake
    distinct(rowID, cooking_method)  # Ensure each cooking method is counted once per rowID
    length(unique(cooking_methods_long_x_lake$rowID))

```

##Fish consumption by income regression analysis

```{r ,include=FALSE}
Surveyed_lakes_reported_income <- consumers_long %>%
  filter(updated_lake_name %in% c("Alondra park", "Legg lake", "Peck Road"))%>%
  distinct(rowID, .keep_all = TRUE)

  summary(as.factor(Surveyed_lakes_reported_income$Annual_Household_Income))

##This chunk of code is for regression analysis (finding middle of income range).
consumers_x_income <- consumers_long%>%
   separate(Annual_Household_Income, into = c("low_end_income", "high_end_income"), sep = "-", fill = "right", remove=FALSE) %>%
 filter(!low_end_income %in% c("No answer","Unknown")) %>%
  filter(!high_end_income %in% c("No answer","Unknown"))%>%
  mutate(
    low_end_income = str_replace_all(low_end_income, ",", ""),
    low_end_income = case_when(
    low_end_income == "200000+" ~ "200000",
    TRUE ~ low_end_income),
    low_end_income = as.numeric(low_end_income)) %>%
mutate(
    high_end_income = str_replace_all(high_end_income, ",", ""),
    high_end_income = case_when(
    Annual_Household_Income=="200,000+" ~ "200000",
    TRUE ~ high_end_income),
    high_end_income = as.numeric(high_end_income)) %>%
mutate(Number_in_household = as.numeric(Number_in_household))%>%
mutate(avg_income = (high_end_income + low_end_income) / 2)%>%
mutate(avg_income_norm = avg_income/Number_in_household) %>%
  group_by(rowID)%>%
  mutate(total_daily_intake = sum(daily_intake))%>%
  ungroup()

#filter for surveyed lakes
consumers_x_income <- consumers_x_income %>%
filter(updated_lake_name %in% c("Alondra park", "Legg lake", "Peck Road"))

#count unique rowIDs
unique_rowID_count <- consumers_x_income %>%
  summarise(unique_rowIDs = n_distinct(rowID)) %>%
  pull(unique_rowIDs)

#remove duplicate row IDs
consumers_x_income <- consumers_x_income %>%
  distinct(rowID, .keep_all = TRUE)%>%
  filter(Annual_Household_Income != "Prefer not to say")

#write.csv(consumers_x_income, "consumer_x_income.csv", row.names = FALSE)

ggplot(consumers_x_income, aes(x=(avg_income), y=log(total_daily_intake)))+
  geom_jitter()+
  geom_smooth(method= "lm", color="red")+
  stat_regline_equation()+
  theme(panel.grid = element_blank())

# Fit a linear model to the log-transformed data
model <- lm(log(total_daily_intake) ~ (avg_income), data = consumers_x_income)

# Summary of the model to extract p-value and other statistics
summary(model)

##Regression of frequency of fish consumption x income

income_x_freq <- consumers_x_income %>%
  mutate(freq_consump = rowSums(select(., 
    `Past_catches:_Rainbow_Trout,_times_eaten_numeric`,
    `Past_catches:_Catfish,_times_eaten_numeric`,
    `Past_catches:_Bluegill,_times_eaten_numeric`,
    `Past_catches:_Common_Carp,_times_eaten_numeric`,
    `Past_catches:_Bass,_times_eaten_numeric`,
    `Past_catches:_Crappie,_times_eaten_numeric`,
    `Past_catches:_Tilapia,_times_eaten_numeric`,
    `Past_catches:_other,_times_eaten_numeric`
  ), na.rm = TRUE))

ggplot(income_x_freq, aes(x=(avg_income), y=(freq_consump)))+
  geom_jitter()+
  geom_smooth(method= "lm", color="red")+
  stat_regline_equation()+
  theme(panel.grid = element_blank())

# Fit a linear model to the log-transformed data
model <- lm((freq_consump) ~ (avg_income), data = income_x_freq)

# Summary of the model to extract p-value and other statistics
summary(model)


```
##Fish consumption by income 
```{r}
#Code which outputs summary statistics of fish consumption by income
### leaving income ranges as is:
summary(as.factor(consumers_long$Annual_Household_Income))
consumer_x_income <- consumers_long %>%
  mutate(
    Annual_Household_Income = case_when(
    Annual_Household_Income == "Unknown" ~ "Not reported / unknown",
    Annual_Household_Income == "No answer" ~ "Not reported / unknown",
    Annual_Household_Income == "Prefer not to say" ~ "Not reported / unknown",
    TRUE ~ Annual_Household_Income  # Keep all other values as they are
  )
  )%>%
  mutate(Annual_Household_Income = as.factor(Annual_Household_Income))

###Loop for number of people per income per lake
# Define lakes list with "All" category
lakes <- list(
  "All" = c("Alondra park", "Legg lake", "Peck Road"),
  "Alondra park" = "Alondra park",
  "Legg lake" = "Legg lake",
  "Peck Road" = "Peck Road"
)
# Initialize empty lists to store results
income_counts_list <- list()
total_people_list <- list()

# For loop to process each lake, including the "All" category
for (lake_name in names(lakes)) {
  selected_lakes <- lakes[[lake_name]]  # Get lakes for current category
  
  # Filter data for the current lake(s)
  lake_data <- consumer_x_income %>%
    filter(updated_lake_name %in% selected_lakes)  # Use `%in%` to handle multiple lakes
  
  # Count distinct incomes for the current lake(s)
  income_counts <- lake_data %>%
    group_by(Annual_Household_Income) %>%
    summarise(count_consumers = n_distinct(rowID), .groups = "drop")
  
  # Calculate total number of consumers at the current lake(s)
  total_people <- lake_data %>%
    summarise(total_people = n_distinct(rowID)) %>%
    pull(total_people)
  
  # Store total people for the lake
  total_people_list[[lake_name]] <- total_people
  
  # Count total number of people exceeding threshold
  total_exceed_n <- lake_data %>%
    filter(exceed_threshold_indiv_lake == TRUE) %>%
    group_by(Annual_Household_Income) %>%
    summarise(exceed_count = n_distinct(rowID), .groups = "drop")
  
  # Join dataframes and handle NA
  income_counts <- full_join(income_counts, total_exceed_n, by = "Annual_Household_Income") %>%
    mutate(
      exceed_count = replace_na(exceed_count, 0)  # Replace NA with 0
    )
  
  # Summarise daily intake by income
  dailyintake_x_income <- lake_data %>%
    group_by(rowID, Annual_Household_Income, updated_lake_name) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE), .groups = "drop")
  
  consumption_rate_x_income <- dailyintake_x_income %>%
    group_by(Annual_Household_Income) %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE)),
      .groups = "drop"
    )
  
  # Join with income counts
  income_counts <- full_join(income_counts, consumption_rate_x_income, by = "Annual_Household_Income")
  
  # Add lake information and percentages
  income_counts <- income_counts %>%
    mutate(
      lake = lake_name,
      count_consumers = as.numeric(count_consumers),
      exceed_count = as.numeric(exceed_count),
      percent_consumers = round((count_consumers / total_people) * 100, 0),
      per_exceed = round((exceed_count / total_people) * 100, 0)
    )
  
  # Append to the list
  income_counts_list[[lake_name]] <- income_counts
}

# Combine all results into a single dataframe
combined_income_counts <- bind_rows(income_counts_list)

# View results
print(combined_income_counts)


##Rearrange and simplify output 
income_counts_combined <- combined_income_counts %>%
  select(lake, Annual_Household_Income,count_consumers,percent_consumers,min,max,mean,median,per_exceed, exceed_count)

write.csv(income_counts_combined, file="income_counts.csv", row.names = FALSE)

```

##Fish consumption by ethnicity
```{r ,include=FALSE}

summary(as.factor(consumers_long$Ethnicity))
consumer_x_ethnicity <- consumers_long %>%
  mutate(
    Ethnicity = case_when(
    Ethnicity == "Unknown" ~ "Not reported / unknown",
    Ethnicity == "Prefer not to say" ~ "Not reported / unknown",
    Ethnicity == "Multi: Asian or Pacific Islander, White" ~ "Multiracial",
    TRUE ~ Ethnicity  # Keep all other values as they are
  )
  )%>%
  mutate(Ethnicity = as.factor(Ethnicity))

summary(consumer_x_ethnicity$Ethnicity)

# Define lakes list with "All" category
lakes <- list(
  "All" = c("Alondra park", "Legg lake", "Peck Road"),
  "Alondra park" = "Alondra park",
  "Legg lake" = "Legg lake",
  "Peck Road" = "Peck Road"
)

# Initialize lists to store results
ethnicity_counts_list <- list()
total_people_list <- list()  # To store total people for each lake

# For loop to process each lake individually
for (lake_name in names(lakes)) {  # Use names of the lakes list
  selected_lakes <- lakes[[lake_name]]  # Extract the lake(s) for the current iteration
  
  # Filter data for the selected lake(s)
  ethnicity_counts <- consumer_x_ethnicity %>%
    filter(updated_lake_name %in% selected_lakes) %>%
    group_by(Ethnicity) %>%
    summarise(count_consumers = n_distinct(rowID), .groups = "drop")
  
  # Calculate total number of consumers at the selected lake(s)
  total_people_df <- consumer_x_ethnicity %>%
    filter(updated_lake_name %in% selected_lakes)
  total_people <- n_distinct(total_people_df$rowID)
  total_people_list[[lake_name]] <- total_people  # Store total people for the lake
  
  # Count total number of people exceeding threshold
  total_exceed_n <- consumer_x_ethnicity %>%
    filter(updated_lake_name %in% selected_lakes) %>%
    filter(exceed_threshold_indiv_lake == TRUE) %>%
    group_by(Ethnicity) %>%
    summarise(exceed_count = n_distinct(rowID), .groups = "drop")
  
  # Merge counts and exceed counts
  ethnicity_counts <- full_join(ethnicity_counts, total_exceed_n, by = "Ethnicity") %>%
    mutate(exceed_count = replace_na(exceed_count, 0))  # Replace NA with 0
  
  # Summarize daily intake by ethnicity
  dailyintake_x_ethnicity <- consumer_x_ethnicity %>%
    filter(updated_lake_name %in% selected_lakes) %>%
    group_by(rowID, Ethnicity, updated_lake_name) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE), .groups = "drop")
  
  consumption_rate_x_ethnicity <- dailyintake_x_ethnicity %>%
    group_by(Ethnicity) %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 0),
      max = round(max(total_daily_intake, na.rm = TRUE), 0),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 0),
      median = round(median(total_daily_intake, na.rm = TRUE), 0),
      .groups = "drop"
    )
  
  # Merge with ethnicity counts
  ethnicity_counts <- full_join(ethnicity_counts, consumption_rate_x_ethnicity, by = "Ethnicity")
  
  # Add lake information and percentages
  ethnicity_counts <- ethnicity_counts %>%
    mutate(
      lake = lake_name,
      count_consumers = as.numeric(count_consumers),
      exceed_count = as.numeric(exceed_count),
      total_people = total_people,
      percent_consumers = round((count_consumers / total_people) * 100, 0),
      per_exceed = round((exceed_count / total_people) * 100, 0),
      count_exceed = exceed_count
    )
  
  # Append to the list
  ethnicity_counts_list[[lake_name]] <- ethnicity_counts
}

# Combine results from all lakes into a single dataframe
ethnicity_counts_combined <- bind_rows(ethnicity_counts_list)

ethnicity_counts_combined <- ethnicity_counts_combined %>%
  mutate(per_ethnicity = round(count_consumers/total_people*100,0))%>%
  select(lake,Ethnicity,per_ethnicity, count_consumers, total_people, everything())

# View the results
print(ethnicity_counts_combined)

write.csv(ethnicity_counts_combined, file="ethnicity_counts.csv", row.names = FALSE)

```

##Subsistence fishers
```{r}

##Analysis to look at frequency at which people are consuming fish + minimum consumption amount

subsistence_consumers <- consumers_long %>%
    mutate(times_per_month = case_when(
    Catches_Info == "Rainbow trout" ~ `Past_catches:_Rainbow_Trout,_times_eaten_numeric`,
    Catches_Info == "Catfish" ~ `Past_catches:_Catfish,_times_eaten_numeric`,
    Catches_Info == "Common carp" ~ `Past_catches:_Common_Carp,_times_eaten_numeric`,
    Catches_Info == "Crappie" ~ `Past_catches:_Crappie,_times_eaten_numeric` ,
    Catches_Info == "Striped bass" ~ `Past_catches:_other,_times_eaten_numeric`,
    Catches_Info == "Tilapia" ~ `Past_catches:_Tilapia,_times_eaten_numeric`,
    Catches_Info == "Sunfish species" ~ `Past_catches:_Bluegill,_times_eaten_numeric`,
    Catches_Info == "Black bass species" ~ `Past_catches:_Bass,_times_eaten_numeric`,
    .default = NA))

write.csv(filter_subsistence_consumers, file = "subsistence_consumers.csv", row.names = FALSE)

length(unique(subsistence_consumers$rowID))


filter_subsistence_consumers <- subsistence_consumers %>%
  filter(Lakes %in% c("Alondra park", "Legg lake", "Magic Johnson Lakes", "Peck Road"), )
  

length(unique(filter_subsistence_consumers$rowID)) 

filter_subsistence_consumers <- filter_subsistence_consumers %>%
  group_by(rowID, Age_numeric, Observed_Gender, Ethnicity, Lakes, Annual_Household_Income) %>%
  summarise(
    total_daily_intake = sum(daily_intake_per_lake, na.rm = TRUE),
    times_per_month = sum(times_per_month)
  ) %>%
  ungroup()

##Looking at household information for fishers consuming at subsistence levels
sub_hh <- consumers %>%
  mutate(rowID = 1:nrow(.)) %>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = starts_with("Past_catches:") & ends_with("times_eaten,_where"),
    names_to = "Catches_Info",
    values_to = "Lakes"
  ) %>%
  #Step 2: Separate the lake names into individual rows
  separate_rows(Lakes, sep = ",") %>%
  mutate(Catches_Info = gsub("(Past_catches:_)|(,.*)", "", Catches_Info)) %>%
  mutate(Catches_Info = gsub("_", " ", Catches_Info)) %>%
  mutate(Lakes = trimws(Lakes))

sub_hh_10 <- sub_hh%>%
  filter(rowID %in% c(10))
  
sub_hh_46 <- sub_hh%>%
  filter(rowID %in% c(46))

sub_hh_69 <- sub_hh%>%
  filter(rowID %in% c(69))

sub_hh_39 <- sub_hh%>%
  filter(rowID %in% c(39))

#Subsistence consumption by household members
# 
# filter_subsistence_hh <- hh_consumers_species_long_adv %>%
#   group_by(fisherID, household_member,Relation_to_fisher, hh_age, hh_gender, hh_total_daily_intake ,hh_lakes, Annual_Household_Income, Ethnicity) %>%
#   summarise(
#     total_daily_intake = mean(hh_total_daily_intake, na.rm = TRUE),
#   )

```