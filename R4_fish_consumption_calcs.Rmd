---
title: "R4 Fish Consumption Calculations"
author: "Tori McGruer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## Install libraries
```{r message=TRUE}
library(tidyverse)
library(readxl)
library(ggplot2)
library(patchwork)
library(ggpubr)
library(ggbreak)
library(viridis)
library(hrbrthemes)
```
## Import data
```{r ,include=FALSE}

path <- c("//pacific/Toxicology/tox/Risk Assessment/Region4_Urban lakes fishers survey/Survey data/Data entry/Working_FisherSurveryDatabase.xlsm")

excel_sheets(path)

fisherdb_import <-read_excel(path, sheet = "Interviews")

colnames<-colnames(fisherdb_import)
colnames

#Replace spaces with underscores in column names
names(fisherdb_import) <- gsub(" ", "_", names(fisherdb_import))
names(fisherdb_import)

###CHECK errors when converting to numeric / factor - are we losing data by introducing NAs
#Convert to numeric / factor

fisherdb <- fisherdb_import

# List of columns to check and convert
columns_to_convert <- c(
  "Past_catches:_Catfish,_times_eaten_numeric", 
  "Past_catches:_Bluegill,_times_eaten_numeric",
  "Past_catches:_Common_Carp,_times_eaten_numeric",
  "Past_catches:_Bass,_times_eaten_numeric",
  "Past_catches:_Crappie,_times_eaten_numeric",
  "Past_catches:_Tilapia,_times_eaten_numeric",
  "Past_catches:_other,_times_eaten_numeric",
  
  "Past_catches:_Rainbow_Trout,_amount_eaten_numeric",
  "Past_catches:_Catfish,_amount_eaten_numeric",
  "Past_catches:_Blue_gill,_amount_eaten_numeric",
  "Past_catches:_Common_Carp,_amount_eaten_numeric",
  "Past_catches:_Bass,_amount_eaten_numeric",
  "Past_catches:_Crappie,_amount_eaten_numeric",
  "Past_catches:_Tilapia,_amount_eaten_numeric",
  "Past_catches:_other,_amount_eaten_numeric",
  
  "Amount_eaten_(Person_1)_numeric",
  "Amount_eaten_(Person_2)_numeric",
  "Amount_eaten_(Person_3)_numeric",
  "Amount_eaten_(Person_4)_numeric",
  
  "Times_eaten_last_4_weeks__(Person_1)_numeric",
  "Times_eaten_last_4_weeks__(Person_2)_numeric",
  "Times_eaten_last_4_weeks__(Person_3)_numeric",
  "Times_eaten_last_4_weeks__(Person_4)_numeric"
)

# Convert columns to numeric, check for data loss, and summarize
for (col in columns_to_convert) {
  # Create new numeric column
  numeric_col <- paste0(col)
  fisherdb[[numeric_col]] <- as.numeric(fisherdb_import[[col]])
  
  # Summary of original column as factor
  cat("Summary of", col, "as factor:\n")
  print(summary(as.factor(fisherdb_import[[col]])))
  
  # Summary of converted column
  cat("Summary of", numeric_col, ":\n")
  print(summary(fisherdb[[numeric_col]]))
  
}

##After running loop, check output to make sure NAs are introduced appropriately

##Convert age to numeric. Handle ranges by taking the average of the range.

# List of columns to convert
age_columns <- c("Age_(Person_1)", "Age_(Person_2)", "Age_(Person_3)", "Age_(Person_4)", "Age")

# Function to convert a value to numeric, calculating midpoint if it's a range
convert_to_midpoint <- function(x) {
  if (grepl("-", x)) {
    # Split the range, calculate the midpoint, and convert to numeric
    range_vals <- as.numeric(strsplit(x, "-")[[1]])
    return(mean(range_vals, na.rm = TRUE))
  } else {
    # Convert to numeric directly if it's a single value
    return(as.numeric(x))
  }
}

# Apply the conversion to each specified column
fisherdb <- fisherdb %>%
  mutate(across(
    all_of(age_columns),
    ~ sapply(.x, convert_to_midpoint),
    .names = "{.col}_numeric"))

##Check function performance

age_check <- fisherdb %>% select (`Age_(Person_1)`, `Age_(Person_1)_numeric`,
                                  `Age_(Person_2)`, `Age_(Person_2)_numeric`,
                                  `Age_(Person_3)`, `Age_(Person_3)_numeric`,
                                  `Age_(Person_4)`, `Age_(Person_4)_numeric`,
                                  Age, Age_numeric)
  
### Convert gender to factor
fisherdb <- fisherdb %>%
   mutate(across(c( 
     Observed_Gender,
     `Gender_(Person_1)`,
     `Gender_(Person_2)`,
     `Gender_(Person_3)`,
     `Gender_(Person_4)`
 ),as.factor))

###Check gender conversion
summary(fisherdb$Observed_Gender)
summary(fisherdb$`Gender_(Person_1)`)
summary(fisherdb$`Gender_(Person_2)`)
summary(fisherdb$`Gender_(Person_3)`)
summary(fisherdb$`Gender_(Person_4)`)


```

#Identify unique lake names used in database
```{r}
#using unlist and strsplit1
lake_names <- unlist(strsplit(c(fisherdb$Likely_Fishing_Location_1, 
                fisherdb$Likely_Fishing_Location_2, 
                fisherdb$Likely_Fishing_Location_3,
                fisherdb$`Past_catches:_Rainbow_Trout,_Where`,
                fisherdb$`Past_catches:_Catfish,_where`,
                fisherdb$`Past_catches:_Bluegill,_where`,
                fisherdb$`Past_catches:_Common_Carp,_where`,
                fisherdb$`Past_catches:__Bass,_where`,
                fisherdb$`Past_catches:_Crappie,_where`,
                fisherdb$`Past_catches:_Tilapia,_where`,
                fisherdb$`Past_catches:_other,_where`),","))

lake_names <-trimws(lake_names)
unique_lake_names <- unique(trimws(lake_names))
write.csv(unique_lake_names,"unique_lake_names.csv", row.names = FALSE)

##Names and counties were added to "unique_lake_names.csv" -- now import this dataset

unique_lake_names_key <- read.csv("unique_lake_names_key.csv",strip.white = TRUE)

##Join lakes & key to identify if any missed

df_unique_lake_names <- as.data.frame(unique_lake_names)
unique_lake_names_key <- unique_lake_names_key %>%
  mutate(original_name = trimws(original_name))
anti_join_lakes <- anti_join(df_unique_lake_names, unique_lake_names_key, by=c("unique_lake_names" = "original_name"))

write.csv(anti_join_lakes, "anti_join_lakes.csv", row.names = FALSE)
```


#Calculate consumption rate (Fishers)
```{r}
##Subset to only fish consumers (<4 weeks)
consumers <- fisherdb %>% filter(
                  `Past_catches:_Rainbow_Trout,_times_eaten` >0 |
                  `Past_catches:_Catfish,_times_eaten`>0 |
                  `Past_catches:_Bluegill,_times_eaten`>0|
                  `Past_catches:_Common_Carp,_times_eaten`>0 |
                  `Past_catches:_Bass,_times_eaten`>0 |
                  `Past_catches:_Crappie,_times_eaten`>0 |
                  `Past_catches:_Tilapia,_times_eaten`>0|
                  `Past_catches:_other,_times_eaten`>0
)

###Calculate consumption

consumers <- consumers %>%
  mutate(
    rainbow_trout_g_day = na_if(
      ((`Past_catches:_Rainbow_Trout,_times_eaten` * `Past_catches:_Rainbow_Trout,_amount_eaten` * 227) / 28), 0),
    catfish_g_day = na_if(
      ((`Past_catches:_Catfish,_times_eaten` * `Past_catches:_Catfish,_amount_eaten` * 227) / 28), 0),
    bluegill_g_day = na_if(
      ((`Past_catches:_Bluegill,_times_eaten` * `Past_catches:_Blue_gill,_amount_eaten` * 227) / 28), 0),
    carp_g_day = na_if(
      ((`Past_catches:_Common_Carp,_times_eaten` * `Past_catches:_Common_Carp,_amount_eaten` * 227) / 28), 0),
    bass_g_day = na_if(
      ((`Past_catches:_Bass,_times_eaten` * `Past_catches:_Bass,_amount_eaten` * 227) / 28), 0),
    crappie_g_day = na_if(
      ((`Past_catches:_Crappie,_times_eaten` * `Past_catches:_Crappie,_amount_eaten` * 227) / 28), 0),
    tilapia_g_day = na_if(
      ((`Past_catches:_Tilapia,_times_eaten` * `Past_catches:_Tilapia,_amount_eaten` * 227) / 28), 0),
    other_g_day = na_if(
      ((`Past_catches:_other,_times_eaten` * `Past_catches:_other,_amount_eaten` * 227) / 28), 0)
  )

    
ggplot(consumers, aes(x= `Past_catches:_Rainbow_Trout,_times_eaten,_where`, y=rainbow_trout_g_day))+
  geom_point()+  coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Catfish,_times_eaten,_where`, y=catfish_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Bluegill,_times_eaten,_where`, y=bluegill_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Common_Carp,_times_eaten,_where`, y=carp_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Bass,_times_eaten,_where`, y=bass_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Crappie,_times_eaten,_where`, y=crappie_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Tilapia,_times_eaten,_where`, y=tilapia_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Other,_times_eaten,_where`, y=other_g_day))+
  geom_point()+coord_flip()



```
###Test- create loop for OEHHA thresholds



#Compare consumption rate to statewide OEHHA thresholds
```{r}
##import thresholds
path <- "//pacific/Toxicology/tox/Risk Assessment/Region4_Urban lakes fishers survey/Resources/OEHHA consumption advisories/OEHHA_consumption_advisories.xlsx"

excel_sheets(path)
advisories <-read_excel(path, sheet = "Lake advisories")
advisories <- advisories %>% mutate(across(
  c(lake,county, OEHHA_fish_names, join_fish_names), as.factor)
)

##Separate lakes in times_eaten_where into separate columns
#unique_fish <- unique(consumers_long$Catches_Info)

advisories_long <- advisories %>%
   #mutate(rowID = 1:nrow(.))%>%
  select(-(srv_per_wk_child:child_serv_g), - Source, - Notes) %>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = threshold_g_day_child:threshold_g_day_men18,
    names_to = "column",
    values_to = "threshold_g_day"
  ) %>%
  mutate(Gender = case_when(
      grepl("child", column) ~ "Child",
      grepl("women", column) ~ "Female",
      grepl("men", column) ~ "Male",
      .default = NA
  )) %>%
  mutate(Age = case_when(
      grepl("_men18", column) ~ ">= 18",
      grepl("18_49", column) ~ "18 - 49",
      grepl("50", column) ~ ">= 50",
      grepl("child", column) ~ "< 18",
      .default = NA
  ))

consumers_long <- consumers %>%
  mutate(rowID = 1:nrow(.)) %>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = starts_with("Past_catches:") & ends_with("times_eaten,_where"),
    names_to = "Catches_Info",
    values_to = "Lakes"
  ) %>%
  #Step 2: Separate the lake names into individual rows
  separate_rows(Lakes, sep = ",") %>%
  mutate(Catches_Info = gsub("(Past_catches:_)|(,.*)", "", Catches_Info)) %>%
  mutate(Catches_Info = gsub("_", " ", Catches_Info)) %>%
  mutate(Lakes = trimws(Lakes))%>%
  # Step 3: Select the columns to keep
  select(rowID, Age, Observed_Gender, Catches_Info, Lakes, starts_with("Past_catches:") & ends_with(",_times_eaten"), starts_with("Past_catches:") & ends_with(",_amount_eaten"),
        starts_with("Past_catches:") & ends_with("parts_eaten"), Annual_Household_Income, Number_in_household, Ethnicity) %>%
  rename(`Past_catches:_Bluegill,_amount_eaten`= `Past_catches:_Blue_gill,_amount_eaten`) %>% 
  ###Calculate consumption rate of each fish at each lake per person
  mutate(daily_intake = case_when(
    Catches_Info == "Rainbow Trout" ~ `Past_catches:_Rainbow_Trout,_times_eaten` * `Past_catches:_Rainbow_Trout,_amount_eaten`,
    Catches_Info == "Catfish" ~ `Past_catches:_Catfish,_times_eaten` * `Past_catches:_Catfish,_amount_eaten`,
    Catches_Info == "Common Carp" ~ `Past_catches:_Common_Carp,_times_eaten` * `Past_catches:_Common_Carp,_amount_eaten`,
    Catches_Info == "Crappie" ~ `Past_catches:_Crappie,_times_eaten` * `Past_catches:_Crappie,_amount_eaten`,
    Catches_Info == "other" ~ `Past_catches:_other,_times_eaten` * `Past_catches:_other,_amount_eaten`,
    Catches_Info == "Tilapia" ~ `Past_catches:_Tilapia,_times_eaten` * `Past_catches:_Tilapia,_amount_eaten`,
    Catches_Info == "Bluegill" ~ `Past_catches:_Bluegill,_times_eaten` * `Past_catches:_Bluegill,_amount_eaten`,
    Catches_Info == "Bass" ~ `Past_catches:_Bass,_times_eaten` * `Past_catches:_Bass,_amount_eaten`,
    .default = NA
  )) %>%
  mutate(daily_intake = (daily_intake * 227)/28) %>%
  group_by(Catches_Info, rowID) %>%
  mutate(number_lakes = n()) %>%
  ungroup() %>%
  mutate(daily_intake_per_lake = daily_intake/number_lakes) %>% 
  separate(Lakes, into = c("Lakes", "times_from_lake"), sep = "\\(", fill = "right") %>%
  mutate(Lakes = trimws(Lakes))

###extract lake names to update key
lake_names <- consumers_long$Lakes
lake_names <-trimws(lake_names)
unique_lake_names <- unique(lake_names)
write.csv(unique_lake_names,"unique_lake_names.csv", row.names = FALSE)

##Names and counties were added to "unique_lake_names.csv" -- now import this dataset

unique_lake_names_key <- read.csv("unique_lake_names_key.csv")

##Join lakes & key to identify if any missed

df_unique_lake_names <- as.data.frame(unique_lake_names)
anti_join_lakes <- anti_join(df_unique_lake_names, unique_lake_names_key, by=c("unique_lake_names" = "original_name"))


##Update lake names with join
consumers_long <- consumers_long %>%
  left_join(unique_lake_names_key %>%
              select(original_name, lake , county), by = c("Lakes" = "original_name")) %>%
  rename(updated_lake_name = lake) %>%
  mutate(Observed_Gender = as.character(Observed_Gender)) %>%
  mutate(Observed_Gender = ifelse(Age < 18, "Child", Observed_Gender)) %>%
  mutate(Age_Category =  case_when(
    Age < 18 ~ "< 18",
    Age >= 18 & Observed_Gender == "Male" ~ ">= 18",
    Age >= 18 & Age < 50 & Observed_Gender == "Female" ~ "18 - 49",
    Age > 50 & Observed_Gender == "Female" ~ ">= 50",
    .default = NA
  ))

##update fish names to match OEHHA categories
consumers_long <- consumers_long %>%
  mutate (Catches_Info = case_when(
    Catches_Info == "Rainbow Trout" ~ "Rainbow trout",
    Catches_Info == "Catfish" ~ "Catfish",
    Catches_Info == "Bluegill" ~ "Sunfish species",
    Catches_Info == "Common Carp" ~ "Common carp",
    Catches_Info == "Bass" ~ "Black bass species",
    Catches_Info == "Crappie" ~ "Crappie",
    Catches_Info == "Tilapia"   ~ "Tilapia"  ,
    Catches_Info == "Other" ~ "Other",
    
  ))
#datacheck <- consumers_long %>% select(Catches_Info, fish)
  
##checking age categories

age_check <- consumers_long %>% select (rowID,Observed_Gender, Age, Age_Category)

##Check that advisory categories match
unique_lake_names_key <- read.csv("unique_lake_names_key.csv")
anti_join_lakes <- anti_join(advisories_long, consumers_long, by=c("lake" = "updated_lake_name"))
print(list(unique(anti_join_lakes$lake)))

##Create separate dataset for statewide framework

statewide_adv <- advisories_long %>% filter(
  lake == "Statewide") %>%
  rename(threshold_used = county,
         statewide_column = column,
         statewide_threshold_g_day = threshold_g_day)


##Join consumers with advisories
  consumers_long <- consumers_long  %>%
  left_join(advisories_long, by = c("updated_lake_name" = "lake", 
                                    "Age_Category" = "Age", 
                                    "Observed_Gender" = "Gender",
                                    "Catches_Info" = "join_fish_names"
                                    )) %>%
   rename(county = county.x)%>%
   select(-county.y)
  
##Fill in statewide advisories for lakes/fish where there are no lake specific consumption data
# Perform the left join only on the rows that meet the condition
joined_data <- consumers_long %>%
  filter(daily_intake > 0 & is.na(column)) %>%
  left_join(statewide_adv, by = c("Age_Category" = "Age", 
                                  "Observed_Gender" = "Gender",
                                  "Catches_Info" = "join_fish_names"))%>%
  select(-lake)
  
# Keep the rows that do not meet the condition as they are
non_joined_data <- consumers_long %>%
  filter(!(daily_intake > 0 & is.na(column)))
  
# Combine the two data frames back together
consumers_long <- bind_rows(joined_data, non_joined_data) 

consumers_long <- consumers_long %>% 
  mutate(column = coalesce(column, statewide_column,),
         threshold_g_day = coalesce(threshold_g_day, statewide_threshold_g_day),
         OEHHA_fish_names = coalesce(OEHHA_fish_names, OEHHA_fish_names.y)
         )%>%
  select(-statewide_column, - statewide_threshold_g_day, -OEHHA_fish_names.x, - OEHHA_fish_names.y)%>%
   group_by(Catches_Info, rowID) %>%
  mutate(avg_threshold = mean(threshold_g_day))%>%
  ungroup() %>%
##Does consumption by each individual from one lake exceed threshold for that specific lake
  mutate(exceed_threshold_indiv_lake = daily_intake_per_lake > threshold_g_day)%>%
##Does total consumption by each individual from all lakes exceed average threshold for one lake or all lakes 
  mutate(exceed_threshold_avg_lake = exceed_threshold_indiv_lake | (daily_intake > avg_threshold))
  
##datacheck 
datacheck <- consumers_long %>% select(rowID, Catches_Info, updated_lake_name, threshold_g_day, avg_threshold)


##During data clean up - check NAs here. Explore why.
##Need to check code to make sure things are filtering & calculating as expected
write.csv(consumers_long, "consumers_long.csv", , row.names = FALSE)

```
##Parts of fish consumed
```{r}

##Case when to select parts of fish consumed ONLY by fishers who consumed fish in past month

fish_parts <- fisherdb %>%
    mutate(parts_consumed_rainbow_trout =    case_when(`Past_catches:_Rainbow_Trout,_times_eaten` > 0 ~ `Past_catches:_Rainbow_Trout,_parts_eaten`)) %>%
    mutate(parts_consumed_catfish = case_when(`Past_catches:_Catfish,_times_eaten` > 0 ~ `Past_catches:_Catfish,_parts_eaten`)) %>%
    mutate(parts_consumed_common_carp = case_when(`Past_catches:_Common_Carp,_times_eaten` > 0 ~ `Past_catches:_Common_Carp,_parts_eaten`)) %>%
  mutate(parts_consumed_crappie = case_when(`Past_catches:_Crappie,_times_eaten` > 0 ~ `Past_catches:_Crappie,_parts_eaten`)) %>%
    mutate(parts_consumed_other = case_when(`Past_catches:_other,_times_eaten` > 0 ~ `Past_catches:_other,_parts_eaten`)) %>%
  mutate(parts_consumed_tilapia = case_when(`Past_catches:_Tilapia,_times_eaten` > 0 ~ `Past_catches:_Tilapia,_parts_eaten`)) %>%
  mutate(parts_consumed_bluegill = case_when(`Past_catches:_Bluegill,_times_eaten` > 0 ~ `Past_catches:_Bluegill,_parts_eaten`)) %>%
  mutate(parts_consumed_bass = case_when(`Past_catches:_Bass,_times_eaten` > 0 ~ `Past_catches:_Bass,_parts_eaten`)) %>% 
  select(Location, Observed_Gender, parts_consumed_rainbow_trout, parts_consumed_catfish,parts_consumed_common_carp,parts_consumed_crappie,parts_consumed_other,parts_consumed_tilapia,parts_consumed_bluegill,parts_consumed_bass) %>%
  filter(!if_all(c(parts_consumed_rainbow_trout, parts_consumed_catfish, parts_consumed_common_carp, 
                   parts_consumed_crappie, parts_consumed_other, parts_consumed_tilapia, 
                   parts_consumed_bluegill, parts_consumed_bass), is.na))%>%
  mutate(combined_parts_consumed = pmap_chr(list(parts_consumed_rainbow_trout, parts_consumed_catfish,parts_consumed_common_carp, parts_consumed_crappie, parts_consumed_other, parts_consumed_tilapia, parts_consumed_bluegill, parts_consumed_bass),~ paste(na.omit(c(...)), collapse = ", ")))

##Create a unique list of parts of fish eaten
unique_parts <- unique(c(
  unique(fish_parts$parts_consumed_rainbow_trout),
  unique(fish_parts$parts_consumed_catfish),
  unique(fish_parts$parts_consumed_common_carp),
  unique(fish_parts$parts_consumed_crappie),
  unique(fish_parts$parts_consumed_other),
  unique(fish_parts$parts_consumed_tilapia),
  unique(fish_parts$parts_consumed_bluegill),
  unique(fish_parts$parts_consumed_bass)
  ))
  
fish_parts_long <- fish_parts %>%
   mutate(fisherID = 1:nrow(.)) %>%
  pivot_longer(
    cols = starts_with("parts_consumed"),
    names_to = "fish_consumed",
    values_to = "parts_of_fish"
  )%>%
  select(fisherID, Location, Observed_Gender, fisherID, fish_consumed, parts_of_fish) %>%
  mutate(fish_consumed = gsub("parts_consumed", "", fish_consumed)) %>%
  mutate(fish_consumed = gsub("_", " ", fish_consumed))%>%
  na.omit(parts_of_fish)


##Ignore fish type and group by fisher ID
fish_parts_all <- fish_parts_long %>% 
  select(!fish_consumed)%>%
  distinct(.keep_all = TRUE)

##Calculate the percent frequency different parts of fish are consumed (regardless of fish type or lake) - data cleaning still needed

fish_parts_frequency <- fish_parts_all %>%
  count(parts_of_fish) %>%
  mutate(percent_frequency = round(n / sum(n) * 100))


# fish_parts <- consumers_long %>% 
#   mutate(parts_consumed = case_when(
#     Catches_Info == "Rainbow trout" & `Past_catches:_Rainbow_Trout,_times_eaten` > 0 ~ `Past_catches:_Rainbow_Trout,_parts_eaten`,
#     Catches_Info == "Catfish" & `Past_catches:_Catfish,_times_eaten` > 0 ~ `Past_catches:_Catfish,_parts_eaten`,
#     Catches_Info == "Common carp" & `Past_catches:_Catfish,_times_eaten` > 0 ~ `Past_catches:_Catfish,_parts_eaten`,
#     Catches_Info == "Crappie" & `Past_catches:_Catfish,_times_eaten` > 0 ~ `Past_catches:_Catfish,_parts_eaten`,
#     Catches_Info == "other" & `Past_catches:_Catfish,_times_eaten` > 0 ~ `Past_catches:_Catfish,_parts_eaten`,
#     Catches_Info == "Tilapia" & `Past_catches:_Catfish,_times_eaten` > 0 ~ `Past_catches:_Catfish,_parts_eaten`,
#     Catches_Info == "Sunfish species" & `Past_catches:_Catfish,_times_eaten` > 0 ~ `Past_catches:_Catfish,_parts_eaten`,
#     Catches_Info == "Black bass species" & `Past_catches:_Catfish,_times_eaten` > 0 ~ `Past_catches:_Catfish,_parts_eaten`
#   ))%>%
#   select(rowID:Observed_Gender)
# 
# 
# fish_parts_wide <- fish_parts %>%
#   pivot_wider(
#     names_from = Catches_Info,
#     values_from = parts_consumed
#   )

```
##Fish consumption by income

```{r}
###address missing points & then rerun 
consumers_x_income <- consumers_long %>%
   separate(Annual_Household_Income, into = c("low_end_income", "high_end_income"), sep = "-", fill = "right", remove=FALSE) %>%
 filter(!low_end_income %in% c("No answer","Unknown")) %>%
  filter(!high_end_income %in% c("No answer","Unknown"))%>%
  mutate(
    low_end_income = str_replace_all(low_end_income, ",", ""),
    low_end_income = case_when(
    low_end_income == "200000+" ~ "200000",
    TRUE ~ low_end_income),
    low_end_income = as.numeric(low_end_income)) %>%
mutate(
    high_end_income = str_replace_all(high_end_income, ",", ""),
    high_end_income = case_when(
    Annual_Household_Income=="200,000+" ~ "200000",
    TRUE ~ high_end_income),
    high_end_income = as.numeric(high_end_income)) %>%
mutate(Number_in_household = as.numeric(Number_in_household))%>%
mutate(avg_income = (high_end_income + low_end_income) / 2)%>%
mutate(avg_income_norm = avg_income/Number_in_household) %>%
  group_by(rowID)%>%
  mutate(total_daily_intake = sum(daily_intake))%>%
  ungroup()%>%
filter(avg_income_norm < 100000)
  
ggplot(consumers_x_income, aes(x=avg_income_norm, y=total_daily_intake, color = exceed_threshold_avg_lake))+
  geom_point()+ 
  #geom_smooth(method= "lm", color="red")+
  #stat_regline_equation()
  theme(panel.grid = element_blank())+
 facet_wrap(~ exceed_threshold_avg_lake)

### leaving income ranges as is:

fisherdb_consumers <- fisherdb %>% mutate(consumer =(
                  `Past_catches:_Rainbow_Trout,_times_eaten` >0 |
                  `Past_catches:_Catfish,_times_eaten`>0 |
                  `Past_catches:_Bluegill,_times_eaten`>0|
                  `Past_catches:_Common_Carp,_times_eaten`>0 |
                  `Past_catches:_Bass,_times_eaten`>0 |
                  `Past_catches:_Crappie,_times_eaten`>0 |
                  `Past_catches:_Tilapia,_times_eaten`>0|
                  `Past_catches:_other,_times_eaten`>0
                  ))%>%
  mutate(Annual_Household_Income = as.factor(Annual_Household_Income))%>%
  mutate(Annual_Household_Income = case_when(
    Annual_Household_Income == "75.000-100.000" ~ "75,000-100,000",
    Annual_Household_Income == "50,000-75,0000" ~ "50,000-75,000",
    Annual_Household_Income == "150.000-200,000" ~ "150,000-200,000",
    Annual_Household_Income == "150,000-200,001" ~ "150,000-200,000",
    Annual_Household_Income == "No answer" ~ "Not reported / unknown",
    Annual_Household_Income == "No Answer" ~ "Not reported / unknown",
    Annual_Household_Income == "Unknown" ~ "Not reported / unknown",
    Annual_Household_Income == "Other/Unknown" ~ "Not reported / unknown",
    Annual_Household_Income == "Prefer not to say" ~ "Not reported / unknown",
    Annual_Household_Income == "NA" ~ "Not reported / unknown",
    TRUE ~ Annual_Household_Income  # Keep all other values as they are
  ))
summary(as.factor(fisherdb_consumers$Annual_Household_Income))  

income_counts <- fisherdb_consumers %>%
  group_by(Annual_Household_Income) %>%
  summarise(fisher_count = n()) %>%
  ungroup()#%>%
  

consumer_income_counts <- fisherdb_consumers %>%
  filter(consumer ==TRUE)%>%
  group_by(Annual_Household_Income)%>%
  summarise(consumer_count = n()) %>%
  ungroup()

exceed_thresh_income_counts<- consumers_long %>%
   mutate(Annual_Household_Income = case_when(
    Annual_Household_Income == "75.000-100.000" ~ "75,000-100,000",
    Annual_Household_Income == "50,000-75,0000" ~ "50,000-75,000",
    Annual_Household_Income == "150.000-200,000" ~ "150,000-200,000",
    Annual_Household_Income == "150,000-200,001" ~ "150,000-200,000",
    Annual_Household_Income == "No answer" ~ "Not reported / unknown",
    Annual_Household_Income == "No Answer" ~ "Not reported / unknown",
    Annual_Household_Income == "Unknown" ~ "Not reported / unknown",
    Annual_Household_Income == "Other/Unknown" ~ "Not reported / unknown",
    Annual_Household_Income == "Prefer not to say" ~ "Not reported / unknown",
    Annual_Household_Income == "NA" ~ "Not reported / unknown",
    TRUE ~ Annual_Household_Income  # Keep all other values as they are
  ))%>%
  group_by(rowID, Annual_Household_Income)%>%
  summarise(any_true = any(exceed_threshold_avg_lake == TRUE, na.rm = TRUE)) %>%
  ungroup()%>%
  group_by(Annual_Household_Income)%>%
  summarise(exceed_thresh_count = sum(any_true == TRUE, na.rm = TRUE)) %>%
  ungroup()
 
 
dailyintake_x_income <- consumers_long %>%
    group_by(rowID, Annual_Household_Income) %>%
    filter(daily_intake > 0) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
     mutate(Annual_Household_Income = case_when(
    Annual_Household_Income == "75.000-100.000" ~ "75,000-100,000",
    Annual_Household_Income == "50,000-75,0000" ~ "50,000-75,000",
    Annual_Household_Income == "150.000-200,000" ~ "150,000-200,000",
    Annual_Household_Income == "150,000-200,001" ~ "150,000-200,000",
    Annual_Household_Income == "No answer" ~ "Not reported / unknown",
    Annual_Household_Income == "No Answer" ~ "Not reported / unknown",
    Annual_Household_Income == "Unknown" ~ "Not reported / unknown",
    Annual_Household_Income == "Other/Unknown" ~ "Not reported / unknown",
    Annual_Household_Income == "Prefer not to say" ~ "Not reported / unknown",
    Annual_Household_Income == "NA" ~ "Not reported / unknown",
    TRUE ~ Annual_Household_Income  # Keep all other values as they are
  ))%>%
  ungroup()

consumption_rate_x_income <- dailyintake_x_income  %>%
  group_by(Annual_Household_Income)%>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    )%>%
  ungroup()


income_counts <- left_join(income_counts, consumer_income_counts, by = "Annual_Household_Income")
income_counts <- left_join(income_counts, exceed_thresh_income_counts, by = "Annual_Household_Income")
income_counts <- left_join(income_counts, consumption_rate_x_income, by = "Annual_Household_Income")

sum_fishers <- sum(income_counts$fisher_count)
sum_consumers<- sum(income_counts$consumer_count)
sum_exceed<- sum(income_counts$exceed_thresh_count)

income_counts <- income_counts %>%
  ungroup()%>%
  filter(!is.na(consumer_count))%>%
  mutate(percent_of_fishers = round((fisher_count/sum_fishers)*100))%>%
  mutate(percent_consumers = round((consumer_count/sum_consumers)*100))%>%
  mutate(percent_exceed_ofconsumers = round((exceed_thresh_count/ sum_exceed)*100))%>%
  mutate(percent_total = 100)

income_counts_export <- income_counts %>%
  select(Annual_Household_Income,percent_of_fishers,fisher_count, percent_consumers, consumer_count, percent_exceed_ofconsumers, exceed_thresh_count, n, min, max, mean, median)

write.csv(income_counts_export, file="income_counts.csv", row.names = FALSE)

#Plot consumption rate by income

dailyintake_x_income <- dailyintake_x_income %>%
  mutate(Annual_Household_Income = factor(Annual_Household_Income, levels = c("0-20,000",
                                                  "20,000-50,000", 
                                                  "50,000-75,000", 
                                                  "75,000-100,000", 
                                                  "100,000-150,000",
                                                  "150,000-200,000",
                                                  "200,000+",
                                                  "Not reported / unknown")))

plot_dailyintake_income <- ggplot(dailyintake_x_income, aes(x=Annual_Household_Income, y = (total_daily_intake), fill = Annual_Household_Income ))+
   geom_violin(width=2.1, size=0.2) +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    scale_y_break(c(500, 2100))+
    theme_ipsum() +
    theme(
      legend.position="none"
    )

plot_dailyintake_income


##Plot (overlaying bars)

# income_counts <- income_counts %>% 
#    mutate(Annual_Household_Income = factor(Annual_Household_Income, levels = c("0-20,000",
#                                                   "20,000-50,000", 
#                                                   "50,000-75,000", 
#                                                   "75,000-100,000", 
#                                                   "100,000-150,000",
#                                                   "150,000-200,000",
#                                                   "200,000+")))
perc_all_income<-ggplot(income_counts, aes(x = Annual_Household_Income)) +
  #geom_bar(aes(y = percent_total , fill= "All Fishers"), stat = "identity") +  # Plot total counts
  geom_bar(aes(y = percent_consumers, fill = "Consumers"), stat = "identity") + # Overlay consumer counts
  geom_bar(aes(y = percent_exceed_offishers, fill = "Exceed Advisory"), stat = "identity") +  # Overlay consumer count
  scale_fill_manual(values = c("All Fishers" = "gray", "Consumers" = "#2786A0","Exceed Advisory" = "#D07C42" )) +  # Customize fill colors
  labs(y = "Percent of fishers", x="Annual household income", title = "") +  # Customize labels
  theme_minimal() +
  theme(legend.position = "top",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 0.5)) # Clean theme

perc_all_income

plot_height <- 1500
plot_width <- 1200

ggsave(
  filename = "consumption_x_income.svg",
  plot = perc_all_income, width = plot_width, height = plot_height, units = "px", dpi = 300
)

```

##Fish consumption by ethnicity
```{r}

fisherdb_ethnicity <- fisherdb_consumers %>% 
  mutate(Ethnicity = as.factor(Ethnicity))%>%
  mutate(Ethnicity = case_when(
    Ethnicity == "NA" ~ "Prefer not to say / Unknown",
    Ethnicity == "No answer" ~ "Prefer not to say / Unknown",
    Ethnicity == "No Answer" ~ "Prefer not to say / Unknown",
    Ethnicity == "Other/Unknown" ~ "Prefer not to say / Unknown",
    Ethnicity == "Prefer not to say" ~ "Prefer not to say / Unknown",
    Ethnicity == "Unknown" ~ "Prefer not to say / Unknown",
    Ethnicity == "Hispanic or Latino, Asian or Pacific Islander" ~ "Other",
    Ethnicity == "Hispanic or Latino, White" ~ "Other",
    Ethnicity == "white" ~ "White",
    Ethnicity == "Hispanic or LAtino" ~ "Hispanic or Latino",
    TRUE ~ Ethnicity  # Keep all other values as they are
  ))

summary(as.factor(fisherdb_ethnicity$Ethnicity))

ethnicity_counts <- fisherdb_ethnicity %>%
  group_by(Ethnicity) %>%
  summarise(fisher_count = n()) %>%
  ungroup()
  

consumer_ethnicity_counts <- fisherdb_ethnicity %>%
  filter(consumer ==TRUE)%>%
  group_by(Ethnicity)%>%
  summarise(consumer_count = n()) %>%
  ungroup()

exceed_thresh_ethnicity_counts<- consumers_long %>%
   mutate(Ethnicity = case_when(
    Ethnicity == "NA" ~ "Prefer not to say / Unknown",
    Ethnicity == "No answer" ~ "Prefer not to say / Unknown",
    Ethnicity == "No Answer" ~ "Prefer not to say / Unknown",
    Ethnicity == "Other/Unknown" ~ "Prefer not to say / Unknown",
    Ethnicity == "Prefer not to say" ~ "Prefer not to say / Unknown",
    Ethnicity == "Unknown" ~ "Prefer not to say / Unknown",
    Ethnicity == "Hispanic or Latino, Asian or Pacific Islander" ~ "Other",
    Ethnicity == "Hispanic or Latino, White" ~ "Other",
    Ethnicity == "white" ~ "White",
    Ethnicity == "Hispanic or LAtino" ~ "Hispanic or Latino",
    TRUE ~ Ethnicity  # Keep all other values as they are
  ))%>%
  group_by(rowID,Ethnicity)%>%
  summarise(any_true = any(exceed_threshold_avg_lake == TRUE, na.rm = TRUE))%>%
  ungroup()%>%
  group_by(Ethnicity)%>%
  summarise(exceed_thresh_count_eth = sum(any_true == TRUE, na.rm = TRUE)) %>%
  ungroup()

##START here
dailyintake_x_ethnicity <- consumers_long %>%
    group_by(rowID, Ethnicity) %>%
    filter(daily_intake > 0) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    mutate(Ethnicity = case_when(
    Ethnicity == "NA" ~ "Prefer not to say / Unknown",
    Ethnicity == "No answer" ~ "Prefer not to say / Unknown",
    Ethnicity == "No Answer" ~ "Prefer not to say / Unknown",
    Ethnicity == "Other/Unknown" ~ "Prefer not to say / Unknown",
    Ethnicity == "Prefer not to say" ~ "Prefer not to say / Unknown",
    Ethnicity == "Unknown" ~ "Prefer not to say / Unknown",
    Ethnicity == "Hispanic or Latino, Asian or Pacific Islander" ~ "Other",
    Ethnicity == "Hispanic or Latino, White" ~ "Other",
    Ethnicity == "white" ~ "White",
    Ethnicity == "Hispanic or LAtino" ~ "Hispanic or Latino",
    TRUE ~ Ethnicity  # Keep all other values as they are
  ))%>%
  ungroup()

consumption_rate_x_ethnicity <- dailyintake_x_ethnicity  %>%
  group_by(Ethnicity)%>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    )%>%
  ungroup()


ethnicity_counts <- left_join(ethnicity_counts, consumer_ethnicity_counts, by = "Ethnicity")
ethnicity_counts <- left_join(ethnicity_counts, exceed_thresh_ethnicity_counts, by = "Ethnicity")
ethnicity_counts <- left_join(ethnicity_counts, consumption_rate_x_ethnicity, by = "Ethnicity")

sum_fishers <- sum(ethnicity_counts$fisher_count)
sum_consumers <- sum(ethnicity_counts$consumer_count, na.rm = TRUE)
sum_exceed <- sum(ethnicity_counts$exceed_thresh_count_eth, na.rm = TRUE)

ethnicity_counts <- ethnicity_counts %>%
  ungroup()%>%
  mutate(
  percent_of_fishers = round((fisher_count / sum_fishers) * 100),
    percent_consumers = round((consumer_count / sum_consumers) * 100),
    percent_exceed_ofconsumers = round((exceed_thresh_count_eth / sum_exceed) * 100),
    percent_total = 100
)
ethnicity_counts_export <- ethnicity_counts %>%
  select(Ethnicity,percent_of_fishers,fisher_count, percent_consumers, consumer_count, percent_exceed_ofconsumers, exceed_thresh_count_eth, n, min, max, mean, median)

write.csv(ethnicity_counts_export, file="ethnicity_counts.csv", row.names = FALSE)

```

##LOOP ALL lakes consumption

```{r}

# List of fish species to analyze
fish_species <- list(
  "All" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "All" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

lakes <- list(
  "All" = unique(consumers_long$updated_lake_name)
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
### Percent of consumers exceeding thresholds by lake (Exceed lake specific threshold by consuming fish ONLY at that lake)
  per_exceed_thresh <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded_lake = any(exceed_threshold_indiv_lake)) %>% #Groups by row ID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold at any individual lake and false if they have not. 
    ungroup() %>%
    filter(!is.na(any_exceeded_lake)) %>% #filters out NAs so that only TRUE / FALSE values are being assesseed 
    summarise(percent_exceed_lake = round((sum(any_exceeded_lake) / n()) * 100)) %>%  #Summarizes entire column to      calculate percent true exceeding individual lake thresholds
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())
  
   ### Percent of consumers exceeding thresholds avg threshold
  per_exceed_avg_thresh <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
   summarise(any_exceeded_avg = any(exceed_threshold_avg_lake)) %>%# #Does total consumption by each individual from      all lakes exceed average threshold for all lakes
    ungroup() %>%
    filter(!is.na(any_exceeded_avg)) %>%
   summarise(percent_exceed_avg = round((sum(any_exceeded_avg) / n()) * 100)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### Consumers total consumption rate 
  all_consumption_rate <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)
  summary_table <- left_join(summary_table, per_exceed_avg_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
all_lakes_summary_table <- bind_rows(summary_tables)

# Write to CSV
write.csv(all_lakes_summary_table, "consumption_summary_all.csv", row.names = FALSE)



```



##LOOP surveyed lakes consumption 
```{r}

####This loop provides a .csv output with the number of people consuming fish from each of the surveyed lakes and a summary of their consumption of different fish species from each individual lake alone (Not including fish they may be consuming at other lakes). percent_exceed_lake provides the percent of consumers whose fish consumption at the specified lake ALONE exceeds the OEHHA lake specific or statewide consumption threshold. percent_exceed_avg provides the percent of consumers whose fish consumption both from the specified lake and other lakes exceeds the average threshold for the lakes they consume from. Therefore, if percent_exceed_lake and percent_exceed_avg are the same then threshold exceedance is driven by the specified lake. If percent_exceed_avg is greater than percent_exceed_lake then there are other lakes contributing to threshold exceedance

# List of fish species to analyze
fish_species <- list(
  "All" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "All" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

lakes <- list(
  "Alondra park" = "Alondra park",
  "Legg lake" = "Legg lake",
  "Magic Johnson Lakes" = "Magic Johnson Lakes",
  "Peck Road" = "Peck Road"
  )

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
### Percent of consumers exceeding thresholds by lake (Exceed lake specific threshold by consuming fish ONLY at that lake)
  per_exceed_thresh <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded_lake = any(exceed_threshold_indiv_lake)) %>% #Groups by row ID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold at any individual lake and false if they have not. 
    ungroup() %>%
    filter(!is.na(any_exceeded_lake)) %>% #filters out NAs so that only TRUE / FALSE values are being assesseed 
    summarise(percent_exceed_lake = round((sum(any_exceeded_lake) / n()) * 100)) %>%  #Summarizes entire column to      calculate percent true exceeding individual lake thresholds
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())
  
   ### Percent of consumers exceeding thresholds avg threshold
  per_exceed_avg_thresh <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
   summarise(any_exceeded_avg = any(exceed_threshold_avg_lake)) %>%# #Does total consumption by each individual from    all lakes exceed average threshold for all lakes
    ungroup() %>%
    filter(!is.na(any_exceeded_avg)) %>%
   summarise(percent_exceed_avg = round((sum(any_exceeded_avg) / n()) * 100)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### Consumers total consumption rate 
  all_consumption_rate <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake_per_lake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)
  summary_table <- left_join(summary_table, per_exceed_avg_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
all_lakes_summary_table <- bind_rows(summary_tables)

# Write to CSV
write.csv(all_lakes_summary_table, "consumption_summary_surveyed_lakes.csv", row.names = FALSE)



```

##LOOP LA county lakes consumption 
```{r}

LA_county_consumers <- consumers_long %>%
  filter(county == "Los Angeles")%>%
  group_by(Catches_Info, rowID) %>%
  mutate(daily_intake_LA = sum(daily_intake_per_lake))%>%
  mutate(avg_LAthreshold = mean(threshold_g_day)) %>%
  ungroup()%>%
  mutate(exceed_threshold_LA_lake = exceed_threshold_indiv_lake |(daily_intake_LA>avg_LAthreshold))
  

datacheck <- LA_county_consumers %>% select(rowID, Catches_Info , number_lakes,daily_intake, daily_intake_per_lake, threshold_g_day, threshold_used, avg_threshold,daily_intake_LA, avg_LAthreshold, exceed_threshold_LA_lake)

# List of fish species to analyze
fish_species <- list(
  "All" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "All" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)
##CHECK to ensure lake list is up to date before final analysis
lakes <- list(
  "All LA county" = unique(LA_county_consumers$updated_lake_name),
  #"all_surveyed" = c("Legg lake","Alondra park","Peck Road"),
  #"Legg lake" = "Legg lake",
 # "Alondra park" = "Alondra park",
  #"Peck Road" = "Peck Road",
 "Belvedere Park"  ="Belvedere Park"  ,
 "Castaic Lake" ="Castaic Lake" ,
 "Cerritos Park Lake / Don Knabe" ="Cerritos Park Lake / Don Knabe",
  "Crystal Lake"="Crystal Lake",
 "Downey Wilderness Park Lake" = "Downey Wilderness Park Lake" ,
 "El Dorado Park Lake" = "El Dorado Park Lake",
 "Hollenbeck Park Lake" = "Hollenbeck Park Lake",
 "Kenneth Hahn/Gwen Moore Lake" ="Kenneth Hahn/Gwen Moore Lake" ,
 "Lincoln Park Lake" ="Lincoln Park Lake",
  "MacArthur Park" = "MacArthur Park",
 "Puddingstone reservoir" ="Puddingstone reservoir" ,
  "Pyramid lake"  = "Pyramid lake"  ,
  "Santa Fe Dam lake" ="Santa Fe Dam lake"
  
)

# Initialize an empty list to store summary tables
summary_tables_LA <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
      ### Percent of consumers exceeding thresholds by lake (Exceed lake specific threshold by consuming fish ONLY at that lake) OF if all LA county then calculating contribution of LA county lakes specifically 
    if (lake_name == "All LA county"){
    per_exceed_thresh_LA <- LA_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded_lalake = any(exceed_threshold_LA_lake)) %>%#Groups by row ID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold at any individual lake and false if they have not. 
    ungroup() %>%
    filter(!is.na(any_exceeded_lalake)) %>% #filters out NAs so that only TRUE / FALSE values are being assessed 
    summarise(percent_exceed = round((sum(any_exceeded_lalake) / n()) * 100)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())
    } else {
  per_exceed_thresh_LA <- LA_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded_lalake = any(exceed_threshold_indiv_lake)) %>%#Groups by row ID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold at any individual lake and false if they have not. 
    ungroup() %>%
    filter(!is.na(any_exceeded_lalake)) %>% #filters out NAs so that only TRUE / FALSE values are being assessed 
    summarise(percent_exceed = round((sum(any_exceeded_lalake) / n()) * 100)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())
    }
  
  ### Percent of consumers exceeding thresholds avg threshold
  
   per_exceed_avg_thresh_LA <- LA_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded_avg_lalake = any(exceed_threshold_avg_lake)) %>%#Groups by row ID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold at any individual lake and false if they have not. 
    ungroup() %>%
    filter(!is.na(any_exceeded_avg_lalake)) %>% #filters out NAs so that only TRUE / FALSE values are being assessed 
    summarise(percent_exceed_avg = round((sum(any_exceeded_avg_lalake) / n()) * 100)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())
  
  ### Consumers total consumption rate at lake
  all_consumption_rate <- LA_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake_per_lake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh_LA)
  summary_table <- left_join(summary_table,  per_exceed_avg_thresh_LA)

  # Store the summary table in the list
   summary_tables_LA[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
LA_county_summary_table <- bind_rows(summary_tables_LA)

# Write to CSV
write.csv(LA_county_summary_table, "consumption_LA_county_summary.csv", row.names = FALSE)



```
##LOOP {NEEDS UPDATE} Orange county lakes consumption 
```{r}

Orange_county_consumers <- consumers_long %>%
  filter(county == "Orange")

# List of fish species to analyze
fish_species <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "all" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

##CHECK to ensure lake list is up to date before final analysis
lakes <- list(
  "all Orange county" = unique(Orange_county_consumers$updated_lake_name),
  "Carbon Canyon Regional Park" ="Carbon Canyon Regional Park",
  "Tri-City Regional Park" = "Tri-City Regional Park",
   "Laguna Niguel Lake" =  "Laguna Niguel Lake" ,
  "Irvine Lake" ="Irvine Lake" 
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
    

  ### Percent of consumers exceeding threshold
  per_exceed_thresh <- Orange_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(any_exceeded)) %>%
    summarise(percent_exceed = round((sum(any_exceeded) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### All consumers consumption rate
  all_consumption_rate <- Orange_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 1),
      max = round(max(total_daily_intake, na.rm = TRUE), 1),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 1),
      median = round(median(total_daily_intake, na.rm = TRUE), 1)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
Orange_county_summary_table <- bind_rows(summary_tables)

# Write to CSV
write.csv(Orange_county_summary_table, "consumption_Orange_county_summary.csv", row.names = FALSE)



```
##LOOP {NEEDS UPDATE} Riverside county lakes consumption 
```{r}

Riverside_county_consumers <- consumers_long %>%
  filter(county == "Riverside")

# List of fish species to analyze
fish_species <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "all" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

##CHECK to ensure lake list is up to date before final analysis
lakes <- list(
  "all Riverside county" = unique(Riverside_county_consumers$updated_lake_name),
  "Lake Skinner"="Lake Skinner",
  "Lake Perris" ="Lake Perris" 
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
    

  ### Percent of consumers exceeding threshold
  per_exceed_thresh <- Riverside_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(any_exceeded)) %>%
    summarise(percent_exceed = round((sum(any_exceeded) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### All consumers consumption rate
  all_consumption_rate <- Riverside_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 1),
      max = round(max(total_daily_intake, na.rm = TRUE), 1),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 1),
      median = round(median(total_daily_intake, na.rm = TRUE), 1)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
Riverside_county_summary_table <- bind_rows(summary_tables)

##Remove NAs (comment out to include NAs)
Riverside_county_summary_table <- Riverside_county_summary_table %>%
  filter(complete.cases(percent_exceed))

# Write to CSV
write.csv(Riverside_county_summary_table, "consumption_Riverside_county_summary.csv", row.names = FALSE)

```

##LOOP {NEEDS UPDATE} San Bernardino county lakes consumption 
```{r}

San_Bernardino_county_consumers <- consumers_long %>%
  filter(county == "San Bernardino")

# List of fish species to analyze
fish_species <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "all" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

##CHECK to ensure lake list is up to date before final analysis
lakes <- list(
  "all San_Bernardino county" = unique(San_Bernardino_county_consumers$updated_lake_name),
  "Lake Gregory Regional Park"="Lake Gregory Regional Park",
  "Big Bear lake"="Big Bear lake",
  "Prado Dam" ="Prado Dam" 
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
    

  ### Percent of consumers exceeding threshold
  per_exceed_thresh <- San_Bernardino_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(any_exceeded)) %>%
    summarise(percent_exceed = round((sum(any_exceeded) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### All consumers consumption rate
  all_consumption_rate <- San_Bernardino_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 1),
      max = round(max(total_daily_intake, na.rm = TRUE), 1),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 1),
      median = round(median(total_daily_intake, na.rm = TRUE), 1)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
San_Bernardino_county_summary_table <- bind_rows(summary_tables)

##Remove NAs (comment out to include NAs)
San_Bernardino_county_summary_table <- San_Bernardino_county_summary_table %>%
  filter(complete.cases(percent_exceed))

# Write to CSV
write.csv(San_Bernardino_county_summary_table, "consumption_San_Bernardino_county_summary.csv", row.names = FALSE)

```
##Can insert additional LOOPS for Ventura & santa barbara counties if desired

##Calculate consumption rate (household members)
```{r}
##Subset to only household consumers (<4 weeks)
##CHECK that each row = only one person
##CHECK that amount eaten and times eaten columns can be converted to Numeric

household_consumers <- fisherdb %>% filter(
                  `Amount_eaten_(Person_1)` >0  & `Times_eaten_last_4_weeks__(Person_1)`>0|
                  `Amount_eaten_(Person_2)` >0  & `Times_eaten_last_4_weeks__(Person_2)`>0|
                  `Amount_eaten_(Person_3)` >0  & `Times_eaten_last_4_weeks__(Person_3)`>0|
                  `Amount_eaten_(Person_4)` >0  & `Times_eaten_last_4_weeks__(Person_4)`>0
)

household_consumers_long <- household_consumers %>%
  mutate(fisherID = 1:nrow(.)) %>%
  select(-(`Previously_interviewed?`:`Caught_other,_cooking_method`))%>% 
  select(-(`Data_entry_by:_(initials)`:`Fish_consumer_(any_LA_lake)`))%>%
  pivot_longer(
    cols = starts_with("Relation_to_fisher"),
    names_to = "household_member",
    values_to = "Relation_to_fisher"
  )%>%
  mutate(Relation_to_fisher=(as.factor(Relation_to_fisher))) %>%
  filter(Relation_to_fisher != "NA" & Relation_to_fisher != "Na")%>%
  mutate(household_member = gsub("^Relation_to_fisher_","",household_member)) %>%
  mutate(household_member = gsub("^\\(|\\)$", "", household_member))%>%
  ##Associate correct data with each record
  ###Calculate daily intake
  mutate(daily_intake = case_when(
    household_member == "Person_1" ~ `Times_eaten_last_4_weeks__(Person_1)` *     `Amount_eaten_(Person_1)`,
     household_member == "Person_2" ~ `Times_eaten_last_4_weeks__(Person_2)` * `Amount_eaten_(Person_2)`,
     household_member == "Person_3" ~ `Times_eaten_last_4_weeks__(Person_3)` * `Amount_eaten_(Person_3)`,
     household_member == "Person_4" ~ `Times_eaten_last_4_weeks__(Person_4)` * `Amount_eaten_(Person_4)`,
    .default = NA
  )) %>%
mutate(daily_intake = (daily_intake * 227)/28) %>%
  ###Associate Age
mutate(hh_age = case_when(
    household_member == "Person_1" ~ `Age_(Person_1)`,
    household_member == "Person_2" ~ `Age_(Person_2)`,
    household_member == "Person_3" ~ `Age_(Person_3)`,
    household_member == "Person_4" ~ `Age_(Person_4)`,
  ))%>%
  ###Associate gender
mutate(hh_gender = case_when(
    household_member == "Person_1" ~ `Gender_(Person_1)`,
    household_member == "Person_2" ~ `Gender_(Person_2)`,
    household_member == "Person_3" ~ `Gender_(Person_3)`,
    household_member == "Person_4" ~ `Gender_(Person_4)`,
  )) %>%
  ###Associate species consumed
mutate(hh_species_consumed = case_when(
    household_member == "Person_1" ~ `Species_consumed_(Person_1)`,
    household_member == "Person_2" ~ `Species_consumed_(Person_2)`,
    household_member == "Person_3" ~ `Species_consumed_(Person_3)`,
    household_member == "Person_4" ~ `Species_consumed_(Person_4)`,
  )) %>%
  ###Associate parts_eaten
mutate(hh_parts_eaten = case_when(
    household_member == "Person_1" ~ `Parts_eaten_(Person_1)`,
    household_member == "Person_2" ~ `Parts_eaten_(Person_2)`,
    household_member == "Person_3" ~ `Parts_eaten_(Person_3)`,
    household_member == "Person_4" ~ `Parts_eaten_(Person_4)`,
  )) %>%
  ###Associate cooking_details
mutate(hh_cooking_details = case_when(
    household_member == "Person_1" ~ `Cooking_details_(Person_1)`,
    household_member == "Person_2" ~ `Cooking_details_(Person_2)`,
    household_member == "Person_3" ~ `Cooking_details_(Person_3)`,
    household_member == "Person_4" ~ `Cooking_details_(Person_4)`,
  ))%>%
  ###Remove extra rows
select(-(`Age_(Person_1)`:`Cooking_details_(Person_4)`)) %>%
  ##Separate hh_species_consumed into separate columns
separate(hh_species_consumed, into = c("hh_species1", "hh_species2", "hh_species3", "hh_species4"), sep = ",")


##Convert to long format by species for each household consumer
hh_consumers_species_long <- household_consumers_long %>%
  mutate(hh_consumerID = 1:nrow(.)) %>%
  pivot_longer(
    cols = starts_with("hh_species"),
    names_to = "delete",
    values_to = "hh_species_consumed"
  )%>%
  filter(complete.cases(hh_species_consumed))%>%
  mutate(hh_species_consumed = trimws(hh_species_consumed))%>%
###CHECK that all unique names are being captured
  mutate (hh_species_consumed = case_when(
    hh_species_consumed == "Rainbow Trout" ~ "Rainbow trout",
    hh_species_consumed == "Rainbow trout" ~ "Rainbow trout",
    hh_species_consumed == "Trout" ~ "Rainbow trout",
    hh_species_consumed == "Catfish" ~ "Catfish",
    hh_species_consumed == "Bluegill" ~ "Sunfish species",
    hh_species_consumed == "bluegill" ~ "Sunfish species",
    hh_species_consumed == "Common Carp" ~ "Common carp",
    hh_species_consumed == "Carp" ~ "Common carp",
    hh_species_consumed == "Bass" ~ "Black bass species",
    hh_species_consumed == "Crappie" ~ "Crappie",
    hh_species_consumed == "Tilapia"   ~ "Tilapia"  ,
    hh_species_consumed == "Other" ~ "Other",
    TRUE ~ hh_species_consumed #For species not listed above
  ))%>%
  group_by(hh_consumerID) %>%
  mutate(number_fish_sp = n()) %>%
  ungroup()%>%
  mutate(hh_total_daily_intake = daily_intake)%>%
  select(-c(delete , daily_intake))%>%
  ###Making the assumption that daily intake is divided evenly between the fish described. We may be    able to make this calculation more specific
  mutate(hh_daily_intake_per_fish = hh_total_daily_intake/number_fish_sp)%>%
###Next steps associate lakes + fish from person interviewed with household members...
  mutate (hh_lake = case_when(
    hh_species_consumed == "Rainbow trout"  ~ `Past_catches:_Rainbow_Trout,_times_eaten,_where`,
    hh_species_consumed == "Sunfish species" ~ `Past_catches:_Bluegill,_times_eaten,_where`,
    hh_species_consumed == "Catfish"   ~ `Past_catches:_Catfish,_times_eaten,_where`,
    hh_species_consumed == "Common carp"   ~ `Past_catches:_Common_Carp,_times_eaten,_where`,
    hh_species_consumed == "Crappie"  ~ `Past_catches:_Crappie,_times_eaten,_where` ,
    hh_species_consumed == "Black bass species" ~ `Past_catches:_Bass,_times_eaten,_where`,
  ))%>%
   ##Separate lake data into separate columns
separate(hh_lake, into = c("hh_lake1", "hh_lake2", "hh_lake3", "hh_lake4"), sep = ",")%>%
###pivot long by lake and divide consumption by lake
  pivot_longer(
    cols = starts_with("hh_lake"),
    names_to = "delete",
    values_to = "hh_lakes"
  )%>%
  filter(complete.cases(hh_lakes))%>%
  mutate(hh_lakes= trimws(hh_lakes))%>%
  group_by(hh_consumerID, hh_species_consumed) %>%
  mutate(number_lakes = n()) %>%
  ungroup() %>%
  mutate(hh_daily_intake_per_fish_per_lake = hh_daily_intake_per_fish/number_lakes)%>%
  select(-delete) %>%
  ###move this code earlier so that number of lakes is replaced with times from lake if there is a value
  separate(hh_lakes, into = c("hh_lakes", "times_from_lake"), sep = "\\(", fill = "right") %>%
  mutate(hh_lakes = trimws(hh_lakes))

 
```
##Household consumption x OEHHA thresholds

```{r}

###extract lake names to update key
hh_lake_names <- hh_consumers_species_long$hh_lakes
hh_lake_names <-trimws(hh_lake_names)
hh_lake_names <- unique(hh_lake_names)

#write.csv(hh_lake_names,"hh_lake_names.csv", row.names = FALSE)

##Names and counties were added to "unique_lake_names.csv" -- now import this dataset

unique_lake_names_key <- read.csv("unique_lake_names_key.csv")

##Join lakes & key to identify if any missed

df_hh_lake_names <- as.data.frame(hh_lake_names)
anti_join_lakes <- anti_join(df_hh_lake_names, unique_lake_names_key, by=c("hh_lake_names" = "original_name"))


##Update lake names with join
hh_consumers_species_long <- hh_consumers_species_long %>%
  left_join(unique_lake_names_key %>%
              select(original_name, lake , county), by = c("hh_lakes" = "original_name")) %>%
  rename(updated_lake_name = lake) %>%
  mutate(Age_Category =  case_when(
    hh_age < 18 ~ "< 18",
    hh_age >= 18 & hh_gender == "Male" ~ ">= 18",
    hh_age >= 18 & hh_age < 50 & hh_gender == "Female" ~ "18 - 49",
    hh_age > 50 & hh_gender == "Female" ~ ">= 50",
    .default = NA
  ))%>%
  mutate(hh_gender_original = case_when(
    hh_gender =="Female" ~"Female",
    hh_gender == "Male"~"Male"
  ))%>%
  mutate(hh_gender = case_when(
    hh_age <18 ~ "Child",
    hh_gender =="Female" ~"Female",
    hh_gender == "Male"~"Male"
  ))

##Join consumers with advisories
  hh_consumers_species_long <- hh_consumers_species_long   %>%
  left_join(advisories_long, by = c("updated_lake_name" = "lake", 
                                    "Age_Category" = "Age", 
                                    "hh_gender" = "Gender",
                                    "hh_species_consumed" = "join_fish_names"
                                    )) %>%
   rename(county = county.x)%>%
   select(-county.y)
  
##Fill in statewide advisories for lakes/fish where there are no lake specific consumption data
# Perform the left join only on the rows that meet the condition
hh_joined_data <- hh_consumers_species_long %>%
  filter(hh_daily_intake_per_fish_per_lake > 0 & is.na(column)) %>%
  left_join(statewide_adv, by = c("Age_Category" = "Age", 
                                  "hh_gender" = "Gender",
                                  "hh_species_consumed" = "join_fish_names"))%>%
  select(-lake)
  
# Keep the rows that do not meet the condition as they are
hh_non_joined_data <- hh_consumers_species_long %>%
  filter(!(hh_daily_intake_per_fish_per_lake > 0 & is.na(column)))
  
# Combine the two data frames back together
hh_consumers_species_long <- bind_rows(hh_joined_data, hh_non_joined_data) 

hh_consumers_species_long <-hh_consumers_species_long %>% 
  mutate(column = coalesce(column, statewide_column,),
         threshold_g_day = coalesce(threshold_g_day, statewide_threshold_g_day),
         OEHHA_fish_names = coalesce(OEHHA_fish_names, OEHHA_fish_names.y)
         )%>%
  select(-statewide_column, - statewide_threshold_g_day, -OEHHA_fish_names.x, - OEHHA_fish_names.y)%>%
  group_by(hh_species_consumed, hh_consumerID) %>%
  mutate(avg_threshold = mean(threshold_g_day))%>%
  ungroup()%>%
 ##Does consumption by each individual from one lake exceed threshold for that specific lake
   mutate(exceed_threshold_indiv_lake = hh_daily_intake_per_fish_per_lake > threshold_g_day) %>%
##Does total consumption by each individual from all lakes exceed average threshold for one lake or all lakes 
  mutate(exceed_threshold_avg_lake = exceed_threshold_indiv_lake | (hh_daily_intake_per_fish > avg_threshold))
  
##During data clean up - check NAs here. Explore why.
##Need to check code to make sure things are filtering & calculating as expected
write.csv(hh_consumers_species_long, "hh_consumers_long.csv", , row.names = FALSE)

```


##hh LOOP ALL
```{r}

# List of fish species to analyze
fish_species <- list(
  "All" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "All" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

lakes <- list(
  "All" = unique(consumers_long$updated_lake_name)
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
    
  ### Percent of consumers exceeding thresholds by lake (Exceed lake specific threshold by consuming fish ONLY at that lake) OF if all LA county then calculating contribution of LA county lakes specifically 
      per_exceed_thresh_all_hh <- hh_consumers_species_long %>%
        group_by(hh_consumerID)%>%
        filter(hh_total_daily_intake > 0) %>%
        filter(hh_species_consumed %in% selected_fish) %>%
        filter(column %in% selected_age)%>%
        filter(updated_lake_name %in% selected_lake) %>%
        summarise(any_hh_exceeded_all = any(exceed_threshold_indiv_lake)) %>% #Groups by hh_consumerID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold by eating fish at lakes in LA and false if they have not. 
        ungroup() %>%
        filter(!is.na(any_hh_exceeded_all)) %>% #filters out NAs so that only TRUE / FALSE values are being assessed 
        summarise(percent_exceed = round((sum(any_hh_exceeded_all) / n()) * 100)) %>%
        mutate(lakes = lake_name) %>%  # Add a column for the label
        mutate(fish = fish_name) %>%
        mutate(age = age_group) %>%
        select(lakes, age, fish, everything())
      
  
    ### Percent of consumers exceeding avg thresholds
    
    per_exceed_avg_thresh_all_hh <- hh_consumers_species_long %>%
    group_by(hh_consumerID) %>%
    filter(hh_total_daily_intake > 0) %>%
    filter(hh_species_consumed %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(exceed_threshold = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(exceed_threshold)) %>%
    summarise(percent_exceed_lake = round((sum(exceed_threshold) / n()) * 100)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish =fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### All consumers consumption rate
  all_consumption_rate <- hh_consumers_species_long%>%
    group_by(hh_consumerID) %>%
    filter(hh_total_daily_intake > 0) %>%
    filter(hh_species_consumed %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(hh_daily_intake_per_fish_per_lake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh_all_hh)
  summary_table <- left_join(summary_table, per_exceed_avg_thresh_all_hh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}

# Combine all summary tables into a single data frame
hh_all_lakes_summary_table <- bind_rows(summary_tables)
hh_all_lakes_summary_table <- hh_all_lakes_summary_table %>%
  filter(complete.cases(median))
    
    
    # Write to CSV
write.csv(hh_all_lakes_summary_table, "hh_consumption_summary_all.csv", row.names = FALSE)
    
    

```

##hh LOOP LA
```{r}

###START here subsetting for LA
LA_county_hh_consumers <- hh_consumers_species_long %>%
  filter(county == "Los Angeles")%>%
  group_by(hh_species_consumed, hh_consumerID) %>%
  mutate(daily_intake_LA = sum(hh_daily_intake_per_fish_per_lake))%>%
  mutate(avg_LAthreshold = mean(threshold_g_day)) %>%
  ungroup()%>%
  mutate(exceed_threshold_LA_lake = exceed_threshold_indiv_lake | daily_intake_LA>avg_LAthreshold)

datacheck <- LA_county_hh_consumers %>% select(hh_consumerID, hh_species_consumed, hh_lakes, number_lakes,hh_total_daily_intake, hh_daily_intake_per_fish, hh_daily_intake_per_fish_per_lake, threshold_g_day, threshold_used, avg_threshold, daily_intake_LA, avg_LAthreshold, exceed_threshold_LA_lake, threshold_g_day, avg_threshold, exceed_threshold_indiv_lake, exceed_threshold_avg_lake)

# List of fish species to analyze
fish_species <- list(
  "All" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "All" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)
##CHECK list of lakes is updated
lakes <- list(
  "All LA county" = unique(LA_county_hh_consumers$updated_lake_name),
  #"all_surveyed" = c("Legg lake","Alondra park","Peck Road"),
  "Alondra park" = "Alondra park",
  "Legg lake" = "Legg lake",
  "Peck Road" = "Peck Road",
  "Belvedere Park"="Belvedere Park",
"Cerritos Park Lake / Don Knabe"="Cerritos Park Lake / Don Knabe",
 "Crystal Lake" = "Crystal Lake" ,
"El Dorado Park Lake"="El Dorado Park Lake",
"Hollenbeck Park Lake" ="Hollenbeck Park Lake" ,
"Kenneth Hahn/Gwen Moore Lake" ="Kenneth Hahn/Gwen Moore Lake" ,
"MacArthur Park" = "MacArthur Park" ,
"Puddingstone reservoir" ="Puddingstone reservoir",  
"Pyramid lake" ="Pyramid lake",
  "Santa Fe Dam lake"  = "Santa Fe Dam lake"
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
    
    
  ### Percent of consumers exceeding thresholds by lake (Exceed lake specific threshold by consuming fish ONLY at that lake) OF if all LA county then calculating contribution of LA county lakes specifically 
    if (lake_name == "All LA county"){
      per_exceed_thresh_LA_hh <- LA_county_hh_consumers %>%
        group_by(hh_consumerID)%>%
        filter(daily_intake_LA > 0) %>%
        filter(hh_species_consumed %in% selected_fish) %>%
        filter(column %in% selected_age)%>%
        filter(updated_lake_name %in% selected_lake) %>%
        summarise(any_hh_exceeded_lalake = any(exceed_threshold_LA_lake)) %>% #Groups by hh_consumerID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold by eating fish at lakes in LA and false if they have not. 
        ungroup() %>%
        filter(!is.na(any_hh_exceeded_lalake)) %>% #filters out NAs so that only TRUE / FALSE values are being assessed 
        summarise(percent_exceed = round((sum(any_hh_exceeded_lalake) / n()) * 100)) %>%
        mutate(lakes = lake_name) %>%  # Add a column for the label
        mutate(fish = fish_name) %>%
        mutate(age = age_group) %>%
        select(lakes, age, fish, everything())
    } else {
      per_exceed_thresh_LA_hh <- LA_county_hh_consumers %>%
        group_by(hh_consumerID)%>%
        filter(daily_intake_LA > 0) %>%
        filter(hh_species_consumed %in% selected_fish) %>%
        filter(column %in% selected_age)%>%
        filter(updated_lake_name %in% selected_lake) %>%
        summarise(any_hh_exceeded_lalake = any(exceed_threshold_indiv_lake)) %>% #Groups by hh_consumerID, filters based on selected parameters, then summarizes by assigning "TRUE" if the individual has exceeded the threshold by eating fish at lakes in LA and false if they have not. 
        ungroup() %>%
        filter(!is.na(any_hh_exceeded_lalake)) %>% #filters out NAs so that only TRUE / FALSE values are being assessed 
        summarise(percent_exceed = round((sum(any_hh_exceeded_lalake) / n()) * 100)) %>%
        mutate(lakes = lake_name) %>%  # Add a column for the label
        mutate(fish = fish_name) %>%
        mutate(age = age_group) %>%
        select(lakes, age, fish, everything())
      
    }
    ### Percent of consumers exceeding avg thresholds
    
    per_exceed_avg_thresh_LA_hh <- LA_county_hh_consumers %>%
    group_by(hh_consumerID) %>%
    filter(hh_total_daily_intake > 0) %>%
    filter(hh_species_consumed %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(exceed_threshold = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(exceed_threshold)) %>%
    summarise(percent_exceed_lake = round((sum(exceed_threshold) / n()) * 100)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish =fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### All consumers consumption rate
  all_consumption_rate <- LA_county_hh_consumers%>%
    group_by(hh_consumerID) %>%
    filter(hh_total_daily_intake > 0) %>%
    filter(hh_species_consumed %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(hh_daily_intake_per_fish_per_lake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE)),
      max = round(max(total_daily_intake, na.rm = TRUE)),
      mean = round(mean(total_daily_intake, na.rm = TRUE)),
      median = round(median(total_daily_intake, na.rm = TRUE))
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh_LA_hh)
  summary_table <- left_join(summary_table, per_exceed_avg_thresh_LA_hh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
hh_LA_lakes_summary_table <- bind_rows(summary_tables)
hh_LA_lakes_summary_table <- hh_all_lakes_summary_table %>%
  filter(complete.cases(median))

# Write to CSV
write.csv(hh_LA_lakes_summary_table, "hh_consumption_summary.csv", row.names = FALSE)



```

##Age histogram

```{r }
fisherdb <- fisherdb %>%
  mutate(Age= as.numeric(Age))
summary(fisherdb$Age)

fisherdb <- fisherdb %>%
  mutate(`Observed_Gender` = case_when(
   # `Observed_Gender` %in% c("unknown") ~ "Male",
    TRUE ~ `Observed_Gender`
  ))

fisher_hist <-ggplot(fisherdb, aes(x = Age, fill = Observed_Gender)) +
  geom_histogram(binwidth = 10, color = "#000000") +
  labs(
    title = "",
    x = "Age",
    y = "Frequency",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#ff8900","#15607a","gray"))+
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "top",)

fisher_hist

##histogram of age/gendre of fishers who consume fish
fish_consumers <- consumers_long %>%
  group_by(rowID) %>%
  summarise(Age = first(Age), Observed_Gender = first(Observed_Gender)) %>%
  ungroup()

fisher_consumer_hist <- ggplot(fish_consumers, aes(x = Age, fill = Observed_Gender)) +
  geom_histogram(binwidth = 10, boundary = 0, color = "black") +
  labs(
    title = "",
    x = "Age",
    y = "Frequency",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("gray","#ff8900","#15607a"))+
  scale_y_continuous(limits=c(0,15))+
  scale_x_continuous(limits=c(0,100),breaks = seq(0,100, by = 10))+
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "none",)

fisher_consumer_hist

##histogram age/gender household (hh) members

hh_age <- hh_consumers_species_long %>%
  mutate(across(c(hh_gender_original),as.factor))%>%
  filter(hh_daily_intake_per_fish>0)%>%
  group_by(fisherID, household_member,hh_age,hh_gender_original)%>%
  summarize(sum(hh_daily_intake_per_fish_per_lake))%>%
  ungroup()

hh_hist <-ggplot(hh_age, aes(x = hh_age, fill = hh_gender_original)) +
  geom_histogram(binwidth = 10, boundary = 0, color = "black") +
  labs(
    title = "",
    x = "Age",
    y = "Frequency",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#ff8900","#15607a","gray"))+
  scale_y_continuous(limits=c(0,15))+
  scale_x_continuous(limits=c(0,100),breaks = seq(0,100, by = 10) ) +
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "bottom")

hh_hist

####Export

stacked_hist <- fisher_consumer_hist + 
  ggtitle("Consumers (fishers)") + 
  hh_hist + 
  ggtitle("Consumers (household)") + 
  plot_layout(ncol = 1)  # Stack vertically

# Print the combined plot
stacked_hist

plot_height <- 1700
plot_width <- 1700

ggsave(
  filename = "age_histogram.svg",
  plot = stacked_hist, width = plot_width, height = plot_height, units = "px", dpi = 300
)

```


#EXTRA CODE
$$ ##remove dollar signs to open up code
```{r}
##Check if any of this is still necessary

summarize_fish_names <- consumers_long %>%
  group_by(Catches_Info)%>%
  summarize(min(threshold_g_day, na.rm = TRUE))%>%
  ungroup()

#example percent of people at each park exceeding 300 grams per day for any fish
percent_people <- consumers_long %>%
  mutate(threshold = 300) %>%
  mutate(exceeded = daily_intake > threshold) %>%
  group_by(rowID, updated_name) %>%
  summarise(any_exceeded = any(exceeded)) %>% #Get a list of which people exceeded a threshold at least once. 
  ungroup() %>%
  filter(!is.na(any_exceeded)) %>%
  group_by(updated_name) %>%
  summarise(percent_people_exceeding = sum(any_exceeded)/n()) #Count the total number of people and excedences to summarise the final result. 


##Take2
consumers_long <- consumers %>%
  mutate(rowID = 1:nrow(.))%>%
  mutate(across(matches("Past_catches:.*times_eaten$"),as.character))%>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = matches("Past_catches:.*times_eaten,_where|Past_catches:.*times_eaten$"),
    names_to = "Catches_Info",
    values_to = "Values"
  ) %>%
  # Step 2: Separate the lake names into individual rows and handle Time Eaten
 # mutate(Catches_Info = gsub("(Past_catches:_)|(,.*)", "", Catches_Info)) %>%
 # mutate(Catches_Info = gsub("_", " ", Catches_Info)) %>%
  
 separate(Catches_Info, into = c("Catches_Info", "Suffix"), sep = "(_where|_eaten)$", remove = FALSE) %>%
  mutate(
    Time_Eaten = if_else(Suffix == "_eaten", Values, NA_character_),
    Lakes = if_else(Suffix == "_where", Values, NA_character_)
  ) %>%
  # Step 3: Remove unnecessary columns and rows with NA
  select(rowID, Age, Observed_Gender, Catches_Info, Lakes, Time_Eaten) 
#%>%  filter(!is.na(Lakes)) 
  #%>% separate_rows(Lakes, sep = ",")


###

consumers <- consumers %>%
  separate (`Past_catches:_Rainbow_Trout,_times_eaten,_where`,
            into = c("RT_lake1", "RT_lake2", "RT_lake3", "RT_lake4"),
            sep = ",",
            remove = FALSE)


datacheck <- consumers %>% select(c(`Past_catches:_Rainbow_Trout,_times_eaten,_where`, RT_lake1, RT_lake2, RT_lake3, RT_lake4))


consumers <- consumers %>% 
  

###






rt_adv <- statewide_adv %>% filter(
  Fish=="Rainbow trout")
crappie_adv <- statewide_adv %>% filter(
  Fish=="Crappie species")4
sunfish_adv <- statewide_adv %>% filter(
  Fish=="Sunfish species")
blackbass_adv <- statewide_adv %>% filter(
  Fish=="Black bass species")
catfish_adv <- statewide_adv %>% filter(
  Fish=="Catfish species")
carp_adv <- statewide_adv %>% filter(
  Fish=="Common carp")

##Calculate threshold exceedance
#rainbow trout 
consumers <- consumers %>%
  mutate(
    rainbow_trout_threshold = case_when(
      Age < 18 ~ rt_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ rt_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ rt_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ rt_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    rt_exceed_thresh = rainbow_trout_threshold < rainbow_trout_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Rainbow_Trout,_times_eaten,_where`, y=rainbow_trout_g_day))+
  geom_point(aes(color = rt_exceed_thresh))+
  coord_flip()
datacheck <- consumers %>%
  select( c(Age,Observed_Gender,rainbow_trout_threshold, rainbow_trout_g_day ,rt_exceed_thresh))

#catfish 
consumers <- consumers %>%
  mutate(
    catfish_threshold = case_when(
      Age < 18 ~ catfish_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ catfish_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ catfish_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ catfish_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    catfish_exceed_thresh = catfish_threshold < catfish_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Catfish,_times_eaten,_where`, y=catfish_g_day))+
  geom_point(aes(color = catfish_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,catfish_threshold, catfish_g_day ,catfish_exceed_thresh))

#bluegill
consumers <- consumers %>%
  mutate(
    bluegill_threshold = case_when(
      Age < 18 ~ sunfish_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ sunfish_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ sunfish_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ sunfish_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    bluegill_exceed_thresh = bluegill_threshold < bluegill_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Bluegill,_times_eaten,_where`, y=bluegill_g_day))+
  geom_point(aes(color = bluegill_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,bluegill_threshold, bluegill_g_day ,bluegill_exceed_thresh))

#Black bass
consumers <- consumers %>%
  mutate(
    blackbass_threshold = case_when(
      Age < 18 ~ blackbass_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ blackbass_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ blackbass_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ blackbass_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    blackbass_exceed_thresh = blackbass_threshold < bass_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Bass,_times_eaten,_where`, y=bass_g_day))+
  geom_point(aes(color = blackbass_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,blackbass_threshold, bass_g_day ,blackbass_exceed_thresh))

#Carp
consumers <- consumers %>%
  mutate(
    carp_threshold = case_when(
      Age < 18 ~ carp_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~  carp_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~  carp_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~  carp_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    carp_exceed_thresh = carp_threshold < carp_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Common_Carp,_times_eaten,_where`, y=carp_g_day))+
  geom_point(aes(color = carp_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,carp_threshold, carp_g_day ,carp_exceed_thresh))
```
####Data summaries
#####All lakes
######all species

```{r}
#Summarize consumers at all lakes
##All species
###Percent of consumers exceeding threshold
per_all_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "all") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
all_summary_table <- all_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "all") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
all_summary_table <- left_join(all_summary_table, per_all_exceed_thresh)

```

######rainbow trout
```{r}
##all lakes rainbow trout

###Percent of consumers exceeding threshold
per_rt_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Rainbow trout")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "rainbow trout") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_rt_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Rainbow trout")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
rt_summary_table <- all_rt_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "rainbow trout") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
rt_summary_table <- left_join(rt_summary_table, per_rt_exceed_thresh)
```

######catfish
```{r}
##all lakes catfish

###Percent of consumers exceeding threshold
per_cat_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names %in% c("Catfish species", "Channel catfish")) %>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Catfish species") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_cat_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names %in% c("Catfish species", "Channel catfish")) %>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
cat_summary_table <- all_cat_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Catfish species") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
cat_summary_table <- left_join(cat_summary_table, per_cat_exceed_thresh)
```
######sunfish
```{r}
##all lakes sunfish

###Percent of consumers exceeding threshold
per_sunfish_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Sunfish species")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Sunfish species") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_sunfish_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Sunfish species")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
sunfish_summary_table <- all_sunfish_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Sunfish species") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
sunfish_summary_table <- left_join(sunfish_summary_table, per_sunfish_exceed_thresh)
```
######carp
```{r}
##All lakes Carp

###Percent of consumers exceeding threshold
per_carp_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Common carp")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Common carp") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_carp_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Common carp")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
carp_summary_table <- all_carp_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Common carp") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
carp_summary_table <- left_join(carp_summary_table, per_carp_exceed_thresh)
```
######bass
```{r}
##All lakes Bass

###Percent of consumers exceeding threshold
per_bass_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Black bass species")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Black bass species") %>%
  select(lakes, fish, everything())

##All consumers consumption rate

all_bass_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Black bass species")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
bass_summary_table <- all_bass_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Black bass species") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
bass_summary_table <- left_join(bass_summary_table, per_bass_exceed_thresh) %>%
  select(lakes, fish, everything()) 

bass_summary_table <- left_join(bass_summary_table, per_bass_exceed_thresh)
```
######crappie
```{r}
##All lakes Crappie

###Percent of consumers exceeding threshold
per_crappie_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Crappie species")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Crappie species") %>%
  select(lakes, fish, everything())

##All consumers consumption rate

all_crappie_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Crappie species")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
crappie_summary_table <- all_crappie_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Crappie species") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
crappie_summary_table <- left_join(crappie_summary_table, per_crappie_exceed_thresh) %>%
  select(lakes, fish, everything()) 

crappie_summary_table <- left_join(crappie_summary_table, per_crappie_exceed_thresh)

```



####Combine summary tables

```{r}
all_lakes_summary_table <- bind_rows(all_summary_table, rt_summary_table, cat_summary_table, sunfish_summary_table, carp_summary_table, bass_summary_table, crappie_summary_table)

write.csv(all_lakes_summary_table,"consumption_summary.csv", row.names = FALSE)
```

####Test data summaries
######rainbow trout
```{r}

# List of fish species to analyze
fish <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

# Initialize an empty list to store summary tables
summary_tables <- list()

lakes = "all"
age = "all"

for (fish in names(fish)) {

###Percent of consumers exceeding threshold
per_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(Catches_Info == fish) %>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = lakes) %>%  # Add a column for the label
  mutate(fish = fish) %>%
  mutate(age = age) %>%
  select(lakes, age,  fish, everything()) 
##All consumers consumption rate

all_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(Catches_Info == fish)%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
summary_table <- all_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes) %>%  # Add a column for the label
  mutate(fish) %>%
  mutate (age)%>%
  select(lakes, age, fish,everything())  # Move the label column to the front
  
summary_table <- left_join(summary_table, per_exceed_thresh)


  # Store the summary table in the list
  summary_tables[[fish]] <- summary_table
  
  }

# Combine all summary tables into a single data frame
all_lakes_summary_table <- bind_rows(summary_tables)
```
######Age histogram

```{r }
fisherdb <- fisherdb %>%
  mutate(Age= as.numeric(Age))
summary(fisherdb$Age >100)

fisherdb <- fisherdb %>%
  mutate(`Observed_Gender` = case_when(
    `Observed_Gender` %in% c("unknown") ~ "Male",
    TRUE ~ `Observed_Gender`
  ))

ggplot(fisherdb, aes(x = Age, fill = Observed_Gender)) +
  geom_histogram(binwidth = 10, color = "black") +
  labs(
    title = "",
    x = "Age",
    y = "Frequency",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#D47E6A","#248B87","gray"))+
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "top",)

```

