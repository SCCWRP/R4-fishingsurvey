---
title: "R4 Fish Consumption Calculations"
author: "Tori McGruer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## Install libraries
```{r message=TRUE}
library(tidyverse)
library(readxl)
library(ggplot2)
```
## Import data
```{r ,include=FALSE}

path <- c("//pacific/Toxicology/tox/Risk Assessment/Region4_Urban lakes fishers survey/Survey data/Data entry/Working_FisherSurveryDatabase.xlsm")

excel_sheets(path)

fisherdb_import <-read_excel(path, sheet = "Interviews")

colnames<-colnames(fisherdb_import)
colnames

#Replace spaces with underscores in column names
names(fisherdb_import) <- gsub(" ", "_", names(fisherdb_import))
names(fisherdb_import)

###CHECK errors when converting to numeric / factor - are we losing data by introducing NAs
#Convert to numeric / factor
fisherdb <- fisherdb_import %>%
  mutate(across(c(`Past_catches:_Rainbow_Trout,_times_eaten`, 
                  `Past_catches:_Catfish,_times_eaten`, 
                  `Past_catches:_Bluegill,_times_eaten`,
                  `Past_catches:_Common_Carp,_times_eaten`,
                  `Past_catches:_Bass,_times_eaten`,
                  `Past_catches:_Crappie,_times_eaten`,
                  `Past_catches:_Tilapia,_times_eaten`,
                  `Past_catches:_other,_times_eaten`,
                  
                  `Past_catches:_Rainbow_Trout,_amount_eaten`,
                  `Past_catches:_Catfish,_amount_eaten`,
                  `Past_catches:_Blue_gill,_amount_eaten`,
                  `Past_catches:_Common_Carp,_amount_eaten`,
                  `Past_catches:_Bass,_amount_eaten`,
                  `Past_catches:_Crappie,_amount_eaten`,
                  `Past_catches:_Tilapia,_amount_eaten`,
                  `Past_catches:_other,_amount_eaten`,
                  
                  `Age_(Person_1)`,
                  `Age_(Person_2)`,
                  `Age_(Person_3)`,
                  `Age_(Person_4)`,
                  Age,
                  
                  `Amount_eaten_(Person_1)`,
                  `Amount_eaten_(Person_2)`,
                  `Amount_eaten_(Person_3)`,
                  `Amount_eaten_(Person_4)`,
                  
                  `Times_eaten_last_4_weeks__(Person_1)`,
                  `Times_eaten_last_4_weeks__(Person_2)`,
                  `Times_eaten_last_4_weeks__(Person_3)`,
                  `Times_eaten_last_4_weeks__(Person_4)`
                  
                  ), as.numeric)) %>%
  
 mutate(across(c( Observed_Gender
 ),as.factor))

##Confirm NAs introduced are okay
##Why are NAs not reading in as NA?

summary(as.factor(fisherdb_import$`Past_catches:_Rainbow_Trout,_times_eaten`))
summary(as.factor(fisherdb_import$`Past_catches:_Catfish,_times_eaten`))
summary(as.factor(fisherdb_import$`Past_catches:_Bluegill,_times_eaten`))
summary(as.factor(fisherdb_import$`Past_catches:_Common_Carp,_times_eaten`))
summary(as.factor(fisherdb_import$`Past_catches:_Bass,_times_eaten`))
summary(as.factor(fisherdb_import$`Past_catches:_Crappie,_times_eaten`))
summary(as.factor(fisherdb_import$`Past_catches:_Tilapia,_times_eaten`))
summary(as.factor(fisherdb_import$`Past_catches:_other,_times_eaten`))


original_NA_count <- sum(is.na(as.factor(fisherdb_import$`Past_catches:_Rainbow_Trout,_times_eaten`)))
new_NA_count <- sum(is.na(fisherdb$`Past_catches:_Rainbow_Trout,_times_eaten`))
coercion_na_count <- new_NA_count - original_NA_count

# Print out the comparison
if(coercion_na_count == 0) {
  print("No new NAs were introduced by coercion.", `Past_catches:_Rainbow_Trout,_times_eaten`)
} else {
  print(paste("Number of new NAs introduced by coercion:", coercion_na_count))
}

### TEST


```

#Identify unique lakes
```{r}
#using unlist and strsplit1
lake_names <- unlist(strsplit(c(fisherdb$Likely_Fishing_Location_1, 
                fisherdb$Likely_Fishing_Location_2, 
                fisherdb$Likely_Fishing_Location_3,
                fisherdb$`Past_catches:_Rainbow_Trout,_Where`,
                fisherdb$`Past_catches:_Catfish,_where`,
                fisherdb$`Past_catches:_Bluegill,_where`,
                fisherdb$`Past_catches:_Common_Carp,_where`,
                fisherdb$`Past_catches:__Bass,_where`,
                fisherdb$`Past_catches:_Crappie,_where`,
                fisherdb$`Past_catches:_Tilapia,_where`,
                fisherdb$`Past_catches:_other,_where`),","))

lake_names <-trimws(lake_names)
unique_lake_names <- unique(trimws(lake_names))
write.csv(unique_lake_names,"unique_lake_names.csv", row.names = FALSE)

##Names and counties were added to "unique_lake_names.csv" -- now import this dataset

unique_lake_names_key <- read.csv("unique_lake_names_key.csv",strip.white = TRUE)

##Join lakes & key to identify if any missed

df_unique_lake_names <- as.data.frame(unique_lake_names)
anti_join_lakes <- anti_join(df_unique_lake_names, unique_lake_names_key, by=c("unique_lake_names" = "original_name"))

#write.csv(anti_join_lakes, "anti_join_lakes.csv", row.names = FALSE)
```



#Calculate consumption rate (Fishers)
```{r}
##Subset to only fish consumers (<4 weeks)
consumers <- fisherdb %>% filter(
                  `Past_catches:_Rainbow_Trout,_times_eaten` >0 |
                  `Past_catches:_Catfish,_times_eaten`>0 |
                  `Past_catches:_Bluegill,_times_eaten`>0|
                  `Past_catches:_Common_Carp,_times_eaten`>0 |
                  `Past_catches:_Bass,_times_eaten`>0 |
                  `Past_catches:_Crappie,_times_eaten`>0 |
                  `Past_catches:_Tilapia,_times_eaten`>0|
                  `Past_catches:_other,_times_eaten`>0
)

###Calculate consumption

consumers <- consumers %>%
  mutate(
    rainbow_trout_g_day = na_if(
      ((`Past_catches:_Rainbow_Trout,_times_eaten` * `Past_catches:_Rainbow_Trout,_amount_eaten` * 227) / 28), 0),
    catfish_g_day = na_if(
      ((`Past_catches:_Catfish,_times_eaten` * `Past_catches:_Catfish,_amount_eaten` * 227) / 28), 0),
    bluegill_g_day = na_if(
      ((`Past_catches:_Bluegill,_times_eaten` * `Past_catches:_Blue_gill,_amount_eaten` * 227) / 28), 0),
    carp_g_day = na_if(
      ((`Past_catches:_Common_Carp,_times_eaten` * `Past_catches:_Common_Carp,_amount_eaten` * 227) / 28), 0),
    bass_g_day = na_if(
      ((`Past_catches:_Bass,_times_eaten` * `Past_catches:_Bass,_amount_eaten` * 227) / 28), 0),
    crappie_g_day = na_if(
      ((`Past_catches:_Crappie,_times_eaten` * `Past_catches:_Crappie,_amount_eaten` * 227) / 28), 0),
    tilapia_g_day = na_if(
      ((`Past_catches:_Tilapia,_times_eaten` * `Past_catches:_Tilapia,_amount_eaten` * 227) / 28), 0),
    other_g_day = na_if(
      ((`Past_catches:_other,_times_eaten` * `Past_catches:_other,_amount_eaten` * 227) / 28), 0)
  )

    
ggplot(consumers, aes(x= `Past_catches:_Rainbow_Trout,_times_eaten,_where`, y=rainbow_trout_g_day))+
  geom_point()+  coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Catfish,_times_eaten,_where`, y=catfish_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Bluegill,_times_eaten,_where`, y=bluegill_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Common_Carp,_times_eaten,_where`, y=carp_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Bass,_times_eaten,_where`, y=bass_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Crappie,_times_eaten,_where`, y=crappie_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Tilapia,_times_eaten,_where`, y=tilapia_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Other,_times_eaten,_where`, y=other_g_day))+
  geom_point()+coord_flip()



```
###Test- create loop for OEHHA thresholds



#Compare consumption rate to statewide OEHHA thresholds
```{r}
##import thresholds
path <- "//pacific/Toxicology/tox/Risk Assessment/Region4_Urban lakes fishers survey/Resources/OEHHA consumption advisories/OEHHA_consumption_advisories.xlsx"

excel_sheets(path)
advisories <-read_excel(path, sheet = "Lake advisories")
advisories <- advisories %>% mutate(across(
  c(lake,county, OEHHA_fish_names, join_fish_names), as.factor)
)

##Separate lakes in times_eaten_where into separate columns
#unique_fish <- unique(consumers_long$Catches_Info)

advisories_long <- advisories %>%
   #mutate(rowID = 1:nrow(.))%>%
  select(-(srv_per_wk_child:child_serv_g), - Source, - Notes) %>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = threshold_g_day_child:threshold_g_day_men18,
    names_to = "column",
    values_to = "threshold_g_day"
  ) %>%
  mutate(Gender = case_when(
      grepl("child", column) ~ "Child",
      grepl("women", column) ~ "Female",
      grepl("men", column) ~ "Male",
      .default = NA
  )) %>%
  mutate(Age = case_when(
      grepl("_men18", column) ~ ">= 18",
      grepl("18_49", column) ~ "18 - 49",
      grepl("50", column) ~ ">= 50",
      grepl("child", column) ~ "< 18",
      .default = NA
  ))

consumers_long <- consumers %>%
  mutate(rowID = 1:nrow(.)) %>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = starts_with("Past_catches:") & ends_with("times_eaten,_where"),
    names_to = "Catches_Info",
    values_to = "Lakes"
  ) %>%
  # Step 2: Separate the lake names into individual rows
  separate_rows(Lakes, sep = ",") %>%
  mutate(Catches_Info = gsub("(Past_catches:_)|(,.*)", "", Catches_Info)) %>%
  mutate(Catches_Info = gsub("_", " ", Catches_Info)) %>%
  mutate(Lakes = trimws(Lakes))%>%
  # Step 3: Select the columns to keep
  select(rowID, Age, Observed_Gender, Catches_Info, Lakes, starts_with("Past_catches:") & ends_with(",_times_eaten"), starts_with("Past_catches:") & ends_with(",_amount_eaten")) %>%
  rename(`Past_catches:_Bluegill,_amount_eaten`= `Past_catches:_Blue_gill,_amount_eaten`) %>% 
  ###Calculate consumption rate of each fish at each lake per person
  mutate(daily_intake = case_when(
    Catches_Info == "Rainbow Trout" ~ `Past_catches:_Rainbow_Trout,_times_eaten` * `Past_catches:_Rainbow_Trout,_amount_eaten`,
    Catches_Info == "Catfish" ~ `Past_catches:_Catfish,_times_eaten` * `Past_catches:_Catfish,_amount_eaten`,
    Catches_Info == "Common Carp" ~ `Past_catches:_Common_Carp,_times_eaten` * `Past_catches:_Common_Carp,_amount_eaten`,
    Catches_Info == "Crappie" ~ `Past_catches:_Crappie,_times_eaten` * `Past_catches:_Crappie,_amount_eaten`,
    Catches_Info == "other" ~ `Past_catches:_other,_times_eaten` * `Past_catches:_other,_amount_eaten`,
    Catches_Info == "Tilapia" ~ `Past_catches:_Tilapia,_times_eaten` * `Past_catches:_Tilapia,_amount_eaten`,
    Catches_Info == "Bluegill" ~ `Past_catches:_Bluegill,_times_eaten` * `Past_catches:_Bluegill,_amount_eaten`,
    Catches_Info == "Bass" ~ `Past_catches:_Bass,_times_eaten` * `Past_catches:_Bass,_amount_eaten`,
    .default = NA
  )) %>%
  mutate(daily_intake = (daily_intake * 227)/28) %>%
  group_by(Catches_Info, rowID) %>%
  mutate(number_lakes = n()) %>%
  ungroup() %>%
  mutate(daily_intake_per_lake = daily_intake/number_lakes) %>% 
  separate(Lakes, into = c("Lakes", "times_from_lake"), sep = "\\(", fill = "right") %>%
  mutate(Lakes = trimws(Lakes))

###extract lake names to update key
lake_names <- consumers_long$Lakes
lake_names <-trimws(lake_names)
unique_lake_names <- unique(lake_names)
write.csv(unique_lake_names,"unique_lake_names.csv", row.names = FALSE)

##Names and counties were added to "unique_lake_names.csv" -- now import this dataset

unique_lake_names_key <- read.csv("unique_lake_names_key.csv")

##Join lakes & key to identify if any missed

df_unique_lake_names <- as.data.frame(unique_lake_names)
anti_join_lakes <- anti_join(df_unique_lake_names, unique_lake_names_key, by=c("unique_lake_names" = "original_name"))


##Update lake names with join
consumers_long <- consumers_long %>%
  left_join(unique_lake_names_key %>%
              select(original_name, lake , county), by = c("Lakes" = "original_name")) %>%
  rename(updated_lake_name = lake) %>%
  mutate(Observed_Gender = as.character(Observed_Gender)) %>%
  mutate(Observed_Gender = ifelse(Age < 18, "Child", Observed_Gender)) %>%
  mutate(Age_Category =  case_when(
    Age < 18 ~ "< 18",
    Age >= 18 & Observed_Gender == "Male" ~ ">= 18",
    Age >= 18 & Age < 50 & Observed_Gender == "Female" ~ "18 - 49",
    Age > 50 & Observed_Gender == "Female" ~ ">= 50",
    .default = NA
  ))

##update fish names to match OEHHA categories
consumers_long <- consumers_long %>%
  mutate (Catches_Info = case_when(
    Catches_Info == "Rainbow Trout" ~ "Rainbow trout",
    Catches_Info == "Catfish" ~ "Catfish",
    Catches_Info == "Bluegill" ~ "Sunfish species",
    Catches_Info == "Common Carp" ~ "Common carp",
    Catches_Info == "Bass" ~ "Black bass species",
    Catches_Info == "Crappie" ~ "Crappie",
    Catches_Info == "Tilapia"   ~ "Tilapia"  ,
    Catches_Info == "Other" ~ "Other",
    
  ))
#datacheck <- consumers_long %>% select(Catches_Info, fish)
  
##checking age categories

age_check <- consumers_long %>% select (rowID,Observed_Gender, Age, Age_Category)

##Check that advisory categories match
unique_lake_names_key <- read.csv("unique_lake_names_key.csv")
anti_join_lakes <- anti_join(advisories_long, consumers_long, by=c("lake" = "updated_lake_name"))
print(list(unique(anti_join_lakes$lake)))

##Create separate dataset for statewide framework

statewide_adv <- advisories_long %>% filter(
  lake == "Statewide") %>%
  rename(threshold_used = county,
         statewide_column = column,
         statewide_threshold_g_day = threshold_g_day)


##Join consumers with advisories
  consumers_long <- consumers_long  %>%
  left_join(advisories_long, by = c("updated_lake_name" = "lake", 
                                    "Age_Category" = "Age", 
                                    "Observed_Gender" = "Gender",
                                    "Catches_Info" = "join_fish_names"
                                    )) %>%
   rename(county = county.x)%>%
   select(-county.y)
  
##Fill in statewide advisories for lakes/fish where there are no lake specific consumption data
# Perform the left join only on the rows that meet the condition
joined_data <- consumers_long %>%
  filter(daily_intake > 0 & is.na(column)) %>%
  left_join(statewide_adv, by = c("Age_Category" = "Age", 
                                  "Observed_Gender" = "Gender",
                                  "Catches_Info" = "join_fish_names"))%>%
  select(-lake)
  
# Keep the rows that do not meet the condition as they are
non_joined_data <- consumers_long %>%
  filter(!(daily_intake > 0 & is.na(column)))
  
# Combine the two data frames back together
consumers_long <- bind_rows(joined_data, non_joined_data) 

consumers_long <- consumers_long %>% 
  mutate(column = coalesce(column, statewide_column,),
         threshold_g_day = coalesce(threshold_g_day, statewide_threshold_g_day),
         OEHHA_fish_names = coalesce(OEHHA_fish_names, OEHHA_fish_names.y)
         )%>%
  select(-statewide_column, - statewide_threshold_g_day, -OEHHA_fish_names.x, - OEHHA_fish_names.y)%>%
   group_by(Catches_Info, rowID) %>%
  mutate(avg_threshold = mean(threshold_g_day))%>%
  ungroup() %>%
##Does consumption by each individual from one lake exceed threshold for that specific lake
  mutate(exceed_threshold_indiv_lake = daily_intake_per_lake > threshold_g_day)%>%
##Does total consumption by each individual from all lakes exceed average threshold for all lakes
  mutate(exceed_threshold_avg_lake = daily_intake > avg_threshold)
  
##datacheck 
datacheck <- consumers_long %>% select(rowID, Catches_Info, updated_lake_name, threshold_g_day, avg_threshold)


##During data clean up - check NAs here. Explore why.
##Need to check code to make sure things are filtering & calculating as expected
write.csv(consumers_long, "consumers_long.csv", , row.names = FALSE)

```




##LOOP surveyed lakes consumption 
```{r}

# List of fish species to analyze
fish_species <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "all" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

lakes <- list(
  "all" = unique(consumers_long$updated_lake_name),
  "all_surveyed" = c("Legg lake","Alondra park","Peck Road"),
  "Legg lake" = "Legg lake",
  "Alondra park" = "Alondra park",
  "Peck Road" = "Peck Road"
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
    
  ### Percent of consumers exceeding thresholds by lake
  per_exceed_thresh <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded_lake = any(exceed_threshold_indiv_lake)) %>%
    ungroup() %>%
    filter(!is.na(any_exceeded_lake)) %>%
    summarise(percent_exceed_lake = round((sum(any_exceeded_lake) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())
  
   ### Percent of consumers exceeding thresholds avg threshold
  per_exceed_avg_thresh <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
   summarise(any_exceeded_avg = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(any_exceeded_avg)) %>%
   summarise(percent_exceed_avg = round((sum(any_exceeded_avg) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())
  

  ### All consumers consumption rate
  all_consumption_rate <- consumers_long %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 1),
      max = round(max(total_daily_intake, na.rm = TRUE), 1),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 1),
      median = round(median(total_daily_intake, na.rm = TRUE), 1)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)
  summary_table <- left_join(summary_table, per_exceed_avg_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
all_lakes_summary_table <- bind_rows(summary_tables)

# Write to CSV
write.csv(all_lakes_summary_table, "consumption_summary.csv", row.names = FALSE)



```

##LOOP LA county lakes consumption 
```{r}

LA_county_consumers <- consumers_long %>%
  filter(county == "Los Angeles")

# List of fish species to analyze
fish_species <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "all" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)
##CHECK to ensure lake list is up to date before final analysis
lakes <- list(
  "all LA county" = unique(LA_county_consumers$updated_lake_name),
  "all_surveyed" = c("Legg lake","Alondra park","Peck Road"),
  "Legg lake" = "Legg lake",
  "Alondra park" = "Alondra park",
  "Peck Road" = "Peck Road",
  "El Dorado Park Lake" = "El Dorado Park Lake",
  "MacArthur Park" = "MacArthur Park",
  "Pyramid lake"  = "Pyramid lake"  ,
  "Downey Wilderness Park Lake" = "Downey Wilderness Park Lake" ,
  "Belvedere Park"  ="Belvedere Park"  ,
  "Puddingstone reservoir" ="Puddingstone reservoir" ,
  "Kenneth Hahn/Gwen Moore Lake" ="Kenneth Hahn/Gwen Moore Lake" ,
  "Cerritos Park Lake / Don Knabe" ="Cerritos Park Lake / Don Knabe",
  "Santa Fe Dam lake" ="Santa Fe Dam lake" ,
  "Lincoln Park Lake" ="Lincoln Park Lake",
  "Castaic Lake" ="Castaic Lake" ,
  "Crystal Lake"="Crystal Lake"
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
    

  ### Percent of consumers exceeding threshold
  per_exceed_thresh <- LA_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(any_exceeded)) %>%
    summarise(percent_exceed = round((sum(any_exceeded) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())
  
  

  ### All consumers consumption rate
  all_consumption_rate <- LA_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 1),
      max = round(max(total_daily_intake, na.rm = TRUE), 1),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 1),
      median = round(median(total_daily_intake, na.rm = TRUE), 1)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
LA_county_summary_table <- bind_rows(summary_tables)

# Write to CSV
write.csv(LA_county_summary_table, "consumption_LA_county_summary.csv", row.names = FALSE)



```
##LOOP Orange county lakes consumption 
```{r}

Orange_county_consumers <- consumers_long %>%
  filter(county == "Orange")

# List of fish species to analyze
fish_species <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "all" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

##CHECK to ensure lake list is up to date before final analysis
lakes <- list(
  "all Orange county" = unique(Orange_county_consumers$updated_lake_name),
  "Carbon Canyon Regional Park" ="Carbon Canyon Regional Park",
  "Tri-City Regional Park" = "Tri-City Regional Park",
   "Laguna Niguel Lake" =  "Laguna Niguel Lake" ,
  "Irvine Lake" ="Irvine Lake" 
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
    

  ### Percent of consumers exceeding threshold
  per_exceed_thresh <- Orange_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(any_exceeded)) %>%
    summarise(percent_exceed = round((sum(any_exceeded) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### All consumers consumption rate
  all_consumption_rate <- Orange_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 1),
      max = round(max(total_daily_intake, na.rm = TRUE), 1),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 1),
      median = round(median(total_daily_intake, na.rm = TRUE), 1)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
Orange_county_summary_table <- bind_rows(summary_tables)

# Write to CSV
write.csv(Orange_county_summary_table, "consumption_Orange_county_summary.csv", row.names = FALSE)



```
##LOOP Riverside county lakes consumption 
```{r}

Riverside_county_consumers <- consumers_long %>%
  filter(county == "Riverside")

# List of fish species to analyze
fish_species <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "all" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

##CHECK to ensure lake list is up to date before final analysis
lakes <- list(
  "all Riverside county" = unique(Riverside_county_consumers$updated_lake_name),
  "Lake Skinner"="Lake Skinner",
  "Lake Perris" ="Lake Perris" 
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
    

  ### Percent of consumers exceeding threshold
  per_exceed_thresh <- Riverside_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(any_exceeded)) %>%
    summarise(percent_exceed = round((sum(any_exceeded) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### All consumers consumption rate
  all_consumption_rate <- Riverside_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 1),
      max = round(max(total_daily_intake, na.rm = TRUE), 1),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 1),
      median = round(median(total_daily_intake, na.rm = TRUE), 1)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
Riverside_county_summary_table <- bind_rows(summary_tables)

##Remove NAs (comment out to include NAs)
Riverside_county_summary_table <- Riverside_county_summary_table %>%
  filter(complete.cases(percent_exceed))

# Write to CSV
write.csv(Riverside_county_summary_table, "consumption_Riverside_county_summary.csv", row.names = FALSE)

```

##LOOP San Bernardino county lakes consumption 
```{r}

San_Bernardino_county_consumers <- consumers_long %>%
  filter(county == "San Bernardino")

# List of fish species to analyze
fish_species <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "all" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)

##CHECK to ensure lake list is up to date before final analysis
lakes <- list(
  "all San_Bernardino county" = unique(San_Bernardino_county_consumers$updated_lake_name),
  "Lake Gregory Regional Park"="Lake Gregory Regional Park",
  "Big Bear lake"="Big Bear lake",
  "Prado Dam" ="Prado Dam" 
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
  
    

  ### Percent of consumers exceeding threshold
  per_exceed_thresh <- San_Bernardino_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(any_exceeded = any(exceed_threshold_avg_lake)) %>%
    ungroup() %>%
    filter(!is.na(any_exceeded)) %>%
    summarise(percent_exceed = round((sum(any_exceeded) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  ### All consumers consumption rate
  all_consumption_rate <- San_Bernardino_county_consumers %>%
    group_by(rowID) %>%
    filter(daily_intake > 0) %>%
    filter(Catches_Info %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 1),
      max = round(max(total_daily_intake, na.rm = TRUE), 1),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 1),
      median = round(median(total_daily_intake, na.rm = TRUE), 1)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
San_Bernardino_county_summary_table <- bind_rows(summary_tables)

##Remove NAs (comment out to include NAs)
San_Bernardino_county_summary_table <- San_Bernardino_county_summary_table %>%
  filter(complete.cases(percent_exceed))

# Write to CSV
write.csv(San_Bernardino_county_summary_table, "consumption_San_Bernardino_county_summary.csv", row.names = FALSE)

```
##Can insert additional LOOPS for Ventura & santa barbara counties if desired

##Calculate consumption rate (household members)
```{r}
##Subset to only household consumers (<4 weeks)
##CHECK that each row = only one person
##CHECK that amount eaten and times eaten columns can be converted to Numeric

household_consumers <- fisherdb %>% filter(
                  `Amount_eaten_(Person_1)` >0  & `Times_eaten_last_4_weeks__(Person_1)`>0|
                  `Amount_eaten_(Person_2)` >0  & `Times_eaten_last_4_weeks__(Person_2)`>0|
                  `Amount_eaten_(Person_3)` >0  & `Times_eaten_last_4_weeks__(Person_3)`>0|
                  `Amount_eaten_(Person_4)` >0  & `Times_eaten_last_4_weeks__(Person_4)`>0
)

household_consumers_long <- household_consumers %>%
  mutate(fisherID = 1:nrow(.)) %>%
  select(-(`Previously_interviewed?`:`Caught_other,_cooking_method`))%>% 
  select(-(`Data_entry_by:_(initials)`:`Fish_consumer_(any_LA_lake)`))%>%
  pivot_longer(
    cols = starts_with("Relation_to_fisher"),
    names_to = "household_member",
    values_to = "Relation_to_fisher"
  )%>%
  mutate(Relation_to_fisher=(as.factor(Relation_to_fisher))) %>%
  filter(Relation_to_fisher != "NA" & Relation_to_fisher != "Na")%>%
  mutate(household_member = gsub("^Relation_to_fisher_","",household_member)) %>%
  mutate(household_member = gsub("^\\(|\\)$", "", household_member))%>%
  ##Associate correct data with each record
  ###Calculate daily intake
  mutate(daily_intake = case_when(
    household_member == "Person_1" ~ `Times_eaten_last_4_weeks__(Person_1)` *     `Amount_eaten_(Person_1)`,
     household_member == "Person_2" ~ `Times_eaten_last_4_weeks__(Person_2)` * `Amount_eaten_(Person_2)`,
     household_member == "Person_3" ~ `Times_eaten_last_4_weeks__(Person_3)` * `Amount_eaten_(Person_3)`,
     household_member == "Person_4" ~ `Times_eaten_last_4_weeks__(Person_4)` * `Amount_eaten_(Person_4)`,
    .default = NA
  )) %>%
mutate(daily_intake = (daily_intake * 227)/28) %>%
  ###Associate Age
mutate(hh_age = case_when(
    household_member == "Person_1" ~ `Age_(Person_1)`,
    household_member == "Person_2" ~ `Age_(Person_2)`,
    household_member == "Person_3" ~ `Age_(Person_3)`,
    household_member == "Person_4" ~ `Age_(Person_4)`,
  ))%>%
  ###Associate gender
mutate(hh_gender = case_when(
    household_member == "Person_1" ~ `Gender_(Person_1)`,
    household_member == "Person_2" ~ `Gender_(Person_2)`,
    household_member == "Person_3" ~ `Gender_(Person_3)`,
    household_member == "Person_4" ~ `Gender_(Person_4)`,
  )) %>%
  ###Associate species consumed
mutate(hh_species_consumed = case_when(
    household_member == "Person_1" ~ `Species_consumed_(Person_1)`,
    household_member == "Person_2" ~ `Species_consumed_(Person_2)`,
    household_member == "Person_3" ~ `Species_consumed_(Person_3)`,
    household_member == "Person_4" ~ `Species_consumed_(Person_4)`,
  )) %>%
  ###Associate parts_eaten
mutate(hh_parts_eaten = case_when(
    household_member == "Person_1" ~ `Parts_eaten_(Person_1)`,
    household_member == "Person_2" ~ `Parts_eaten_(Person_2)`,
    household_member == "Person_3" ~ `Parts_eaten_(Person_3)`,
    household_member == "Person_4" ~ `Parts_eaten_(Person_4)`,
  )) %>%
  ###Associate cooking_details
mutate(hh_cooking_details = case_when(
    household_member == "Person_1" ~ `Cooking_details_(Person_1)`,
    household_member == "Person_2" ~ `Cooking_details_(Person_2)`,
    household_member == "Person_3" ~ `Cooking_details_(Person_3)`,
    household_member == "Person_4" ~ `Cooking_details_(Person_4)`,
  ))%>%
  ###Remove extra rows
select(-(`Age_(Person_1)`:`Cooking_details_(Person_4)`)) %>%
  ##Separate hh_species_consumed into separate columns
separate(hh_species_consumed, into = c("hh_species1", "hh_species2", "hh_species3", "hh_species4"), sep = ",")


##Convert to long format by species for each household consumer
hh_consumers_species_long <- household_consumers_long %>%
  mutate(hh_consumerID = 1:nrow(.)) %>%
  pivot_longer(
    cols = starts_with("hh_species"),
    names_to = "delete",
    values_to = "hh_species_consumed"
  )%>%
  filter(complete.cases(hh_species_consumed))%>%
  mutate(hh_species_consumed = trimws(hh_species_consumed))%>%
###CHECK that all unique names are being captured
  mutate (hh_species_consumed = case_when(
    hh_species_consumed == "Rainbow Trout" ~ "Rainbow trout",
    hh_species_consumed == "Rainbow trout" ~ "Rainbow trout",
    hh_species_consumed == "Trout" ~ "Rainbow trout",
    hh_species_consumed == "Catfish" ~ "Catfish",
    hh_species_consumed == "Bluegill" ~ "Sunfish species",
    hh_species_consumed == "bluegill" ~ "Sunfish species",
    hh_species_consumed == "Common Carp" ~ "Common carp",
    hh_species_consumed == "Carp" ~ "Common carp",
    hh_species_consumed == "Bass" ~ "Black bass species",
    hh_species_consumed == "Crappie" ~ "Crappie",
    hh_species_consumed == "Tilapia"   ~ "Tilapia"  ,
    hh_species_consumed == "Other" ~ "Other",
    TRUE ~ hh_species_consumed #For species not listed above
  ))%>%
  group_by(hh_consumerID) %>%
  mutate(number_fish_sp = n()) %>%
  ungroup()%>%
  mutate(hh_total_daily_intake = daily_intake)%>%
  select(-c(delete , daily_intake))%>%
  ###Making the assumption that daily intake is divided evenly between the fish described. We may be    able to make this calculation more specific
  mutate(hh_daily_intake_per_fish = hh_total_daily_intake/number_fish_sp)%>%
###Next steps associate lakes + fish from person interviewed with household members...
  mutate (hh_lake = case_when(
    hh_species_consumed == "Rainbow trout"  ~ `Past_catches:_Rainbow_Trout,_times_eaten,_where`,
    hh_species_consumed == "Sunfish species" ~ `Past_catches:_Bluegill,_times_eaten,_where`,
    hh_species_consumed == "Catfish"   ~ `Past_catches:_Catfish,_times_eaten,_where`,
    hh_species_consumed == "Common carp"   ~ `Past_catches:_Common_Carp,_times_eaten,_where`,
    hh_species_consumed == "Crappie"  ~ `Past_catches:_Crappie,_times_eaten,_where` ,
    hh_species_consumed == "Black bass species" ~ `Past_catches:_Bass,_times_eaten,_where`,
  ))%>%
   ##Separate lake data into separate columns
separate(hh_lake, into = c("hh_lake1", "hh_lake2", "hh_lake3", "hh_lake4"), sep = ",")%>%
###pivot long by lake and divide consumption by lake
  pivot_longer(
    cols = starts_with("hh_lake"),
    names_to = "delete",
    values_to = "hh_lakes"
  )%>%
  filter(complete.cases(hh_lakes))%>%
  mutate(hh_lakes= trimws(hh_lakes))%>%
  group_by(hh_consumerID, hh_species_consumed) %>%
  mutate(number_lakes = n()) %>%
  ungroup() %>%
  mutate(hh_daily_intake_per_fish_per_lake = hh_daily_intake_per_fish/number_lakes)%>%
  select(-delete) %>%
  ###move this code earlier so that number of lakes is replaced with times from lake if there is a value
  separate(hh_lakes, into = c("hh_lakes", "times_from_lake"), sep = "\\(", fill = "right") %>%
  mutate(hh_lakes = trimws(hh_lakes))

 
```
##Household consumption x OEHHA thresholds

```{r}

###extract lake names to update key
hh_lake_names <- hh_consumers_species_long$hh_lakes
hh_lake_names <-trimws(hh_lake_names)
hh_lake_names <- unique(hh_lake_names)

#write.csv(hh_lake_names,"hh_lake_names.csv", row.names = FALSE)

##Names and counties were added to "unique_lake_names.csv" -- now import this dataset

unique_lake_names_key <- read.csv("unique_lake_names_key.csv")

##Join lakes & key to identify if any missed

df_hh_lake_names <- as.data.frame(hh_lake_names)
anti_join_lakes <- anti_join(df_hh_lake_names, unique_lake_names_key, by=c("hh_lake_names" = "original_name"))


##Update lake names with join
hh_consumers_species_long <- hh_consumers_species_long %>%
  left_join(unique_lake_names_key %>%
              select(original_name, lake , county), by = c("hh_lakes" = "original_name")) %>%
  rename(updated_lake_name = lake) %>%
  mutate(Age_Category =  case_when(
    hh_age < 18 ~ "< 18",
    hh_age >= 18 & hh_gender == "Male" ~ ">= 18",
    hh_age >= 18 & hh_age < 50 & hh_gender == "Female" ~ "18 - 49",
    hh_age > 50 & hh_gender == "Female" ~ ">= 50",
    .default = NA
  ))%>%
  mutate(hh_gender_original = case_when(
    hh_gender =="Female" ~"Female",
    hh_gender == "Male"~"Male"
  ))%>%
  mutate(hh_gender = case_when(
    hh_age <18 ~ "Child",
    hh_gender =="Female" ~"Female",
    hh_gender == "Male"~"Male"
  ))

##Join consumers with advisories
  hh_consumers_species_long <- hh_consumers_species_long   %>%
  left_join(advisories_long, by = c("updated_lake_name" = "lake", 
                                    "Age_Category" = "Age", 
                                    "hh_gender" = "Gender",
                                    "hh_species_consumed" = "join_fish_names"
                                    )) %>%
   rename(county = county.x)%>%
   select(-county.y)
  
##Fill in statewide advisories for lakes/fish where there are no lake specific consumption data
# Perform the left join only on the rows that meet the condition
hh_joined_data <- hh_consumers_species_long %>%
  filter(hh_daily_intake_per_fish_per_lake > 0 & is.na(column)) %>%
  left_join(statewide_adv, by = c("Age_Category" = "Age", 
                                  "hh_gender" = "Gender",
                                  "hh_species_consumed" = "join_fish_names"))%>%
  select(-lake)
  
# Keep the rows that do not meet the condition as they are
hh_non_joined_data <- hh_consumers_species_long %>%
  filter(!(hh_daily_intake_per_fish_per_lake > 0 & is.na(column)))
  
# Combine the two data frames back together
hh_consumers_species_long <- bind_rows(hh_joined_data, hh_non_joined_data) 

hh_consumers_species_long <-hh_consumers_species_long %>% 
  mutate(column = coalesce(column, statewide_column,),
         threshold_g_day = coalesce(threshold_g_day, statewide_threshold_g_day),
         OEHHA_fish_names = coalesce(OEHHA_fish_names, OEHHA_fish_names.y)
         )%>%
  select(-statewide_column, - statewide_threshold_g_day, -OEHHA_fish_names.x, - OEHHA_fish_names.y)%>%
  mutate(exceed_threshold = hh_daily_intake_per_fish_per_lake > threshold_g_day)

##During data clean up - check NAs here. Explore why.
##Need to check code to make sure things are filtering & calculating as expected
write.csv(hh_consumers_species_long, "hh_consumers_long.csv", , row.names = FALSE)

```

##hh LOOP
```{r}

# List of fish species to analyze
fish_species <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

age <- list(
  "all" = c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50"),
  "<18" = "threshold_g_day_child",
  "F18_49" = "threshold_g_day_women18_49",
  "M18_F50"= c("threshold_g_day_men18","threshold_g_day_women50")
)
##CHECK list of lakes is updated
lakes <- list(
  "all" = unique(hh_consumers_species_long$updated_lake_name),
  "all_surveyed" = c("Legg lake","Alondra park","Peck Road"),
  "Legg lake" = "Legg lake",
  "Alondra park" = "Alondra park",
  "Peck Road" = "Peck Road",
  "Pyramid lake" ="Pyramid lake",
  "Puddingstone reservoir" ="Puddingstone reservoir",
  "Santa Fe Dam lake"  = "Santa Fe Dam lake"  ,
  "Lake Perris" ="Lake Perris" 
)

# Initialize an empty list to store summary tables
summary_tables <- list()

for (lake_name in names(lakes)) {
  selected_lake <- lakes[[lake_name]]
  
  for (age_group in names(age)) {
     selected_age <- age[[age_group]]

  for (fish_name in names(fish_species)) {

    # Select the appropriate species or all species
    selected_fish <- fish_species[[fish_name]]
    
    ##For testing
  # selected_fish<- c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species")
  # 
  #  selected_age <- c("threshold_g_day_men18","threshold_g_day_child","threshold_g_day_women18_49","threshold_g_day_women50")
  #  
  #  selected_lake <-unique(hh_consumers_species_long$updated_lake_name)
  
    
    ### Percent of consumers exceeding thresholds by lake
  per_exceed_thresh <- hh_consumers_species_long%>%
    group_by(hh_consumerID) %>%
    filter(hh_total_daily_intake > 0) %>%
    filter(hh_species_consumed %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(exceed_threshold = any(exceed_threshold)) %>%
    ungroup() %>%
    filter(!is.na(exceed_threshold)) %>%
    summarise(percent_exceed_lake = round((sum(exceed_threshold) / n()) * 100, 1)) %>%
    mutate(lakes = lake_name) %>%  # Add a column for the label
    mutate(fish =fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  

  ### All consumers consumption rate
  all_consumption_rate <- hh_consumers_species_long%>%
    group_by(hh_consumerID) %>%
    filter(hh_total_daily_intake > 0) %>%
    filter(hh_species_consumed %in% selected_fish) %>%
    filter(column %in% selected_age)%>%
    filter(updated_lake_name %in% selected_lake) %>%
    summarise(total_daily_intake = sum(hh_total_daily_intake, na.rm = TRUE)) %>%
    ungroup()

  ### Create summary table
  summary_table <- all_consumption_rate %>%
    summarise(
      n = n(),
      min = round(min(total_daily_intake, na.rm = TRUE), 1),
      max = round(max(total_daily_intake, na.rm = TRUE), 1),
      mean = round(mean(total_daily_intake, na.rm = TRUE), 1),
      median = round(median(total_daily_intake, na.rm = TRUE), 1)
    ) %>%
    mutate(lakes = lake_name) %>%
    mutate(fish = fish_name) %>%
    mutate(age = age_group) %>%
    select(lakes, age, fish, everything())

  summary_table <- left_join(summary_table, per_exceed_thresh)

  # Store the summary table in the list
   summary_tables[[paste(fish_name, age_group, lake_name, sep = "_")]] <- summary_table
    }
  }
}
# Combine all summary tables into a single data frame
hh_all_lakes_summary_table <- bind_rows(summary_tables)
hh_all_lakes_summary_table <- hh_all_lakes_summary_table %>%
  filter(complete.cases(median))

# Write to CSV
write.csv(hh_all_lakes_summary_table, "hh_consumption_summary.csv", row.names = FALSE)



```

##Age histogram

```{r }
fisherdb <- fisherdb %>%
  mutate(Age= as.numeric(Age))
summary(fisherdb$Age)

fisherdb <- fisherdb %>%
  mutate(`Observed_Gender` = case_when(
   # `Observed_Gender` %in% c("unknown") ~ "Male",
    TRUE ~ `Observed_Gender`
  ))

fisher_hist <-ggplot(fisherdb, aes(x = Age, fill = Observed_Gender)) +
  geom_histogram(binwidth = 10, color = "#000000") +
  labs(
    title = "",
    x = "Age",
    y = "Frequency",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#ff8900","#15607a","gray"))+
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "top",)

fisher_hist

##histogram of age/gendre of fishers who consume fish
fish_consumers <- consumers_long %>%
  group_by(rowID) %>%
  summarise(Age = first(Age), Observed_Gender = first(Observed_Gender)) %>%
  ungroup()

fisher_consumer_hist <- ggplot(fish_consumers, aes(x = Age, fill = Observed_Gender)) +
  geom_histogram(binwidth = 10, color = "black") +
  labs(
    title = "",
    x = "Age",
    y = "Frequency",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("gray","#ff8900","#15607a"))+
  scale_y_continuous(limits=c(0,20))+
  scale_x_continuous(limits=c(0,190))
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "top",)

fisher_consumer_hist

##histogram age/gender household (hh) members

hh_age <- hh_consumers_species_long %>%
  mutate(across(c(hh_gender_original),as.factor))%>%
  filter(hh_daily_intake_per_fish>0)%>%
  select(c(hh_age,hh_gender_original))

hh_hist <-ggplot(hh_age, aes(x = hh_age, fill = hh_gender_original)) +
  geom_histogram(binwidth = 10, color = "black") +
  labs(
    title = "",
    x = "Age",
    y = "Frequency",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#ff8900","#15607a","gray"))+
  scale_y_continuous(limits=c(0,20))+
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "top",)

hh_hist


```


#EXTRA CODE
$$ ##remove dollar signs to open up code
```{r}
##Check if any of this is still necessary

summarize_fish_names <- consumers_long %>%
  group_by(Catches_Info)%>%
  summarize(min(threshold_g_day, na.rm = TRUE))%>%
  ungroup()

#example percent of people at each park exceeding 300 grams per day for any fish
percent_people <- consumers_long %>%
  mutate(threshold = 300) %>%
  mutate(exceeded = daily_intake > threshold) %>%
  group_by(rowID, updated_name) %>%
  summarise(any_exceeded = any(exceeded)) %>% #Get a list of which people exceeded a threshold at least once. 
  ungroup() %>%
  filter(!is.na(any_exceeded)) %>%
  group_by(updated_name) %>%
  summarise(percent_people_exceeding = sum(any_exceeded)/n()) #Count the total number of people and excedences to summarise the final result. 


##Take2
consumers_long <- consumers %>%
  mutate(rowID = 1:nrow(.))%>%
  mutate(across(matches("Past_catches:.*times_eaten$"),as.character))%>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = matches("Past_catches:.*times_eaten,_where|Past_catches:.*times_eaten$"),
    names_to = "Catches_Info",
    values_to = "Values"
  ) %>%
  # Step 2: Separate the lake names into individual rows and handle Time Eaten
 # mutate(Catches_Info = gsub("(Past_catches:_)|(,.*)", "", Catches_Info)) %>%
 # mutate(Catches_Info = gsub("_", " ", Catches_Info)) %>%
  
 separate(Catches_Info, into = c("Catches_Info", "Suffix"), sep = "(_where|_eaten)$", remove = FALSE) %>%
  mutate(
    Time_Eaten = if_else(Suffix == "_eaten", Values, NA_character_),
    Lakes = if_else(Suffix == "_where", Values, NA_character_)
  ) %>%
  # Step 3: Remove unnecessary columns and rows with NA
  select(rowID, Age, Observed_Gender, Catches_Info, Lakes, Time_Eaten) 
#%>%  filter(!is.na(Lakes)) 
  #%>% separate_rows(Lakes, sep = ",")


###

consumers <- consumers %>%
  separate (`Past_catches:_Rainbow_Trout,_times_eaten,_where`,
            into = c("RT_lake1", "RT_lake2", "RT_lake3", "RT_lake4"),
            sep = ",",
            remove = FALSE)


datacheck <- consumers %>% select(c(`Past_catches:_Rainbow_Trout,_times_eaten,_where`, RT_lake1, RT_lake2, RT_lake3, RT_lake4))


consumers <- consumers %>% 
  

###






rt_adv <- statewide_adv %>% filter(
  Fish=="Rainbow trout")
crappie_adv <- statewide_adv %>% filter(
  Fish=="Crappie species")4
sunfish_adv <- statewide_adv %>% filter(
  Fish=="Sunfish species")
blackbass_adv <- statewide_adv %>% filter(
  Fish=="Black bass species")
catfish_adv <- statewide_adv %>% filter(
  Fish=="Catfish species")
carp_adv <- statewide_adv %>% filter(
  Fish=="Common carp")

##Calculate threshold exceedance
#rainbow trout 
consumers <- consumers %>%
  mutate(
    rainbow_trout_threshold = case_when(
      Age < 18 ~ rt_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ rt_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ rt_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ rt_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    rt_exceed_thresh = rainbow_trout_threshold < rainbow_trout_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Rainbow_Trout,_times_eaten,_where`, y=rainbow_trout_g_day))+
  geom_point(aes(color = rt_exceed_thresh))+
  coord_flip()
datacheck <- consumers %>%
  select( c(Age,Observed_Gender,rainbow_trout_threshold, rainbow_trout_g_day ,rt_exceed_thresh))

#catfish 
consumers <- consumers %>%
  mutate(
    catfish_threshold = case_when(
      Age < 18 ~ catfish_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ catfish_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ catfish_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ catfish_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    catfish_exceed_thresh = catfish_threshold < catfish_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Catfish,_times_eaten,_where`, y=catfish_g_day))+
  geom_point(aes(color = catfish_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,catfish_threshold, catfish_g_day ,catfish_exceed_thresh))

#bluegill
consumers <- consumers %>%
  mutate(
    bluegill_threshold = case_when(
      Age < 18 ~ sunfish_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ sunfish_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ sunfish_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ sunfish_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    bluegill_exceed_thresh = bluegill_threshold < bluegill_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Bluegill,_times_eaten,_where`, y=bluegill_g_day))+
  geom_point(aes(color = bluegill_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,bluegill_threshold, bluegill_g_day ,bluegill_exceed_thresh))

#Black bass
consumers <- consumers %>%
  mutate(
    blackbass_threshold = case_when(
      Age < 18 ~ blackbass_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ blackbass_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ blackbass_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ blackbass_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    blackbass_exceed_thresh = blackbass_threshold < bass_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Bass,_times_eaten,_where`, y=bass_g_day))+
  geom_point(aes(color = blackbass_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,blackbass_threshold, bass_g_day ,blackbass_exceed_thresh))

#Carp
consumers <- consumers %>%
  mutate(
    carp_threshold = case_when(
      Age < 18 ~ carp_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~  carp_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~  carp_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~  carp_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    carp_exceed_thresh = carp_threshold < carp_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Common_Carp,_times_eaten,_where`, y=carp_g_day))+
  geom_point(aes(color = carp_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,carp_threshold, carp_g_day ,carp_exceed_thresh))
```
####Data summaries
#####All lakes
######all species

```{r}
#Summarize consumers at all lakes
##All species
###Percent of consumers exceeding threshold
per_all_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "all") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
all_summary_table <- all_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "all") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
all_summary_table <- left_join(all_summary_table, per_all_exceed_thresh)

```

######rainbow trout
```{r}
##all lakes rainbow trout

###Percent of consumers exceeding threshold
per_rt_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Rainbow trout")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "rainbow trout") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_rt_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Rainbow trout")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
rt_summary_table <- all_rt_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "rainbow trout") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
rt_summary_table <- left_join(rt_summary_table, per_rt_exceed_thresh)
```

######catfish
```{r}
##all lakes catfish

###Percent of consumers exceeding threshold
per_cat_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names %in% c("Catfish species", "Channel catfish")) %>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Catfish species") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_cat_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names %in% c("Catfish species", "Channel catfish")) %>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
cat_summary_table <- all_cat_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Catfish species") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
cat_summary_table <- left_join(cat_summary_table, per_cat_exceed_thresh)
```
######sunfish
```{r}
##all lakes sunfish

###Percent of consumers exceeding threshold
per_sunfish_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Sunfish species")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Sunfish species") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_sunfish_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Sunfish species")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
sunfish_summary_table <- all_sunfish_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Sunfish species") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
sunfish_summary_table <- left_join(sunfish_summary_table, per_sunfish_exceed_thresh)
```
######carp
```{r}
##All lakes Carp

###Percent of consumers exceeding threshold
per_carp_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Common carp")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Common carp") %>%
  select(lakes, fish, everything()) 
##All consumers consumption rate

all_carp_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Common carp")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
carp_summary_table <- all_carp_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Common carp") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
carp_summary_table <- left_join(carp_summary_table, per_carp_exceed_thresh)
```
######bass
```{r}
##All lakes Bass

###Percent of consumers exceeding threshold
per_bass_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Black bass species")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Black bass species") %>%
  select(lakes, fish, everything())

##All consumers consumption rate

all_bass_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Black bass species")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
bass_summary_table <- all_bass_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Black bass species") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
bass_summary_table <- left_join(bass_summary_table, per_bass_exceed_thresh) %>%
  select(lakes, fish, everything()) 

bass_summary_table <- left_join(bass_summary_table, per_bass_exceed_thresh)
```
######crappie
```{r}
##All lakes Crappie

###Percent of consumers exceeding threshold
per_crappie_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Crappie species")%>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Crappie species") %>%
  select(lakes, fish, everything())

##All consumers consumption rate

all_crappie_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(OEHHA_fish_names == "Crappie species")%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
crappie_summary_table <- all_crappie_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes = "all") %>%  # Add a column for the label
  mutate(fish = "Crappie species") %>%
  select(lakes, fish, everything())  # Move the label column to the front
  
crappie_summary_table <- left_join(crappie_summary_table, per_crappie_exceed_thresh) %>%
  select(lakes, fish, everything()) 

crappie_summary_table <- left_join(crappie_summary_table, per_crappie_exceed_thresh)

```



####Combine summary tables

```{r}
all_lakes_summary_table <- bind_rows(all_summary_table, rt_summary_table, cat_summary_table, sunfish_summary_table, carp_summary_table, bass_summary_table, crappie_summary_table)

write.csv(all_lakes_summary_table,"consumption_summary.csv", row.names = FALSE)
```

####Test data summaries
######rainbow trout
```{r}

# List of fish species to analyze
fish <- list(
  "all" = c("Rainbow trout", "Catfish", "Sunfish species", "Common carp", "Black bass species", "Crappie species"),
  "Rainbow trout" = "Rainbow trout",
  "Catfish" = "Catfish",
  "Sunfish species" = "Sunfish species",
  "Common carp" = "Common carp",
  "Black bass species" = "Black bass species",
  "Crappie species" = "Crappie"
)

# Initialize an empty list to store summary tables
summary_tables <- list()

lakes = "all"
age = "all"

for (fish in names(fish)) {

###Percent of consumers exceeding threshold
per_exceed_thresh <- consumers_long %>%
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(Catches_Info == fish) %>%
  summarise(any_exceeded=any(exceed_threshold))%>%#Get a list of which people exceeded a threshold at least once. 
  ungroup()%>%
  filter(!is.na(any_exceeded))%>%
  summarise(percent_exceed = round((sum(any_exceeded)/n())*100,1)) %>% #Count the total number of people and excedences to summarise the final result. 
  mutate(lakes = lakes) %>%  # Add a column for the label
  mutate(fish = fish) %>%
  mutate(age = age) %>%
  select(lakes, age,  fish, everything()) 
##All consumers consumption rate

all_consumption_rate <- consumers_long %>% 
  group_by(rowID)%>%
  filter(daily_intake>0)%>%
  filter(Catches_Info == fish)%>%
  summarise(total_daily_intake = sum(daily_intake, na.rm = TRUE))%>%
  ungroup()

##create summary table
summary_table <- all_consumption_rate %>%
  summarise(
    n=n(),
    min = round(min(total_daily_intake, na.rm = TRUE),1),
    max = round(max(total_daily_intake, na.rm = TRUE),1),
    mean = round(mean(total_daily_intake, na.rm = TRUE),1),
    median = round(median(total_daily_intake, na.rm = TRUE),1)
  ) %>%
  mutate(lakes) %>%  # Add a column for the label
  mutate(fish) %>%
  mutate (age)%>%
  select(lakes, age, fish,everything())  # Move the label column to the front
  
summary_table <- left_join(summary_table, per_exceed_thresh)


  # Store the summary table in the list
  summary_tables[[fish]] <- summary_table
  
  }

# Combine all summary tables into a single data frame
all_lakes_summary_table <- bind_rows(summary_tables)
```
######Age histogram

```{r }
fisherdb <- fisherdb %>%
  mutate(Age= as.numeric(Age))
summary(fisherdb$Age >100)

fisherdb <- fisherdb %>%
  mutate(`Observed_Gender` = case_when(
    `Observed_Gender` %in% c("unknown") ~ "Male",
    TRUE ~ `Observed_Gender`
  ))

ggplot(fisherdb, aes(x = Age, fill = Observed_Gender)) +
  geom_histogram(binwidth = 10, color = "black") +
  labs(
    title = "",
    x = "Age",
    y = "Frequency",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#D47E6A","#248B87","gray"))+
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "top",)

```

