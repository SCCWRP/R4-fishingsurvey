---
title: "R4 Fish Consumption Calculations"
author: "Tori McGruer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## Install libraries
```{r message=TRUE}
library(tidyverse)
library(readxl)
library(ggplot2)
```
## Import data
```{r ,include=FALSE}

path <- c("//pacific/Toxicology/tox/Risk Assessment/Region4_Urban lakes fishers survey/Survey data/Data entry/Working_FisherSurveryDatabase.xlsm")

excel_sheets(path)

fisherdb <-read_excel(path, sheet = "Interviews")

colnames<-colnames(fisherdb)
colnames

#Replace spaces with underscores in column names
names(fisherdb) <- gsub(" ", "_", names(fisherdb))
names(fisherdb)

#Convert to numeric / factor
fisherdb <- fisherdb %>%
  mutate(across(c(`Past_catches:_Rainbow_Trout,_times_eaten`, 
                  `Past_catches:_Catfish,_times_eaten`, 
                  `Past_catches:_Bluegill,_times_eaten`,
                  `Past_catches:_Common_Carp,_times_eaten`,
                  `Past_catches:_Bass,_times_eaten`,
                  `Past_catches:_Crappie,_times_eaten`,
                  `Past_catches:_Tilapia,_times_eaten`,
                  `Past_catches:_other,_times_eaten`,
                  
                  `Past_catches:_Rainbow_Trout,_amount_eaten`,
                  `Past_catches:_Catfish,_amount_eaten`,
                  `Past_catches:_Blue_gill,_amount_eaten`,
                  `Past_catches:_Common_Carp,_amount_eaten`,
                  `Past_catches:_Bass,_amount_eaten`,
                  `Past_catches:_Crappie,_amount_eaten`,
                  `Past_catches:_Tilapia,_amount_eaten`,
                  `Past_catches:_other,_amount_eaten`,
                  
                  `Age_(Person_1)`,
                  `Age_(Person_2)`,
                  `Age_(Person_3)`,
                  `Age_(Person_4)`,
                  Age
                  
                  ), as.numeric)) %>%
  
 mutate(across(c( Observed_Gender
 ),as.factor))


```

#Identify unique lakes
```{r}
#using unlist and strsplit1
lake_names <- unlist(strsplit(c(fisherdb$Likely_Fishing_Location_1, 
                fisherdb$Likely_Fishing_Location_2, 
                fisherdb$Likely_Fishing_Location_3,
                fisherdb$`Past_catches:_Rainbow_Trout,_Where`,
                fisherdb$`Past_catches:_Catfish,_where`,
                fisherdb$`Past_catches:_Bluegill,_where`,
                fisherdb$`Past_catches:_Common_Carp,_where`,
                fisherdb$`Past_catches:__Bass,_where`,
                fisherdb$`Past_catches:_Crappie,_where`,
                fisherdb$`Past_catches:_Tilapia,_where`,
                fisherdb$`Past_catches:_other,_where`),","))

lake_names <-trimws(lake_names)
unique_lake_names <- unique(lake_names)
write.csv(unique_lake_names,"unique_lake_names.csv", row.names = FALSE)

##Names and counties were added to "unique_lake_names.csv" -- now import this dataset

unique_lake_names_key <- read.csv("unique_lake_names_key.csv")

# #update fisherdb lake names using key
# 
# summary(as.factor(fisherdb$`Past_catches:_Bluegill,_times_eaten,_where`))

##Join lakes & key to identify if any missed

df_unique_lake_names <- as.data.frame(unique_lake_names)
anti_join_lakes <- anti_join(df_unique_lake_names, unique_lake_names_key, by=c("unique_lake_names" = "original_name"))

```



#Calculate consumption rate
```{r}
##Subset to only fish consumers (<4 weeks)
consumers <- fisherdb %>% filter(
                  `Past_catches:_Rainbow_Trout,_times_eaten` >0 |
                  `Past_catches:_Catfish,_times_eaten`>0 |
                  `Past_catches:_Bluegill,_times_eaten`>0|
                  `Past_catches:_Common_Carp,_times_eaten`>0 |
                  `Past_catches:_Bass,_times_eaten`>0 |
                  `Past_catches:_Crappie,_times_eaten`>0 |
                  `Past_catches:_Tilapia,_times_eaten`>0|
                  `Past_catches:_other,_times_eaten`>0
)

###Calculate consumption

consumers <- consumers %>%
  mutate(
    rainbow_trout_g_day = na_if(
      ((`Past_catches:_Rainbow_Trout,_times_eaten` * `Past_catches:_Rainbow_Trout,_amount_eaten` * 227) / 28), 0),
    catfish_g_day = na_if(
      ((`Past_catches:_Catfish,_times_eaten` * `Past_catches:_Catfish,_amount_eaten` * 227) / 28), 0),
    bluegill_g_day = na_if(
      ((`Past_catches:_Bluegill,_times_eaten` * `Past_catches:_Blue_gill,_amount_eaten` * 227) / 28), 0),
    carp_g_day = na_if(
      ((`Past_catches:_Common_Carp,_times_eaten` * `Past_catches:_Common_Carp,_amount_eaten` * 227) / 28), 0),
    bass_g_day = na_if(
      ((`Past_catches:_Bass,_times_eaten` * `Past_catches:_Bass,_amount_eaten` * 227) / 28), 0),
    crappie_g_day = na_if(
      ((`Past_catches:_Crappie,_times_eaten` * `Past_catches:_Crappie,_amount_eaten` * 227) / 28), 0),
    tilapia_g_day = na_if(
      ((`Past_catches:_Tilapia,_times_eaten` * `Past_catches:_Tilapia,_amount_eaten` * 227) / 28), 0),
    other_g_day = na_if(
      ((`Past_catches:_other,_times_eaten` * `Past_catches:_other,_amount_eaten` * 227) / 28), 0)
  )

    
ggplot(consumers, aes(x= `Past_catches:_Rainbow_Trout,_times_eaten,_where`, y=rainbow_trout_g_day))+
  geom_point()+  coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Catfish,_times_eaten,_where`, y=catfish_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Bluegill,_times_eaten,_where`, y=bluegill_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Common_Carp,_times_eaten,_where`, y=carp_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Bass,_times_eaten,_where`, y=bass_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Crappie,_times_eaten,_where`, y=crappie_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Tilapia,_times_eaten,_where`, y=tilapia_g_day))+
  geom_point()+coord_flip()
ggplot(consumers, aes(x= `Past_catches:_Other,_times_eaten,_where`, y=other_g_day))+
  geom_point()+coord_flip()



```
###Test- create loop for OEHHA thresholds



#Compare consumption rate to statewide OEHHA thresholds
```{r}
##import thresholds
path <- "//pacific/Toxicology/tox/Risk Assessment/Region4_Urban lakes fishers survey/Resources/OEHHA consumption advisories/OEHHA_consumption_advisories.xlsx"

excel_sheets(path)
advisories <-read_excel(path, sheet = "Lake advisories")
advisories <- advisories %>% mutate(across(
  c(lake, fish, county), as.factor)
)



# 
# ###Convert to triples
# consumers2 <- consumers %>% 
#   mutate(rowID = 1:nrow(.))%>%
#   mutate(across(everything(),as.character))%>%
#   pivot_longer(!rowID,names_to = "column_name", values_to = "values")
# 
# ##Clean lake, fish, gender, age
# consumers4 <- consumers2 %>%
#   mutate(column_name = ifelse(column_name == "Observed_Gender", "Gender", column_name))
# 
# ##Create columns in "consumers" Gender, Age, Lake 1, Fish 1, Lake x, Fish x. 
# 
# 
# ##Create columns in "advisories Gender, Age, Lake, Fish
# 
# ##Convert back to tidy
# consumers3 <- consumers2 %>%
#   pivot_wider(names_from = "column_name", values_from = "values")




###Create new column that counts the number of lakes that each person eats each fish in

# consumers <- consumers %>%
#   mutate(
#     rainbow_trout_where_count = str_count(`Past_catches:_Rainbow_Trout,_times_eaten,_where`, ",") + 1,
#     catfish_where_count = str_count(`Past_catches:_Catfish,_times_eaten,_where`, ",") + 1,
#     bluegill_where_count = str_count(`Past_catches:_Bluegill,_times_eaten,_where`, ",") + 1,
#     common_carp_where_count = str_count(`Past_catches:_Common_Carp,_times_eaten,_where`, ",") + 1,
#     bass_where_count = str_count(`Past_catches:_Bass,_times_eaten,_where`, ",") + 1,
#     crappie_where_count = str_count(`Past_catches:_Crappie,_times_eaten,_where`, ",") + 1,
#     tilapia_where_count = str_count(`Past_catches:_Tilapia,_times_eaten,_where`, ",") + 1,
#     other_fish_where_count = str_count(`Past_catches:_Other,_times_eaten,_where`, ",") + 1
#   )

# ##Check that counts are correctly attributed
# 
# datacheck <- consumers %>% select(
#   (c( `Past_catches:_Rainbow_Trout,_times_eaten,_where`,
#       rainbow_trout_where_count,
#   `Past_catches:_Catfish,_times_eaten,_where`,
#   catfish_where_count,
#   `Past_catches:_Bluegill,_times_eaten,_where`,
#     bluegill_where_count,
#   `Past_catches:_Common_Carp,_times_eaten,_where`,
#    common_carp_where_count,
#   `Past_catches:_Bass,_times_eaten,_where`,
#    bass_where_count,
#   `Past_catches:_Crappie,_times_eaten,_where`,
#      crappie_where_count,
#   `Past_catches:_Tilapia,_times_eaten,_where`,
#     tilapia_where_count,
#   `Past_catches:_Other,_times_eaten,_where`,
#     other_fish_where_count
# )))

##Separate lakes in times_eaten_where into separate columns

advisories_long <- advisories %>%
   #mutate(rowID = 1:nrow(.))%>%
  select(-(srv_per_wk_child:child_serv_g), - Source, - Notes) %>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = threshold_g_day_child:threshold_g_day_men18,
    names_to = "column",
    values_to = "threshold_g_day"
  ) %>%
  mutate(Gender = case_when(
      grepl("child", column) ~ "Child",
      grepl("women", column) ~ "Female",
      grepl("men", column) ~ "Male",
      .default = NA
  )) %>%
  mutate(Age = case_when(
      grepl("_men18", column) ~ ">= 18",
      grepl("18_49", column) ~ "18 - 49",
      grepl("50", column) ~ ">= 50",
      grepl("child", column) ~ "< 18",
      .default = NA
  ))

consumers_long <- consumers %>%
  mutate(rowID = 1:nrow(.))%>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = starts_with("Past_catches:") & ends_with("times_eaten,_where"),
    names_to = "Catches_Info",
    values_to = "Lakes"
  ) %>%
  # Step 2: Separate the lake names into individual rows
  separate_rows(Lakes, sep = ",") %>%
  mutate(Catches_Info = gsub("(Past_catches:_)|(,.*)", "", Catches_Info)) %>%
  mutate(Catches_Info = gsub("_", " ", Catches_Info)) %>%
  mutate(Lakes = trimws(Lakes))%>%
  # Step 3: Select the columns to keep
  select(rowID, Age, Observed_Gender, Catches_Info, Lakes, starts_with("Past_catches:") & ends_with(",_times_eaten"), starts_with("Past_catches:") & ends_with(",_amount_eaten")) %>%
  rename(`Past_catches:_Bluegill,_amount_eaten`= `Past_catches:_Blue_gill,_amount_eaten`) %>% 
  ###Calculate consumption rate of each fish at each lake per person
  mutate(daily_intake = case_when(
    Catches_Info == "Rainbow Trout" ~ `Past_catches:_Rainbow_Trout,_times_eaten` * `Past_catches:_Rainbow_Trout,_amount_eaten`,
    Catches_Info == "Catfish" ~ `Past_catches:_Catfish,_times_eaten` * `Past_catches:_Catfish,_amount_eaten`,
    Catches_Info == "Common Carp" ~ `Past_catches:_Common_Carp,_times_eaten` * `Past_catches:_Common_Carp,_amount_eaten`,
    Catches_Info == "Crappie" ~ `Past_catches:_Crappie,_times_eaten` * `Past_catches:_Crappie,_amount_eaten`,
    Catches_Info == "other" ~ `Past_catches:_other,_times_eaten` * `Past_catches:_other,_amount_eaten`,
    Catches_Info == "Tilapia" ~ `Past_catches:_Tilapia,_times_eaten` * `Past_catches:_Tilapia,_amount_eaten`,
    Catches_Info == "Bluegill" ~ `Past_catches:_Bluegill,_times_eaten` * `Past_catches:_Bluegill,_amount_eaten`,
    Catches_Info == "Bass" ~ `Past_catches:_Bass,_times_eaten` * `Past_catches:_Bass,_amount_eaten`,
    .default = NA
  )) %>%
  mutate(daily_intake = (daily_intake * 227)/28) %>%
  group_by(Catches_Info, rowID) %>%
  mutate(number_lakes = n()) %>%
  ungroup() %>%
  mutate(daily_intake = daily_intake/number_lakes) #%>%
  left_join(lookup_lakes_counties %>%
              select(original_name, updated_name, county), by = c("Lakes" = "original_name")) %>%
  mutate(Observed_Gender = as.character(Observed_Gender)) %>%
  mutate(Observed_Gender = ifelse(Age < 18, "Child", Observed_Gender)) %>%
  mutate(Age_Category =  case_when(
    Age < 18 ~ "< 18",
    Age >= 18 & Observed_Gender == "Male" ~ ">= 18",
    Age >= 18 & Age < 50 & Observed_Gender == "Female" ~ "18 - 49",
    Age > 50 & Observed_Gender == "Female" ~ ">= 50",
    .default = NA
  )) %>%
  left_join(advisories_long, by = c("updated_name" = "Lake", 
                                    "Age_Category" = "Age", 
                                    "Observed_Gender" = "Gender",
                                    "Catches_Info" = "Fish"
                                    ))

#testing matching columns
unique(advisories_long$Fish)[unique(advisories_long$Fish) %in% unique(consumers_long$Catches_Info)]

#example percent of people at each park exceeding 300 grams per day for any fish
percent_people <- consumers_long %>%
  mutate(threshold = 300) %>%
  mutate(exceeded = daily_intake > threshold) %>%
  group_by(rowID, updated_name) %>%
  summarise(any_exceeded = any(exceeded)) %>% #Get a list of which people exceeded a threshold at least once. 
  ungroup() %>%
  filter(!is.na(any_exceeded)) %>%
  group_by(updated_name) %>%
  summarise(percent_people_exceeding = sum(any_exceeded)/n()) #Count the total number of people and excedences to summarise the final result. 


##Take2
consumers_long <- consumers %>%
  mutate(rowID = 1:nrow(.))%>%
  mutate(across(matches("Past_catches:.*times_eaten$"),as.character))%>%
  # Step 1: Gather the relevant columns into long format
  pivot_longer(
    cols = matches("Past_catches:.*times_eaten,_where|Past_catches:.*times_eaten$"),
    names_to = "Catches_Info",
    values_to = "Values"
  ) %>%
  # Step 2: Separate the lake names into individual rows and handle Time Eaten
 # mutate(Catches_Info = gsub("(Past_catches:_)|(,.*)", "", Catches_Info)) %>%
 # mutate(Catches_Info = gsub("_", " ", Catches_Info)) %>%
  
 separate(Catches_Info, into = c("Catches_Info", "Suffix"), sep = "(_where|_eaten)$", remove = FALSE) %>%
  mutate(
    Time_Eaten = if_else(Suffix == "_eaten", Values, NA_character_),
    Lakes = if_else(Suffix == "_where", Values, NA_character_)
  ) %>%
  # Step 3: Remove unnecessary columns and rows with NA
  select(rowID, Age, Observed_Gender, Catches_Info, Lakes, Time_Eaten) 
#%>%  filter(!is.na(Lakes)) 
  #%>% separate_rows(Lakes, sep = ",")


###

consumers <- consumers %>%
  separate (`Past_catches:_Rainbow_Trout,_times_eaten,_where`,
            into = c("RT_lake1", "RT_lake2", "RT_lake3", "RT_lake4"),
            sep = ",",
            remove = FALSE)


datacheck <- consumers %>% select(c(`Past_catches:_Rainbow_Trout,_times_eaten,_where`, RT_lake1, RT_lake2, RT_lake3, RT_lake4))


consumers <- consumers %>% 
  

###




statewide_adv <- advisories %>% filter(
  Lake == "Statewide")%>%
  select(Lake, Fish, threshold_g_day_child,threshold_g_day_women18_49,threshold_g_day_women50,threshold_g_day_men18)

rt_adv <- statewide_adv %>% filter(
  Fish=="Rainbow trout")
crappie_adv <- statewide_adv %>% filter(
  Fish=="Crappie species")4
sunfish_adv <- statewide_adv %>% filter(
  Fish=="Sunfish species")
blackbass_adv <- statewide_adv %>% filter(
  Fish=="Black bass species")
catfish_adv <- statewide_adv %>% filter(
  Fish=="Catfish species")
carp_adv <- statewide_adv %>% filter(
  Fish=="Common carp")

##Calculate threshold exceedance
#rainbow trout 
consumers <- consumers %>%
  mutate(
    rainbow_trout_threshold = case_when(
      Age < 18 ~ rt_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ rt_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ rt_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ rt_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    rt_exceed_thresh = rainbow_trout_threshold < rainbow_trout_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Rainbow_Trout,_times_eaten,_where`, y=rainbow_trout_g_day))+
  geom_point(aes(color = rt_exceed_thresh))+
  coord_flip()
datacheck <- consumers %>%
  select( c(Age,Observed_Gender,rainbow_trout_threshold, rainbow_trout_g_day ,rt_exceed_thresh))

#catfish 
consumers <- consumers %>%
  mutate(
    catfish_threshold = case_when(
      Age < 18 ~ catfish_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ catfish_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ catfish_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ catfish_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    catfish_exceed_thresh = catfish_threshold < catfish_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Catfish,_times_eaten,_where`, y=catfish_g_day))+
  geom_point(aes(color = catfish_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,catfish_threshold, catfish_g_day ,catfish_exceed_thresh))

#bluegill
consumers <- consumers %>%
  mutate(
    bluegill_threshold = case_when(
      Age < 18 ~ sunfish_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ sunfish_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ sunfish_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ sunfish_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    bluegill_exceed_thresh = bluegill_threshold < bluegill_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Bluegill,_times_eaten,_where`, y=bluegill_g_day))+
  geom_point(aes(color = bluegill_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,bluegill_threshold, bluegill_g_day ,bluegill_exceed_thresh))

#Black bass
consumers <- consumers %>%
  mutate(
    blackbass_threshold = case_when(
      Age < 18 ~ blackbass_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~ blackbass_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~ blackbass_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~ blackbass_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    blackbass_exceed_thresh = blackbass_threshold < bass_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Bass,_times_eaten,_where`, y=bass_g_day))+
  geom_point(aes(color = blackbass_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,blackbass_threshold, bass_g_day ,blackbass_exceed_thresh))

#Carp
consumers <- consumers %>%
  mutate(
    carp_threshold = case_when(
      Age < 18 ~ carp_adv$threshold_g_day_child,
      Observed_Gender == "Female" & Age >= 18 & Age <=49 ~  carp_adv$threshold_g_day_women18_49,
      Observed_Gender == "Female" & Age >50 ~  carp_adv$threshold_g_day_women50,
      Observed_Gender == "Male" & Age > 18 ~  carp_adv$threshold_g_day_men18,
    ))
consumers <- consumers %>%
  mutate(
    carp_exceed_thresh = carp_threshold < carp_g_day
  )

ggplot(consumers, aes(x= `Past_catches:_Common_Carp,_times_eaten,_where`, y=carp_g_day))+
  geom_point(aes(color = carp_exceed_thresh))+
  coord_flip()

datacheck <- consumers %>%
  select( c(Age,Observed_Gender,carp_threshold, carp_g_day ,carp_exceed_thresh))
```

##Age histogram

```{r }
fisherdb <- fisherdb %>%
  mutate(Age= as.numeric(Age))
summary(fisherdb$Age >100)

fisherdb <- fisherdb %>%
  mutate(`Observed_Gender` = case_when(
    `Observed_Gender` %in% c("unknown") ~ "Male",
    TRUE ~ `Observed_Gender`
  ))

ggplot(fisherdb, aes(x = Age, fill = Observed_Gender)) +
  geom_histogram(binwidth = 10, color = "black") +
  labs(
    title = "",
    x = "Age",
    y = "Frequency",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#D47E6A","#248B87","gray"))+
  theme(panel.background =element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "top",)

```

